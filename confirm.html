<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>構件使用確認</title>

<!-- 全域樣式（深色 UI） -->
<style>
body {
    margin: 0;
    padding: 0;
    background: #0f1320;
    color: #eaeef2;
    font-family: system-ui, sans-serif;
}
.top-bar {
    background: #11161f;
    padding: 16px;
    border-radius: 20px;
    margin: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.top-bar-title {
    font-size: 20px;
    font-weight: 700;
}
.top-btn {
    padding: 6px 16px;
    background: #1e2737;
    border-radius: 15px;
    color: white;
}
.screen-card {
    background: #141821;
    margin: 16px;
    padding: 20px;
    border-radius: 20px;
}
.search-input {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    background: #1c2433;
    color: white;
    border: none;
}
.item-card {
    background: #1c2433;
    padding: 16px;
    border-radius: 20px;
    margin-bottom: 14px;
}
.row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.qty-box {
    display: flex;
    gap: 8px;
    align-items: center;
}
.qty-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: #11161f;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
}
.qty-show {
    padding: 6px 18px;
    border-radius: 10px;
    background: #11161f;
    font-size: 16px;
}
.use-btn {
    width: 100%;
    margin-top: 14px;
    padding: 14px;
    background: #2f7dff;
    border-radius: 14px;
    text-align: center;
    font-size: 17px;
    font-weight: 600;
    color: white;
}
.detail-box {
    margin-top: 10px;
    padding: 12px;
    background: #10151f;
    border-radius: 14px;
    font-size: 14px;
    display: none;
}
.toggle-detail {
    cursor: pointer;
    font-size: 13px;
    opacity: 0.7;
    margin-top: 4px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// 初始化 Supabase
const supabase = window.supabase.createClient(
    "https://jho20000202.supabase.co",
    "你的 anon key"
);

document.addEventListener("DOMContentLoaded", async () => {
    loadPlannedItems();
    document.getElementById("search").addEventListener("input", filterList);
});

/* ------------------------- 讀取資料 --------------------------- */
async function loadPlannedItems() {
    const planned = await supabase.from("planned_items").select("*").order("item_id");

    const today = await supabase.from("today_records").select("*");

    const lib = await supabase.from("components_library").select("*");

    render(planned.data, today.data, lib.data);
}

/* ------------------------- 渲染字卡 --------------------------- */
function render(planned, today, lib) {
    const container = document.getElementById("list");
    container.innerHTML = "";

    // 依 item_id + position 合併
    let groups = {};
    for (let p of planned) {
        const key = `${p.item_id}_${p.position}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(p);
    }

    for (let key in groups) {
        let group = groups[key];
        let p = group[0];

        // 今日已使用數量
        let used = today.filter(t => t.item_id === p.item_id && t.position === p.position)
                        .reduce((s, t) => s + (t.qty || 0), 0);

        // 最大可使用量
        let maxUse = p.planned_qty - used;
        if (maxUse <= 0) continue;  // 已使用完 → 不顯示

        // 找構件詳細資料
        let info = lib.find(x => x.item_id === p.item_id);

        container.appendChild(makeCard(p, info, maxUse, used));
    }

    if (!container.innerHTML.trim()) {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">目前無任何預計進料構件</div>`;
    }
}

/* ------------------------- 字卡 DOM --------------------------- */
function makeCard(p, info, maxUse, used) {
    const card = document.createElement("div");
    card.className = "item-card";
    card.dataset.search = `${p.item_id} ${info?.spec} ${p.position}`;

    card.innerHTML = `
        <div class="row">
            <div>
                <div style="font-size:18px;font-weight:700;">${p.item_id}</div>
                <div style="opacity:.7;margin-top:4px;">${p.position}</div>
            </div>
            <div style="opacity:.7;">（剩餘 ${maxUse} ）</div>
        </div>

        <div class="qty-box" style="margin-top:10px;">
            <div class="qty-btn" onclick="decQty(this, ${maxUse})">−</div>
            <div class="qty-show">1</div>
            <div class="qty-btn" onclick="incQty(this, ${maxUse})">+</div>
        </div>

        <div class="toggle-detail" onclick="toggleDetail(this)">點我展開詳細資訊 ▼</div>

        <div class="detail-box">
            <div>規格：${info?.spec || "—"}</div>
            <div>材質：${info?.material || "—"}</div>
            <div>重量：${info?.weight || "—"}</div>
        </div>

        <div class="use-btn" onclick="confirmUse('${p.item_id}','${p.position}', this, ${maxUse})">
            確認使用
        </div>
    `;

    return card;
}

/* --------------------- 數量控制 ------------------------- */
function decQty(btn, max) {
    let box = btn.parentElement.querySelector(".qty-show");
    let v = parseInt(box.innerText);
    if (v > 1) box.innerText = v - 1;
}
function incQty(btn, max) {
    let box = btn.parentElement.querySelector(".qty-show");
    let v = parseInt(box.innerText);
    if (v < max) box.innerText = v + 1;
}

/* --------------------- 展開詳細資訊 ------------------------- */
function toggleDetail(el) {
    const box = el.nextElementSibling;
    box.style.display = box.style.display === "block" ? "none" : "block";
}

/* --------------------- 搜尋功能 ------------------------- */
function filterList() {
    const kw = document.getElementById("search").value.trim().toLowerCase();
    const cards = document.querySelectorAll(".item-card");

    cards.forEach(c => {
        c.style.display = c.dataset.search.toLowerCase().includes(kw) ? "" : "none";
    });
}

/* --------------------- 提交 “使用” ------------------------- */
async function confirmUse(item_id, position, btn, max) {
    const qty = parseInt(btn.parentElement.querySelector(".qty-show").innerText);

    if (qty > max) {
        alert("超出可使用數量");
        return;
    }

    // 新增 today_records
    await supabase.from("today_records").insert({
        item_id,
        position,
        qty,
        status: "used",
        usedat: new Date().toISOString()
    });

    // 若已使用完 → 更新 planned_items.status = done
    const { data: today } = await supabase
        .from("today_records")
        .select("*")
        .eq("item_id", item_id)
        .eq("position", position);

    const used = today.reduce((s, t) => s + (t.qty || 0), 0);

    const { data: planned } = await supabase
        .from("planned_items")
        .select("*")
        .eq("item_id", item_id)
        .eq("position", position);

    if (used >= planned[0].planned_qty) {
        await supabase
            .from("planned_items")
            .update({ status: "done" })
            .eq("item_id", item_id)
            .eq("position", position);
    }

    alert("已記錄使用！");
    location.reload();
}
</script>

</head>
<body>

<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div class="screen-card">
    <input type="text" id="search" class="search-input" placeholder="搜尋：構件編號 / 規格 / 位置">
</div>

<div id="list" style="padding:16px;"></div>

</body>
</html>

