<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>構件使用確認</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
/* 頂部 */
.top-bar {
    background: #11161f;
    padding: 16px;
    border-radius: 20px;
    margin: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.top-bar-title { font-size: 20px; color:#fff; font-weight:700; }
.top-btn { padding:6px 16px; background:#1e2737; color:#fff; border-radius:15px; }

/* 搜尋列 */
.input-bar { width:100%; padding:14px; background:#1c2433; border-radius:14px; color:#fff; }

/* 卡片 */
.item-card {
    background:#1c2433;
    padding:16px;
    margin:12px;
    border-radius:16px;
    color:#fff;
}
.item-header { display:flex; justify-content:space-between; align-items:center; }

/* 一行資訊 */
.row-line {
    display:flex;
    align-items:center;
    gap:12px;
    margin-top:10px;
    flex-wrap:nowrap;
    white-space:nowrap;
}
.item-id { font-size:18px; font-weight:700; }

/* 數量控制 */
.qty-box {
    display:flex;
    align-items:center;
    gap:8px;
}
.qty-btn {
    width:32px; height:32px;
    display:flex; justify-content:center; align-items:center;
    background:#1e2737;
    border-radius:8px;
    font-size:18px;
}
.qty-display {
    min-width:28px;
    text-align:center;
}

/* 小按鈕 */
.use-btn {
    padding:10px 16px;
    background:#2f7dff;
    color:#fff;
    border-radius:10px;
    cursor:pointer;
}

/* 展開面板 */
.detail-panel {
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #2a3142;
    display:none;
    color:#bbb;
}

/* 回到頂端 */
#backTopBtn {
    position: fixed;
    right: 18px;
    bottom: 22px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(6px);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: opacity .3s, transform .25s, bottom .25s;
}
#backTopBtn.visible { opacity:1; pointer-events:auto; }
#backTopBtn svg { width:22px; height:22px; fill:#fff; }
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div class="screen-card">
    <div class="section-title">搜尋</div>
    <input id="searchBox" class="input-bar" placeholder="搜尋：構件編號 / 規格 / 位置">
</div>

<div id="itemList"></div>

<div id="backTopBtn">
    <svg viewBox="0 0 24 24"><path d="M12 4l-8 8h5v8h6v-8h5z"></path></svg>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* Supabase 初始化 */
const db = supabase.createClient(
  "https://udilhhmpdmnrkfgkowqo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8"
);

/* 全域資料 */
let planned = [];
let components = [];
let filtered = [];

/* DOM */
const itemList = document.getElementById("itemList");

/* 載入資料 */
async function loadData() {

    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .eq("status", "received")
        .gt("planned_qty", 0);

    planned = plan || [];

    const { data: comp } = await db
        .from("components_library")
        .select("*");

    components = comp || [];

    renderList(planned);
}

/* 搜尋 */
document.getElementById("searchBox").addEventListener("input", e => {
    const q = e.target.value.trim().toLowerCase();

    if (!q) {
        renderList(planned);
        return;
    }

    const result = planned.filter(p => {
        const comp = components.find(c => c.item_id === p.item_id);
        return (
            p.item_id.toLowerCase().includes(q) ||
            (comp?.spec || "").toLowerCase().includes(q) ||
            (comp?.position || "").toLowerCase().includes(q)
        );
    });

    renderList(result);
});

/* 產生 UI */
function renderList(list) {
    itemList.innerHTML = "";

    list.forEach(p => {

        const comp = components.find(c => c.item_id === p.item_id) || {};
        const cardId = "detail_" + p.id;

        const html = `
            <div class="item-card">

                <div class="item-header" onclick="toggleDetail('${cardId}')">
                    <div class="item-id">${p.item_id}</div>
                    <div style="opacity:.8">${comp.position || ""}</div>
                </div>

                <!-- 一行排版 -->
                <div class="row-line">

                    <div class="qty-box">
                        <div class="qty-btn" onclick="decQty('${p.id}')">−</div>
                        <div id="qty_${p.id}" class="qty-display">1</div>
                        <div class="qty-btn" onclick="incQty('${p.id}', ${p.planned_qty})">＋</div>
                    </div>

                    <div style="font-size:14px; opacity:.7;">( 剩餘 ${p.planned_qty} )</div>

                    <div class="use-btn" onclick="confirmUse('${p.id}')">
                        確認使用
                    </div>
                </div>

                <!-- 展開資訊 -->
                <div id="${cardId}" class="detail-panel">
                    規格：${comp.spec || ""}<br>
                    材質：${comp.material || ""}<br>
                    重量：${comp.weight || ""}<br>
                </div>
            </div>
        `;

        itemList.insertAdjacentHTML("beforeend", html);
    });
}

/* 展開/收合 */
function toggleDetail(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === "block") ? "none" : "block";
}

/* 數量控制 */
function decQty(id) {
    let el = document.getElementById("qty_" + id);
    let v = Number(el.textContent);
    if (v > 1) el.textContent = v - 1;
}

function incQty(id, max) {
    let el = document.getElementById("qty_" + id);
    let v = Number(el.textContent);
    if (v < max) el.textContent = v + 1;
}

/* 確認使用 */
async function confirmUse(id) {

    const qty = Number(document.getElementById("qty_" + id).textContent);

    const item = planned.find(p => p.id == id);
    if (!item) return;

    // 寫入 today_records
    await db.from("today_records").insert({
        item_id: item.item_id,
        qty: qty,
        used_at: new Date().toISOString()
    });

    // 更新 planned_items 剩餘量
    const remain = item.planned_qty - qty;

    await db.from("planned_items")
        .update({
            planned_qty: remain,
            status: remain > 0 ? "received" : "used"
        })
        .eq("id", id);

    alert("已登記使用");

    loadData();
}

/* 回到頂端 */
const backTopBtn = document.getElementById("backTopBtn");
window.addEventListener("scroll", () => {
    if (window.scrollY > 300) backTopBtn.classList.add("visible");
    else backTopBtn.classList.remove("visible");
});
backTopBtn.onclick = () => window.scrollTo({ top:0, behavior:"smooth" });

/* 啟動 */
loadData();
</script>

</body>
</html>
