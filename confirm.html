<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>構件使用確認</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
.screen-card { background:#1c2433; padding:16px; border-radius:14px; color:#fff; margin:12px; }

.item-title { font-size:22px; font-weight:700; margin-bottom:6px; }
.item-sub { font-size:14px; color:#bbb; margin-bottom:10px; }

.qty-box { display:flex; gap:10px; align-items:center; margin:14px 0; }
.qty-btn {
    width:34px; height:34px; border-radius:12px; background:#2f7dff;
    display:flex; justify-content:center; align-items:center; font-size:20px;
}
.qty-num { width:40px; text-align:center; font-size:18px; }

.primary-btn {
    width:100%; background:#2f7dff; padding:12px;
    border-radius:12px; text-align:center; margin-top:18px;
    color:#fff; font-size:16px;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div id="contentArea"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


/* ===== 讀 URL 參數 ===== */
const param = new URL(location.href).searchParams;

const DATA = {
    pid: param.get("pid"),
    item_id: param.get("item_id"),
    position: param.get("position"),
    planned_date: param.get("planned_date"),
    planned_qty: Number(param.get("planned_qty")),
    received_qty: Number(param.get("received_qty")),
    spec: param.get("spec"),
    material: param.get("material"),
    weight: param.get("weight")
};


/* ===== UI 渲染 ===== */
function renderCard() {

    const usable = DATA.received_qty - (DATA.used_qty || 0);

    document.getElementById("contentArea").innerHTML = `
        <div class="screen-card">
            <div class="item-title">${DATA.item_id}</div>

            <div class="item-sub">
                位置：${DATA.position}<br>
                預計：${DATA.planned_qty}　已收：${DATA.received_qty}<br>
                規格：${DATA.spec || "-"}<br>
                材質：${DATA.material || "-"}<br>
                重量：${DATA.weight || "-"}
            </div>

            <div>可使用數量：${usable}</div>

            <div class="qty-box">
                <div id="btnMinus" class="qty-btn">−</div>
                <div id="qtyNum" class="qty-num">1</div>
                <div id="btnPlus" class="qty-btn">+</div>
            </div>

            <div id="confirmBtn" class="primary-btn">確認使用</div>
        </div>
    `;

    const qtyNum = document.getElementById("qtyNum");
    const minus  = document.getElementById("btnMinus");
    const plus   = document.getElementById("btnPlus");

    minus.onclick = ()=>{
        let v = Number(qtyNum.textContent);
        if(v > 1) qtyNum.textContent = v-1;
    };
    plus.onclick = ()=>{
        let v = Number(qtyNum.textContent);
        if(v < usable) qtyNum.textContent = v+1;
    };

    document.getElementById("confirmBtn").onclick = ()=>{
        confirmUse(Number(qtyNum.textContent));
    };
}


/* ===== 寫入使用紀錄 ===== */
async function confirmUse(amount) {

    /* Step 1: 寫入 today_usage */
    await db.from("today_usage").insert({
        planned_id: DATA.pid,
        item_id: DATA.item_id,
        position: DATA.position,
        qty: amount,
        used_at: new Date().toISOString()
    });

    /* Step 2: 更新 planned_items.used_qty */
    await db.from("planned_items")
        .update({
            used_qty: (DATA.used_qty || 0) + amount
        })
        .eq("id", DATA.pid);

    /* Step 3: 跳回構件使用清單 */
    location.href = "confirm.html"; // 若你要跳回使用頁，請改 library.html 或 index.html
}


/* ===== 初始化 ===== */
(async()=>{
    /* 從 DB 抓目前 used_qty */
    const { data } = await db
        .from("planned_items")
        .select("used_qty")
        .eq("id", DATA.pid)
        .single();

    DATA.used_qty = data?.used_qty || 0;

    renderCard();
})();
</script>

</body>
</html>
