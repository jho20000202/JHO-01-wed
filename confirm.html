<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>構件使用確認</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
/* 單欄卡片 */
.use-card {
    background:#1c2433;
    padding:16px;
    margin:12px 0;
    border-radius:14px;
    color:#fff;
}

.use-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:17px;
    font-weight:700;
}

.use-sub {
    margin-top:8px;
    color:#bbb;
    font-size:14px;
}

/* 數量調整 */
.qty-box {
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:10px;
}

.qty-btn {
    width:32px;
    height:32px;
    border-radius:10px;
    font-size:20px;
    background:#2f7dff;
    color:#fff;
    display:flex;
    justify-content:center;
    align-items:center;
}

.qty-num {
    width:30px;
    text-align:center;
    font-size:18px;
    color:#fff;
}

/* 小型使用按鈕 */
.use-btn {
    margin-top:10px;
    background:#27ae60;
    padding:10px 14px;
    color:#fff;
    border-radius:12px;
    font-size:14px;
    width:100px;
    text-align:center;
}

.use-details {
    display:none;
    margin-top:12px;
    border-top:1px solid #2a3142;
    padding-top:10px;
}

.search-bar {
    margin-bottom:14px;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div class="screen-card">
    <div class="section-title">搜尋構件</div>
    <input id="searchBox" class="input-bar search-bar" placeholder="搜尋：編號 / 位置">
</div>

<div class="screen-card">
    <div class="section-title">使用清單</div>
    <div id="useList"></div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* 初始化 Supabase */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* 全域資料 */
let items = [];      // 合併後的構件使用表
let components = []; // components_library 資料

const useList = document.getElementById("useList");

/* 載入資料 */
async function loadData() {
    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .gt("planned_qty", 0);   // 只顯示還有數量可用的

    const { data: comp } = await db
        .from("components_library")
        .select("*");

    components = comp || [];

    // 合併：item_id + position 分組
    const map = {};

    plan.forEach(p => {
        const key = p.item_id + "|" + (p.position || "");
        if (!map[key]) {
            map[key] = {
                item_id: p.item_id,
                position: p.position,
                planned_qty: p.planned_qty,
                details: components.filter(c => c.item_id === p.item_id)[0] || {}
            };
        }
    });

    items = Object.values(map);
    renderList(items);
}

/* 渲染列表 */
function renderList(list) {
    useList.innerHTML = "";

    list.forEach((it, idx) => {
        const id = "details_" + idx;
        const qtyId = "qty_" + idx;

        const card = `
            <div class="use-card">

                <div class="use-header" onclick="toggleDetails('${id}')">
                    <div>${it.item_id}</div>
                    <div>${it.position || "-"}</div>
                </div>

                <div class="qty-box">
                    <div class="qty-btn" onclick="changeQty('${qtyId}', -1, ${it.planned_qty})">-</div>
                    <div id="${qtyId}" class="qty-num">1</div>
                    <div class="qty-btn" onclick="changeQty('${qtyId}', 1, ${it.planned_qty})">+</div>

                    <div class="use-btn" onclick="confirmUse('${it.item_id}','${it.position}', '${qtyId}', ${it.planned_qty})">
                        使用
                    </div>
                </div>

                <div id="${id}" class="use-details">
                    <div class="use-sub">規格：${it.details.spec || "-"}</div>
                    <div class="use-sub">材質：${it.details.material || "-"}</div>
                    <div class="use-sub">重量：${it.details.weight || "-"}</div>
                </div>

            </div>
        `;

        useList.insertAdjacentHTML("beforeend", card);
    });
}

/* 展開/收合 */
function toggleDetails(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === "block" ? "none" : "block";
}

/* 增減數量 */
function changeQty(id, delta, max) {
    const n = document.getElementById(id);
    let v = parseInt(n.textContent);
    v = v + delta;
    if (v < 1) v = 1;
    if (v > max) v = max;
    n.textContent = v;
}

/* 確認使用 → 寫入 today_records + 更新 planned_items */
async function confirmUse(item_id, position, qtyId, max) {
    const qty = parseInt(document.getElementById(qtyId).textContent);

    if (!confirm(`確認使用：${item_id}（${position}） x ${qty}？`)) return;

    const nowIso = new Date().toISOString();

    // today_records
    await db.from("today_records").insert({
        item_id,
        position,
        used_qty: qty,
        used_at: nowIso,
        status: "used"
    });

    // planned_items 減少數量
    const { data: rows } = await db
        .from("planned_items")
        .select("*")
        .eq("item_id", item_id)
        .eq("position", position);

    if (rows.length) {
        const p = rows[0];
        const newQty = p.planned_qty - qty;

        if (newQty <= 0) {
            await db.from("planned_items")
                .update({ planned_qty: 0, status: "used" })
                .eq("id", p.id);
        } else {
            await db.from("planned_items")
                .update({ planned_qty: newQty })
                .eq("id", p.id);
        }
    }

    // UI：移除該卡片
    loadData();
}

/* 搜尋 */
document.getElementById("searchBox").addEventListener("input", e => {
    const q = e.target.value.trim().toLowerCase();
    const filtered = items.filter(it =>
        it.item_id.toLowerCase().includes(q) ||
        (it.position || "").toLowerCase().includes(q)
    );
    renderList(filtered);
});

/* 初始化 */
loadData();
</script>

</body>
</html>
