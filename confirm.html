<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>構件使用確認</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
.card {
    background:#1c2433;
    padding:14px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
}

.card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.qty-box {
    display:flex;
    align-items:center;
    gap:6px;
}

.qty-btn {
    width:32px;
    height:32px;
    border-radius:10px;
    background:#2f7dff;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:20px;
}

.qty-num {
    font-size:16px;
    width:28px;
    text-align:center;
}

.detail {
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #2c3345;
    font-size:14px;
    color:#bbb;
    display:none;
}

.toggle-detail {
    font-size:13px;
    color:#7ba4ff;
    margin-top:6px;
    cursor:pointer;
}

.primary-mini {
    background:#2f7dff;
    padding:10px;
    border-radius:12px;
    width:100%;
    text-align:center;
    margin-top:12px;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div class="screen-card">
    <div class="section-title">搜尋</div>
    <input id="searchBox" class="input-bar" placeholder="搜尋：構件編號 / 規格 / 位置">
</div>

<div class="screen-card">
    <div id="itemList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let rawList = [];
const itemList = document.getElementById("itemList");

/* ============================================================
   Step 1：讀取已收貨但尚未使用完的資料
   status = 'received'
   planned_qty > 0
============================================================ */
async function loadData() {

    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .eq("status", "received")
        .gt("planned_qty", 0);

    if (!plan) return;

    const { data: comp } = await db
        .from("components_library")
        .select("*");

    rawList = plan.map(p => {
        const match = comp.find(c => c.item_id === p.item_id);
        return {
            ...p,
            spec: match?.spec || "",
            material: match?.material || "",
            weight: match?.weight || "",
        };
    });

    render(rawList);
}

/* ============================================================
   Step 2：畫面渲染
============================================================ */
function render(list) {
    itemList.innerHTML = "";

    list.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        card.id = "card_" + p.id;

        const header = document.createElement("div");
        header.className = "card-header";

        const title = document.createElement("div");
        title.textContent = `${p.item_id}（${p.position}）`;

        const remain = document.createElement("div");
        remain.style.color = "#aaa";
        remain.textContent = `剩餘：${p.planned_qty}`;

        header.appendChild(title);
        header.appendChild(remain);
        card.appendChild(header);

        /* 數量調整 */
        const qtyBox = document.createElement("div");
        qtyBox.className = "qty-box";

        const btnMinus = document.createElement("div");
        btnMinus.className = "qty-btn";
        btnMinus.textContent = "−";

        const qtyNum = document.createElement("div");
        qtyNum.className = "qty-num";
        qtyNum.textContent = 1;

        const btnPlus = document.createElement("div");
        btnPlus.className = "qty-btn";
        btnPlus.textContent = "+";

        btnMinus.onclick = () => {
            let v = parseInt(qtyNum.textContent);
            if (v > 1) qtyNum.textContent = v - 1;
        };

        btnPlus.onclick = () => {
            let v = parseInt(qtyNum.textContent);
            if (v < p.planned_qty) qtyNum.textContent = v + 1;
        };

        qtyBox.append(btnMinus, qtyNum, btnPlus);
        card.appendChild(qtyBox);

        /* 展開詳細 */
        const toggle = document.createElement("div");
        toggle.className = "toggle-detail";
        toggle.textContent = "顯示詳細";
        card.appendChild(toggle);

        const detail = document.createElement("div");
        detail.className = "detail";
        detail.innerHTML = `
            規格：${p.spec}<br>
            材質：${p.material}<br>
            重量：${p.weight}
        `;
        card.appendChild(detail);

        toggle.onclick = () => {
            if (detail.style.display === "block") {
                detail.style.display = "none";
                toggle.textContent = "顯示詳細";
            } else {
                detail.style.display = "block";
                toggle.textContent = "隱藏詳細";
            }
        };

        /* 確認使用按鈕 */
        const useBtn = document.createElement("div");
        useBtn.className = "primary-mini";
        useBtn.textContent = "確認使用";
        useBtn.onclick = () => confirmUse(p, parseInt(qtyNum.textContent));
        card.appendChild(useBtn);

        itemList.appendChild(card);
    });
}

/* ============================================================
   Step 3：確認使用
   寫入 today_usage（不是 today_records）
============================================================ */
async function confirmUse(item, amount) {

    // 1) 寫入 today_usage
    await db.from("today_usage").insert({
        planned_id: item.id,
        item_id: item.item_id,
        position: item.position,
        qty: amount,
        used_at: new Date().toISOString(),
        note: null
    });

    // 2) 更新 planned_items 中的剩餘數量
    await db
        .from("planned_items")
        .update({
            planned_qty: item.planned_qty - amount
        })
        .eq("id", item.id);

    // 3) 更新畫面
    if (item.planned_qty - amount <= 0) {
        document.getElementById("card_" + item.id)?.remove();
    }

    await loadData();
}

/* ============================================================
   Step 4：搜尋
============================================================ */
document.getElementById("searchBox").addEventListener("input", (e)=>{
    const q = e.target.value.trim().toLowerCase();

    const filtered = rawList.filter(p =>
        p.item_id.toLowerCase().includes(q) ||
        (p.spec || "").toLowerCase().includes(q) ||
        (p.position || "").toLowerCase().includes(q)
    );

    render(filtered);
});

loadData();
</script>
</body>
</html>
