<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>構件使用確認</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
body { background:#0f1320; color:#fff; }

.top-bar {
    background:#11161f;
    padding:16px;
    border-radius:20px;
    margin:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.top-bar-title { font-size:20px; font-weight:700; }
.top-bar-actions { display:flex; gap:10px; }
.top-btn {
    padding:6px 16px;
    background:#1e2737;
    color:#fff;
    border-radius:15px;
    font-size:14px;
}

.screen-card {
    background:#141821;
    margin:16px;
    padding:20px;
    border-radius:20px;
}

/* 字卡 */
.item-card {
    background:#1c2433;
    padding:16px;
    border-radius:16px;
    margin-bottom:16px;
    cursor:pointer;
    transition:background 0.2s;
}
.item-card:hover { background:#222b3b; }

.row-between {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.item-title { font-size:18px; font-weight:700; }

/* 使用數量控制 */
.qty-box {
    display:flex;
    align-items:center;
    gap:6px;
}

.qty-btn {
    width:34px;
    height:34px;
    border-radius:8px;
    background:#1e2737;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:20px;
}

.qty-num {
    background:#1e2737;
    width:50px;
    text-align:center;
    padding:6px 0;
    border-radius:8px;
    font-size:16px;
}

/* 確認使用 */
.use-btn {
    margin-top:12px;
    width:100%;
    padding:14px;
    background:#2f7dff;
    border-radius:14px;
    text-align:center;
    font-weight:700;
    font-size:16px;
}

/* 展開的詳細資訊 */
.details {
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid #2a3142;
    display:none;
}
.detail-row { color:#bbb; margin:4px 0; }

</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">返回主畫面</a>
    </div>
</div>

<div class="screen-card">
    <div id="list"></div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let components = [];
let usedRecords = [];

/* ===============================
   載入資料
================================ */
async function loadData() {

    const { data: comp } = await db.from("components_library").select("*");
    components = comp || [];

    const { data: used } = await db.from("today_records").select("*");
    usedRecords = used || [];

    renderList();
}

/* ===============================
   渲染字卡
================================ */
function renderList() {
    const wrap = document.getElementById("list");
    wrap.innerHTML = "";

    components.forEach(c => {
        const totalQty = Number(c.qty || 1);
        const usedQty = usedRecords
            .filter(r => r.item_id === c.item_id)
            .reduce((s,r) => s + (r.qty || 0), 0);

        const remain = totalQty - usedQty;
        if (remain <= 0) return;

        const cardId = "D_" + c.item_id;

        wrap.insertAdjacentHTML("beforeend", `
            <div class="item-card" onclick="toggleDetails('${cardId}')">

                <!-- 上層：一欄顯示 -->
                <div class="row-between">
                    <div class="item-title">${c.item_id}</div>
                    <div>${c.position}</div>
                </div>

                <!-- 使用數量（不顯示文字，只保留 +/-） -->
                <div class="qty-box" style="margin-top:12px;">
                    <div class="qty-btn" onclick="changeQty(event, '${c.item_id}', -1)">−</div>
                    <div id="qty_${c.item_id}" class="qty-num">1</div>
                    <div class="qty-btn" onclick="changeQty(event, '${c.item_id}', +1)">＋</div>

                    <div style="margin-left:10px; opacity:0.6;">
                        <small>（剩餘 ${remain}）</small>
                    </div>
                </div>

                <!-- 確認使用按鈕 -->
                <div class="use-btn" onclick="confirmUse(event, '${c.item_id}', ${remain})">
                    確認使用
                </div>

                <!-- 隱藏詳細 -->
                <div id="${cardId}" class="details">
                    <div class="detail-row">規格：${c.spec || ""}</div>
                    <div class="detail-row">材質：${c.material || ""}</div>
                    <div class="detail-row">重量：${c.weight || ""}</div>
                </div>

            </div>
        `);
    });
}

/* 展開/收合 */
function toggleDetails(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === "block" ? "none" : "block";
}

/* 使用數量調整 */
function changeQty(e, id, delta) {
    e.stopPropagation();
    const el = document.getElementById("qty_" + id);
    let v = Number(el.textContent);

    v += delta;
    if (v < 1) v = 1;
    el.textContent = v;
}

/* 確認使用 */
async function confirmUse(e, id, remain) {
    e.stopPropagation();

    const qty = Number(document.getElementById("qty_" + id).textContent);

    if (qty > remain) {
        alert("不能超過剩餘數量！");
        return;
    }

    await db.from("today_records").insert({
        item_id: id,
        qty: qty,
        used_at: new Date().toISOString()
    });

    alert("已紀錄使用！");
    await loadData();
}

/* 初始化 */
loadData();
</script>

</body>
</html>
