<!DOCTYPE html>
<html lang="zh-Hant">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ§‹ä»¶ä½¿ç”¨ç¢ºèª</title>
<link rel="stylesheet" href="styles.css">

<style>
/* ===== å­—å¡ ===== */
.item-card {
    background: #1c2433;
    padding: 16px;
    margin: 12px 0;
    border-radius: 14px;
    color: #fff;
    transition: background 0.2s;
}
.item-card:hover {
    background: #222b3b;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.plan-details {
    display: none;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #2a3142;
}

.detail-sub {
    color: #bbb;
    font-size: 14px;
    margin: 6px 0;
}

.section-title {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 8px;
}

/* Loading */
#loadMessage {
    display: none;
    text-align: center;
    color: #aaa;
    padding: 16px;
}
</style>
</head>

<body>

<!-- Top -->
<div class="top-bar">
    <div class="top-bar-title">æ§‹ä»¶ä½¿ç”¨ç¢ºèª</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
    </div>
</div>

<!-- æœå°‹ + æ’åº -->
<div class="screen-card">
    <div class="section-title">æœå°‹</div>
    <input id="searchBox" class="input-bar" placeholder="æœå°‹ï¼šç·¨è™Ÿ / ä½ç½® / è¦æ ¼">

    <div class="section-title">æ’åº</div>
    <select id="sortSelect" class="input-bar">
        <option value="id_asc">æ§‹ä»¶ç·¨è™Ÿï¼ˆA â†’ Zï¼‰</option>
        <option value="id_desc">æ§‹ä»¶ç·¨è™Ÿï¼ˆZ â†’ Aï¼‰</option>
        <option value="pos_asc">ä½ç½®ï¼ˆA â†’ Zï¼‰</option>
        <option value="pos_desc">ä½ç½®ï¼ˆZ â†’ Aï¼‰</option>
    </select>
</div>

<!-- åˆ—è¡¨ -->
<div class="screen-card">
    <div class="section-title">å¾…ç¢ºèªä½¿ç”¨åˆ—è¡¨</div>
    <div id="confirmList"></div>
    <div id="loadMessage">ç„¡è³‡æ–™</div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ==========================================
   ğŸ”§ Supabase åˆå§‹åŒ–
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   å…¨åŸŸè³‡æ–™
========================================== */
let records = [];      // today_recordsï¼ˆå¾…ç¢ºèªä½¿ç”¨ï¼‰
let components = [];   // components_library

let searchKeyword = "";
let currentSort = "id_asc";

const confirmList = document.getElementById("confirmList");
const loadMessage = document.getElementById("loadMessage");

/* ==========================================
   Step 1ï¼šè¼‰å…¥è³‡æ–™
========================================== */
async function loadMetaData() {

    const { data: rec } = await db
        .from("today_records")
        .select("*")
        .eq("status", "received");      // åªæŠ“ã€Œå·²é€²æ–™ï¼Œä½†å°šæœªä½¿ç”¨ã€çš„

    const { data: comp } = await db
        .from("components_library")
        .select("*");

    records = rec || [];
    components = comp || [];
}

/* ==========================================
   Step 2ï¼šæ¸²æŸ“åˆ—è¡¨
========================================== */
function renderList() {

    confirmList.innerHTML = "";

    let list = [...records];

    /* æœå°‹ */
    if (searchKeyword) {
        list = list.filter(r => {
            const comp = components.find(c => c.item_id === r.item_id) || {};
            return (
                r.item_id.toLowerCase().includes(searchKeyword) ||
                (r.position || "").toLowerCase().includes(searchKeyword) ||
                (comp.spec || "").toLowerCase().includes(searchKeyword)
            );
        });
    }

    /* æ’åº */
    if (currentSort === "id_asc") {
        list.sort((a,b)=> a.item_id.localeCompare(b.item_id));
    } else if (currentSort === "id_desc") {
        list.sort((a,b)=> b.item_id.localeCompare(a.item_id));
    } else if (currentSort === "pos_asc") {
        list.sort((a,b)=> (a.position||"").localeCompare(b.position||""));
    } else if (currentSort === "pos_desc") {
        list.sort((a,b)=> (b.position||"").localeCompare(a.position||""));
    }

    if (list.length === 0) {
        loadMessage.style.display = "block";
        return;
    } else {
        loadMessage.style.display = "none";
    }

    list.forEach(r=>{
        const comp = components.find(c => c.item_id === r.item_id) || {};
        const totalQty = comp.qty || 1;
        const cardId = "details_" + r.id;
        const qtyId  = "qty_" + r.id;

        const card = document.createElement("div");
        card.className = "item-card";

        card.innerHTML = `
            <div class="card-header" onclick="toggleDetails('${cardId}')">
                <div style="font-size:17px;font-weight:700;">${r.item_id}</div>
                <div style="font-size:15px;color:#7fc4ff;">${r.position || "â€”"}</div>
            </div>

            <div style="margin-top:12px;display:flex;align-items:center;gap:12px;">
                <span style="color:#bbb;font-size:15px;">ä½¿ç”¨æ•¸é‡</span>

                <button class="btn" onclick="event.stopPropagation(); changeQty('${qtyId}', -1, ${totalQty});">ï¼</button>

                <input id="${qtyId}" type="number" value="1" min="1" max="${totalQty}"
                    oninput="enforceMax('${qtyId}', ${totalQty})"
                    style="width:60px;text-align:center;padding:6px;border-radius:8px;background:#1c2433;color:#fff;border:1px solid #333;">

                <button class="btn" onclick="event.stopPropagation(); changeQty('${qtyId}', 1, ${totalQty});">ï¼‹</button>
            </div>

            <button class="primary-btn full" style="margin-top:12px;"
                onclick="event.stopPropagation(); confirmUsed(${r.id}, '${qtyId}', ${totalQty});">
                ç¢ºèªä½¿ç”¨
            </button>

            <div id="${cardId}" class="plan-details">
                <div class="detail-sub">${comp.spec || ""}</div>
                <div class="detail-sub">æè³ªï¼š${comp.material || ""}</div>
                <div class="detail-sub">é‡é‡ï¼š${comp.weight || ""}</div>
            </div>
        `;

        confirmList.appendChild(card);
    });
}

/* ==========================================
   æ•¸é‡èª¿æ•´
========================================== */
function changeQty(id, delta, maxQty) {
    const el = document.getElementById(id);
    let v = parseInt(el.value || "1", 10);
    v += delta;

    if (v < 1) v = 1;
    if (v > maxQty) v = maxQty;

    el.value = v;
}

function enforceMax(id, maxQty) {
    const el = document.getElementById(id);
    let v = parseInt(el.value || "1", 10);

    if (v < 1) v = 1;
    if (v > maxQty) v = maxQty;

    el.value = v;
}

/* ==========================================
   å±•é–‹ / æ”¶åˆ
========================================== */
function toggleDetails(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === "block") ? "none" : "block";
}

/* ==========================================
   ç¢ºèªä½¿ç”¨
========================================== */
async function confirmUsed(id, qtyId, maxQty) {

    const qty = Number(document.getElementById(qtyId)?.value || 1);

    if (qty < 1 || qty > maxQty) {
        alert(`ä½¿ç”¨æ•¸é‡å¿…é ˆ 1ï½${maxQty}`);
        return;
    }

    if (!confirm(`ç¢ºå®šä½¿ç”¨ï¼Ÿ\nä½¿ç”¨æ•¸é‡ï¼š${qty}`)) return;

    await db.from("used_records").insert({
        record_id: id,
        used_qty: qty,
        used_at: new Date().toISOString()
    });

    alert("å·²ç¢ºèªä½¿ç”¨");

    await loadMetaData();
    renderList();
}

/* ==========================================
   æœå°‹
========================================== */
document.getElementById("searchBox").addEventListener("input", e=>{
    searchKeyword = e.target.value.trim().toLowerCase();
    renderList();
});

/* ==========================================
   æ’åº
========================================== */
document.getElementById("sortSelect").addEventListener("change", e=>{
    currentSort = e.target.value;
    renderList();
});

/* ==========================================
   åˆå§‹åŒ–
========================================== */
(async ()=>{
    await loadMetaData();
    renderList();
})();
</script>

</body>
</html>

