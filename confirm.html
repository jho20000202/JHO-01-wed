<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ§‹ä»¶ä½¿ç”¨ç¢ºèª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>

/* æ•´é«”å­—å¡ */
.card {
    background: #1c2433;
    padding: 14px;
    margin: 12px 0;
    border-radius: 14px;
    color: #fff;
}

/* ä¸€æ¬„æ’ç‰ˆï¼ˆé—œéµï¼‰ */
.card-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: nowrap; /* ä¸å…è¨±æ›è¡Œ */
}

/* ç·¨è™Ÿ */
.item-id {
    font-size: 18px;
    font-weight: 700;
    white-space: nowrap;
}

/* ä½ç½® */
.item-pos {
    color: #bbb;
    white-space: nowrap;
    font-size: 14px;
}

/* æ•¸é‡èª¿æ•´å€ */
.qty-box {
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}

.qty-btn {
    width: 28px;
    height: 28px;
    background: #2a3142;
    border-radius: 6px;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
}

.qty-num {
    width: 32px;
    text-align: center;
}

/* å‰©é¤˜ */
.item-left {
    font-size: 13px;
    color: #999;
    white-space: nowrap;
}

/* æŒ‰éˆ•ï¼ˆæ”¹æˆå°å°ºå¯¸ï¼Œä¸å†æ›è¡Œï¼‰ */
.use-btn {
    padding: 8px 14px;
    background: #2f7dff;
    border-radius: 10px;
    white-space: nowrap;
    cursor: pointer;
    font-size: 14px;
}

.search-box {
    width:100%;
    padding:12px;
    background:#1c2433;
    border-radius:12px;
    color:#fff;
    margin-bottom:12px;
}

</style>

</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">æ§‹ä»¶ä½¿ç”¨ç¢ºèª</div>
    <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
</div>

<div class="screen-card">

    <div class="section-title">æœå°‹</div>
    <input id="searchBox" class="search-box" placeholder="æœå°‹ï¼šæ§‹ä»¶ç·¨è™Ÿ / è¦æ ¼ / ä½ç½®">

</div>

<div class="screen-card">
    <div id="itemList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ============================================
   ğŸ”§ Supabase åˆå§‹åŒ–
============================================ */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ============================================
   å…¨åŸŸè³‡æ–™
============================================ */
let planned = [];        // planned_items
let components = [];     // components_library
let grouped = [];        // åˆä½µå¾Œè³‡æ–™ï¼ˆitem_id + positionï¼‰

/* ============================================
   Step 1ï¼šè¼‰å…¥è³‡æ–™
============================================ */
async function loadData() {

    /* 1. planned_itemsï¼ˆåƒ…é¡¯ç¤ºæœ‰ç™»è¨˜éçš„ï¼‰ */
    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .order("date", { ascending: true });

    planned = plan || [];

    /* 2. components_libraryï¼ˆæŠ“æ˜ç´°ç”¨ï¼‰ */
    const { data: comp } = await db
        .from("components_library")
        .select("*");

    components = comp || [];

    groupData();
    renderList(grouped);
}

/* ============================================
   Step 2ï¼šåˆä½µï¼ˆitem_id + positionï¼‰
============================================ */
function groupData() {

    const map = {};

    planned.forEach(p => {

        const key = `${p.item_id}__${p.position}`;

        if (!map[key]) {
            map[key] = {
                item_id: p.item_id,
                position: p.position,
                total_qty: 1,  // planned æ¯ç­†ç•¶æˆ 1
                left: 1        // å‰©é¤˜
            };
        } else {
            map[key].total_qty++;
            map[key].left++;
        }
    });

    grouped = Object.values(map);
}

/* ============================================
   Step 3ï¼šæ¸²æŸ“å­—å¡ï¼ˆå…¨éƒ¨ä¸€è¡Œï¼‰
============================================ */
function renderList(list) {

    const itemList = document.getElementById("itemList");
    itemList.innerHTML = "";

    list.forEach((item, idx) => {

        const comp = components.find(c =>
            c.item_id === item.item_id && c.position === item.position
        ) || {};

        const html = `
            <div class="card">

                <div class="card-row">

                    <div class="item-id">${item.item_id}</div>

                    <div class="item-pos">${item.position}</div>

                    <div class="qty-box">
                        <div class="qty-btn" onclick="decQty(${idx})">âˆ’</div>
                        <div class="qty-num" id="qty_${idx}">1</div>
                        <div class="qty-btn" onclick="incQty(${idx})">+</div>
                    </div>

                    <div class="item-left">( å‰©é¤˜ ${item.left} )</div>

                    <div class="use-btn" onclick="confirmUse(${idx})">
                        ç¢ºèªä½¿ç”¨
                    </div>

                </div>

            </div>
        `;

        itemList.insertAdjacentHTML("beforeend", html);
    });
}

/* ============================================
   æ•¸é‡æ§åˆ¶ï¼ˆä¸èƒ½è¶…éå‰©é¤˜ï¼‰
============================================ */
function decQty(i) {
    let n = Number(document.getElementById(`qty_${i}`).innerText);
    if (n > 1) n--;
    document.getElementById(`qty_${i}`).innerText = n;
}

function incQty(i) {
    let n = Number(document.getElementById(`qty_${i}`).innerText);
    const left = grouped[i].left;
    if (n < left) n++;
    document.getElementById(`qty_${i}`).innerText = n;
}

/* ============================================
   Step 4ï¼šç¢ºèªä½¿ç”¨ï¼ˆå¯«å…¥ today_recordsï¼‰
============================================ */
async function confirmUse(i) {

    const item = grouped[i];
    const qty = Number(document.getElementById(`qty_${i}`).innerText);

    if (!confirm(`ç¢ºèªä½¿ç”¨ ${item.item_id}ï¼ˆ${item.position}ï¼‰ï¼Ÿ`)) return;

    // å¯«å…¥ today_records
    await db.from("today_records").insert({
        item_id: item.item_id,
        position: item.position,
        qty: qty,
        status: "used",
        usedat: new Date().toISOString()
    });

    // æ›´æ–°å‰©é¤˜é‡
    grouped[i].left -= qty;

    alert("å·²æ›´æ–°ï¼");

    renderList(grouped);
}

/* ============================================
   Step 5ï¼šæœå°‹
============================================ */
document.getElementById("searchBox").addEventListener("input", (e) => {

    const q = e.target.value.trim().toLowerCase();

    if (!q) {
        renderList(grouped);
        return;
    }

    const result = grouped.filter(item => {

        const comp = components.find(c =>
            c.item_id === item.item_id && c.position === item.position
        ) || {};

        return (
            item.item_id.toLowerCase().includes(q) ||
            (comp.spec || "").toLowerCase().includes(q) ||
            (item.position || "").toLowerCase().includes(q)
        );
    });

    renderList(result);
});

/* ============================================
   åˆå§‹åŒ–
============================================ */
loadData();

</script>

</body>
</html>
