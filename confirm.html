<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ§‹ä»¶ä½¿ç”¨ç¢ºèª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
/* ========= æ·±è‰²å¡ç‰‡ ========= */
.item-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
}

.card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.position-tag {
    background:#2f7dff;
    padding:4px 10px;
    border-radius:10px;
    font-size:13px;
    margin-left:8px;
}

.detail-sub {
    color:#bbb;
    font-size:14px;
    margin-top:6px;
}

/* ========= Loading ========= */
#loadingSpinner {
    display:none;
    text-align:center;
    padding:14px;
}
#loadingSpinner svg {
    width:28px;
    height:28px;
    animation: spin 0.9s linear infinite;
}
@keyframes spin {
    from{transform:rotate(0deg);}
    to{transform:rotate(360deg);}
}

#loadMessage {
    color:#aaa;
    text-align:center;
    padding:12px;
    display:none;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">æ§‹ä»¶ä½¿ç”¨ç¢ºèª</div>
    <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
</div>

<div class="screen-card">
    <div class="section-title">æœå°‹</div>
    <input id="searchBox" class="input-bar" placeholder="æœå°‹ï¼šç·¨è™Ÿ / è¦æ ¼ / ä½ç½®">

    <div class="section-title">æ’åº</div>
    <select id="sortSelect" class="input-bar">
        <option value="id_asc">æ§‹ä»¶ç·¨è™Ÿï¼ˆAâ†’Zï¼‰</option>
        <option value="id_desc">æ§‹ä»¶ç·¨è™Ÿï¼ˆZâ†’Aï¼‰</option>
        <option value="pos_asc">ä½ç½®ï¼ˆAâ†’Zï¼‰</option>
        <option value="pos_desc">ä½ç½®ï¼ˆZâ†’Aï¼‰</option>
    </select>
</div>

<div class="screen-card">
    <div class="section-title">ç­‰å¾…ç¢ºèªä½¿ç”¨</div>

    <div id="confirmList"></div>

    <!-- Loading -->
    <div id="loadingSpinner">
        <svg viewBox="0 0 24 24">
            <path fill="#ccc" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>

    <div id="loadMessage">æ²’æœ‰ä»»ä½•å¾…ä½¿ç”¨è¨˜éŒ„</div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ==========================================
   Supabase
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   å…¨åŸŸ
========================================== */
let records = [];      // today_records
let components = [];   // components_library

let currentSort = "id_asc";
let searchKeyword = "";

const confirmList   = document.getElementById("confirmList");
const loadingSpinner = document.getElementById("loadingSpinner");
const loadMessage    = document.getElementById("loadMessage");

/* ==========================================
   Step 1: è¼‰å…¥è³‡æ–™
========================================== */
async function loadData() {

    loadingSpinner.style.display = "block";

    // today_records: status = 'received' â†’ waiting for confirmation
    const { data: rec } = await db
        .from("today_records")
        .select("*")
        .eq("status","received")
        .order("item_id", { ascending:true });

    records = rec || [];

    // components
    const { data: comp } = await db
        .from("components_library")
        .select("*");

    components = comp || [];

    loadingSpinner.style.display = "none";

    renderList();
}

/* ==========================================
   Step 2: æœå°‹ã€æ’åº
========================================== */
document.getElementById("searchBox").addEventListener("input", ()=>{
    searchKeyword = document.getElementById("searchBox").value.trim().toLowerCase();
    renderList();
});

document.getElementById("sortSelect").addEventListener("change", (e)=>{
    currentSort = e.target.value;
    renderList();
});

/* ==========================================
   Step 3: æ¸²æŸ“å¡ç‰‡
========================================== */
function renderList() {

    confirmList.innerHTML = "";

    let list = [...records];

    /* æœå°‹ */
    if (searchKeyword) {
        list = list.filter(r=>{
            const comp = components.find(c=>c.item_id === r.item_id) || {};
            return (
                r.item_id.toLowerCase().includes(searchKeyword) ||
                r.position?.toLowerCase().includes(searchKeyword) ||
                (comp.spec || "").toLowerCase().includes(searchKeyword)
            );
        });
    }

    /* æ’åº */
    if (currentSort === "id_asc") {
        list.sort((a,b)=> a.item_id.localeCompare(b.item_id));
    } else if (currentSort === "id_desc") {
        list.sort((a,b)=> b.item_id.localeCompare(a.item_id));
    } else if (currentSort === "pos_asc") {
        list.sort((a,b)=> (a.position||"").localeCompare(b.position||""));
    } else if (currentSort === "pos_desc") {
        list.sort((a,b)=> (b.position||"").localeCompare(a.position||""));
    }

    if (list.length === 0) {
        loadMessage.style.display = "block";
        return;
    }

    loadMessage.style.display = "none";

    /* åˆ†çµ„ */
    let lastId = null;

    list.forEach(r=>{
        const comp = components.find(c=> c.item_id === r.item_id) || {};

        if (r.item_id !== lastId) {
            const header = document.createElement("div");
            header.className = "section-title";
            header.style.marginTop = "16px";
            header.textContent = r.item_id;
            confirmList.appendChild(header);
            lastId = r.item_id;
        }

        const card = document.createElement("div");
        card.className = "item-card";
        card.id = "card_" + r.id;

        const h = document.createElement("div");
        h.className = "card-header";
        h.innerHTML = `
            <div>
                <span style="font-size:16px;font-weight:700;">${r.position || "ç„¡ä½ç½®"}</span>
            </div>
            <div class="position-tag">å¾…ä½¿ç”¨</div>
        `;

        card.appendChild(h);

        card.innerHTML += `
            <div class="detail-sub">${comp.spec || ""}</div>
            <div class="detail-sub">æè³ªï¼š${comp.material || ""}</div>
            <div class="detail-sub">é‡é‡ï¼š${comp.weight || ""}</div>
        `;

        const btn = document.createElement("button");
        btn.className = "primary-btn full";
        btn.style.marginTop = "12px";
        btn.textContent = "ç¢ºèªä½¿ç”¨";
        btn.onclick = ()=> confirmUsed(r.id);

        card.appendChild(btn);
        confirmList.appendChild(card);
    });
}

/* ==========================================
   Step 4: ç¢ºèªä½¿ç”¨
========================================== */
async function confirmUsed(id) {

    if (!confirm("ç¢ºå®šæ­¤æ§‹ä»¶å·²æ–¼ç¾å ´ä½¿ç”¨ï¼Ÿ")) return;

    const nowIso = new Date().toISOString();

    const { error } = await db
        .from("today_records")
        .update({
            status: "used",
            used_at: nowIso
        })
        .eq("id", id);

    if (error) {
        console.error(error);
        alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);
        return;
    }

    // ç«‹å³æ›´æ–°ç•«é¢
    const el = document.getElementById("card_" + id);
    if (el) el.remove();

    // å¾ records ç§»é™¤
    records = records.filter(x=> x.id !== id);

    renderList();
}

/* ==========================================
   ğŸš€ Init
========================================== */
loadData();
</script>

</body>
</html>
