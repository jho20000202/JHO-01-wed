<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>構件使用確認</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
body {
    background:#0f1320;
    color:#fff;
    margin:0;
    font-family:system-ui;
}

/* 頂部 */
.top-bar {
    background:#11161f;
    padding:16px;
    border-radius:20px;
    margin:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.top-bar-title { font-size:20px; font-weight:700; }
.top-btn {
    padding:6px 16px;
    background:#1e2737;
    color:#fff;
    border-radius:15px;
    font-size:14px;
}

/* 搜尋 */
.screen-card {
    background:#141821;
    margin:16px;
    padding:20px;
    border-radius:20px;
}

.section-title { font-size:18px; font-weight:700; margin-bottom:12px; }

/* 字卡 */
.card {
    background:#1c2433;
    padding:16px;
    margin:12px 0;
    border-radius:16px;
    cursor:pointer;
}

.row-line {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
}

/* 數量按鈕 */
.qty-box {
    display:flex;
    align-items:center;
    gap:8px;
}

.qty-btn {
    width:32px;
    height:32px;
    border-radius:8px;
    background:#1e2737;
    color:#fff;
    font-size:20px;
    display:flex;
    justify-content:center;
    align-items:center;
}

.qty-num {
    width:40px;
    text-align:center;
    font-size:18px;
}

/* 詳細區 */
.detail {
    display:none;
    border-top:1px solid #2a3142;
    margin-top:12px;
    padding-top:12px;
    color:#bbb;
    font-size:15px;
}

.use-btn {
    margin-top:14px;
    width:100%;
    padding:14px;
    border-radius:14px;
    text-align:center;
    background:#2f7dff;
    color:#fff;
}
</style>
</head>

<body>

<!-- 頂部 -->
<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<!-- 搜尋 -->
<div class="screen-card">
    <div class="section-title">搜尋</div>
    <input id="searchBox" class="input-bar" placeholder="搜尋：構件編號 / 規格 / 位置">
</div>

<div class="screen-card">
    <div id="list"></div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* -------------------------
   載入資料來源：
   只顯示在 planned_items 中
   status = 'received'
   且 qty_remaining > 0 的構件
-------------------------- */
let components = [];
let planned = [];
let merged = [];

async function loadData() {

    // 1. planned_items (僅顯示已收貨)
    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .eq("status", "received");

    planned = plan || [];

    // 2. components_library
    const { data: comp } = await db
        .from("components_library")
        .select("*");

    components = comp || [];

    mergeData();
    renderList(merged);
}

/* ----------------------------------
   合併：item_id + position 相同才合併
----------------------------------- */
function mergeData() {

    const temp = {};

    planned.forEach(p => {
        const key = p.item_id + "|" + p.position;

        if (!temp[key]) {
            temp[key] = {
                item_id: p.item_id,
                position: p.position,
                total_left: p.planned_qty || 1,
                date: p.date
            };
        } else {
            temp[key].total_left += (p.planned_qty || 1);
        }
    });

    merged = Object.values(temp);
}

/* ----------------------------------
   取得詳細資訊
----------------------------------- */
function findComponent(item_id, position) {
    return components.find(c => c.item_id === item_id && c.position === position) || {};
}

/* ----------------------------------
   渲染卡片
----------------------------------- */
function renderList(arr) {
    const list = document.getElementById("list");
    list.innerHTML = "";

    arr.forEach(item => {

        const comp = findComponent(item.item_id, item.position);

        const id = item.item_id + "_" + item.position.replace(/[^A-Za-z0-9]/g, "");

        const html = `
        <div class="card" onclick="toggleDetail('${id}')">

            <div class="row-line">
                <div style="font-size:18px; font-weight:600;">${item.item_id}</div>
                <div>${item.position}</div>
            </div>

            <!-- 數量列 -->
            <div class="row-line" onclick="event.stopPropagation();">
                <div class="qty-box">
                    <div class="qty-btn" onclick="changeQty('${id}', -1)">-</div>
                    <div class="qty-num" id="qty_${id}">1</div>
                    <div class="qty-btn" onclick="changeQty('${id}', 1)">+</div>
                </div>

                <div style="color:#aaa;">（剩餘 ${item.total_left}）</div>
            </div>

            <div class="detail" id="detail_${id}">
                規格：${comp.spec || ""}<br>
                材質：${comp.material || ""}<br>
                重量：${comp.weight || ""}
            </div>

            <div class="use-btn" onclick="event.stopPropagation(); confirmUse('${item.item_id}','${item.position}', ${item.total_left}, '${id}')">
                確認使用
            </div>
        </div>`;

        list.insertAdjacentHTML("beforeend", html);
    });
}

/* ----------------------------------
   展開折疊
----------------------------------- */
function toggleDetail(id) {
    const el = document.getElementById("detail_" + id);
    el.style.display = el.style.display === "block" ? "none" : "block";
}

/* ----------------------------------
   使用數量控制
----------------------------------- */
function changeQty(id, delta) {
    const numEl = document.getElementById("qty_" + id);
    let v = parseInt(numEl.innerText);
    v = Math.max(1, v + delta);
    numEl.innerText = v;
}

/* ----------------------------------
   確認使用
----------------------------------- */
async function confirmUse(item_id, position, left, id) {

    const qty = parseInt(document.getElementById("qty_" + id).innerText);
    if (qty > left) return alert("超過剩餘數量");

    // 1. 寫入 today_records
    await db.from("today_records").insert({
        item_id,
        position,
        qty,
        usedat: new Date().toISOString()
    });

    // 2. 扣除 planned_items.planned_qty
    const { data: rows } = await db
        .from("planned_items")
        .select("*")
        .eq("item_id", item_id)
        .eq("position", position)
        .eq("status", "received");

    let remain = qty;

    for (let r of rows) {
        if (remain <= 0) break;

        const take = Math.min(r.planned_qty, remain);
        const newLeft = r.planned_qty - take;
        remain -= take;

        await db.from("planned_items")
            .update({ planned_qty: newLeft })
            .eq("id", r.id);

        if (newLeft === 0) {
            await db.from("planned_items")
                .update({ status: "used" })
                .eq("id", r.id);
        }
    }

    alert("已確認使用");
    loadData();
}

/* ----------------------------------
   搜尋
----------------------------------- */
document.getElementById("searchBox").addEventListener("input", e => {
    const q = e.target.value.toLowerCase();
    if (!q) return renderList(merged);

    const filtered = merged.filter(m => {
        const comp = findComponent(m.item_id, m.position);
        return (
            m.item_id.toLowerCase().includes(q) ||
            m.position.toLowerCase().includes(q) ||
            (comp.spec || "").toLowerCase().includes(q)
        );
    });

    renderList(filtered);
});

loadData();
</script>

</body>
</html>
