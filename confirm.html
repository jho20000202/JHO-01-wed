<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>構件使用確認</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
body { background:#111722; color:#fff; margin:0; }

.screen-card {
    background:#151d2b;
    padding:18px;
    margin:14px;
    border-radius:14px;
}

/* 搜尋框 */
.input-bar {
    width:100%;
    padding:14px;
    background:#1c2433;
    border-radius:10px;
    border:1px solid #2c3344;
    color:#fff;
    margin-top:8px;
}

/* 字卡 */
.card {
    background:#1c2433;
    padding:16px;
    border-radius:14px;
    margin-top:14px;
}

/* 橫向排列 */
.flex-row {
    display:flex;
    align-items:center;
    justify-content:space-between;
}

/* 數量調整 */
.qty-box {
    display:flex;
    align-items:center;
    gap:6px;
}

.qty-btn {
    width:36px;
    height:36px;
    font-size:20px;
    border-radius:8px;
    background:#0f1724;
    border:1px solid #2d3442;
    color:white;
}

.qty-num {
    width:46px;
    height:36px;
    background:#0f1724;
    border-radius:8px;
    border:1px solid #2d3442;
    display:flex;
    justify-content:center;
    align-items:center;
}

/* 使用按鈕 */
.use-btn {
    width:100%;
    background:#2d82ff;
    padding:16px;
    border-radius:12px;
    text-align:center;
    margin-top:14px;
    font-size:18px;
    font-weight:700;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">構件使用確認</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">返回主畫面</a>
    </div>
</div>

<div class="screen-card">

    <div class="section-title">搜尋</div>
    <input id="searchBox" class="input-bar" placeholder="搜尋：構件編號 / 規格 / 位置">

</div>

<div class="screen-card" id="cardContainer"></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allPlanned = [];
let grouped = {};
let searchKeyword = "";

async function loadData() {
    const { data, error } = await db
        .from("planned_items")
        .select("item_id, position, planned_qty, status")
        .eq("status", "pending");    // ❗只顯示未使用的構件

    if (error) { console.log(error); return; }
    allPlanned = data;

    groupItems();
    render();
}

function groupItems() {
    grouped = {};

    allPlanned.forEach(p => {
        const key = `${p.item_id}__${p.position}`;
        if (!grouped[key]) {
            grouped[key] = {
                item_id: p.item_id,
                position: p.position,
                qty: p.planned_qty,
                used: 1
            };
        } else {
            grouped[key].qty += p.planned_qty;
        }
    });
}

function render() {
    const container = document.getElementById("cardContainer");
    container.innerHTML = "";

    let list = Object.values(grouped);

    if (searchKeyword) {
        const q = searchKeyword.toLowerCase();
        list = list.filter(x =>
            x.item_id.toLowerCase().includes(q) ||
            x.position.toLowerCase().includes(q)
        );
    }

    if (!list.length) {
        container.innerHTML =
            `<div style="text-align:center;color:#aaa;padding:20px;">目前無任何預計進料構件</div>`;
        return;
    }

    list.forEach((c, index) => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
            <div class="flex-row">
                <div style="font-size:20px;font-weight:700">${c.item_id}</div>
                <div>${c.position}</div>
            </div>

            <div class="flex-row" style="margin-top:12px;">
                <div class="qty-box">
                    <button class="qty-btn" onclick="dec(${index})">-</button>
                    <div class="qty-num" id="num_${index}">${c.used}</div>
                    <button class="qty-btn" onclick="inc(${index})">+</button>
                </div>
                <div style="color:#aaa">( 剩餘 ${c.qty - c.used} )</div>
            </div>

            <div class="use-btn" onclick="confirmUse(${index})">
                確認使用
            </div>
        `;

        container.appendChild(card);
    });
}

function inc(i) {
    const item = Object.values(grouped)[i];
    if (item.used < item.qty) {
        item.used++;
        document.getElementById(`num_${i}`).innerText = item.used;
    }
}

function dec(i) {
    const item = Object.values(grouped)[i];
    if (item.used > 1) {
        item.used--;
        document.getElementById(`num_${i}`).innerText = item.used;
    }
}

async function confirmUse(i) {
    const item = Object.values(grouped)[i];

    if (!confirm(`確認使用 ${item.item_id}（位置：${item.position}）\n使用數量：${item.used}`))
        return;

    await db.from("planned_items")
        .update({ status: "used" })
        .eq("item_id", item.item_id)
        .eq("position", item.position)
        .limit(item.used);

    alert("已確認使用");
    loadData();
}

document.getElementById("searchBox").addEventListener("input", (e) => {
    searchKeyword = e.target.value.trim();
    render();
});

loadData();
</script>

</body>
</html>
