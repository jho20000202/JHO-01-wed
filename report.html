<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報表匯出</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .report-card {
            background: #1c2433;
            padding: 24px;
            border-radius: 18px;
            margin-bottom: 20px;
        }

        .report-desc {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.6;
        }

        .preview-container {
            margin-top: 20px;
            background: #141821;
            border-radius: 12px;
            padding: 16px;
            overflow-x: auto;
            display: none;
            /* Initially hidden */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #ddd;
            font-size: 14px;
            white-space: nowrap;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #2a3142;
            text-align: left;
        }

        th {
            background: #242d3f;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="top-bar">
        <div class="top-bar-title">報表匯出</div>
        <div class="top-bar-actions">
            <a href="index.html" class="top-btn">返回主畫面</a>
        </div>
    </div>

    <div class="screen-card">
        <div class="section-title">匯出選項</div>
        <div class="report-desc">
            此功能將彙整構件庫、預定進料與每日記錄，產生完整的構件狀態報表。<br>
            包含：構件編號、規格、位置、重量、目前狀態、進料時間、使用時間等資訊。
        </div>

        <!-- Report Type Selection -->
        <div class="section-title" style="font-size:16px; margin-top:20px;">報表類型</div>
        <select id="reportType" class="input-bar" style="margin-bottom:20px;">
            <option value="all">所有構件資訊</option>
            <option value="today_received">本日進料</option>
            <option value="today_used">本日吊裝</option>
            <option value="progress">進度表</option>
        </select>

        <div class="row-btns">
            <button id="previewBtn" class="ghost-btn">預覽報表</button>
            <button id="exportBtn" class="primary-btn" style="flex:2">匯出 Excel 報表</button>
        </div>

        <div id="previewContainer" class="preview-container">
            <div class="section-title" style="font-size:16px; margin-bottom:10px;">報表預覽 (前 50 筆)</div>
            <div id="tableWrapper"></div>
        </div>
    </div>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="back.js"></script>

    <script>
        const db = window.supabaseClient;

        async function fetchAllData() {
            // Fetch all necessary data
            const [libRes, planRes, todayRes] = await Promise.all([
                db.from('components_library').select('*'),
                db.from('planned_items').select('*'),
                db.from('today_records').select('*')
            ]);

            if (libRes.error) throw libRes.error;
            if (planRes.error) throw planRes.error;
            if (todayRes.error) throw todayRes.error;

            return {
                library: libRes.data,
                planned: planRes.data,
                today: todayRes.data
            };
        }

        async function generateReportData() {
            try {
                const reportType = document.getElementById('reportType').value;
                const { library, planned, today } = await fetchAllData();

                let rows = [];
                const todayDate = new Date().toISOString().split('T')[0];

                switch (reportType) {
                    case 'today_received':
                        // 本日進料：today_records where status='received' and created today
                        const receivedToday = today.filter(r => {
                            const recordDate = r.created_at ? r.created_at.split('T')[0] : '';
                            return r.status === 'received' && recordDate === todayDate;
                        });

                        rows = receivedToday.map(r => {
                            const libItem = library.find(l => l.item_id === r.item_id && l.position === r.position);
                            return {
                                '構件編號': r.item_id || '',
                                '構件規格': libItem?.spec || '',
                                '構件位置': r.position || '',
                                '構件重量': libItem?.weight || '',
                                '進料數量': r.qty || 0,
                                '進料時間': r.created_at || ''
                            };
                        });
                        break;

                    case 'today_used':
                        // 本日吊裝：today_records where status='used' and used today
                        const usedToday = today.filter(r => {
                            const usedDate = r.used_at ? r.used_at.split('T')[0] : '';
                            return r.status === 'used' && usedDate === todayDate;
                        });

                        rows = usedToday.map(r => {
                            const libItem = library.find(l => l.item_id === r.item_id && l.position === r.position);
                            return {
                                '構件編號': r.item_id || '',
                                '構件規格': libItem?.spec || '',
                                '構件位置': r.position || '',
                                '構件重量': libItem?.weight || '',
                                '吊裝數量': r.qty || 0,
                                '吊裝時間': r.used_at || ''
                            };
                        });
                        break;

                    case 'progress':
                        // 進度表：彙總每個構件的進料/使用進度
                        rows = library.map(item => {
                            const key = item.item_id + '|' + item.position;
                            const totalQty = item.qty || 0;

                            // 計算已進料數量
                            const plannedItem = planned.find(p => p.item_id === item.item_id && p.position === item.position);
                            const receivedQty = plannedItem?.received_qty || 0;

                            // 計算已使用數量
                            const usedRecords = today.filter(t => t.item_id === item.item_id && t.position === item.position && t.status === 'used');
                            const usedQty = usedRecords.reduce((sum, r) => sum + (r.qty || 0), 0);

                            const receivedPct = totalQty > 0 ? Math.round((receivedQty / totalQty) * 100) : 0;
                            const usedPct = totalQty > 0 ? Math.round((usedQty / totalQty) * 100) : 0;

                            return {
                                '構件編號': item.item_id || '',
                                '構件規格': item.spec || '',
                                '構件位置': item.position || '',
                                '總數量': totalQty,
                                '已進料數量': receivedQty,
                                '進料進度': `${receivedPct}%`,
                                '已使用數量': usedQty,
                                '使用進度': `${usedPct}%`
                            };
                        });
                        break;

                    case 'all':
                    default:
                        // 所有構件資訊：使用原本的 buildSummaryRows
                        rows = window.buildSummaryRows(library, planned, today);
                        break;
                }

                return rows;
            } catch (error) {
                console.error("Error generating report:", error);
                alert("產生報表失敗：" + error.message);
                return [];
            }
        }

        function renderPreviewTable(rows) {
            const tableWrapper = document.getElementById('tableWrapper');
            if (!rows || rows.length === 0) {
                tableWrapper.innerHTML = '<div style="color:#aaa; padding:10px;">無資料</div>';
                return;
            }

            const headers = Object.keys(rows[0]);
            let html = '<table><thead><tr>';

            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });

            html += '</tr></thead><tbody>';

            rows.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                    html += `<td>${row[h]}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            tableWrapper.innerHTML = html;
        }

        // Wait for DOM to be ready before attaching event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const previewBtn = document.getElementById('previewBtn');
            const exportBtn = document.getElementById('exportBtn');
            const previewContainer = document.getElementById('previewContainer');

            // Preview Handler
            previewBtn.addEventListener('click', async () => {
                console.log("Preview button clicked");
                previewBtn.textContent = "載入中...";
                previewBtn.disabled = true;

                const rows = await generateReportData();
                console.log("Report rows generated:", rows);

                if (rows && rows.length > 0) {
                    console.log("Rendering preview table...");
                    renderPreviewTable(rows.slice(0, 50)); // Show top 50
                    previewContainer.style.display = 'block';
                    console.log("Preview container display set to block");
                } else {
                    console.log("No data to preview");
                    alert("無資料可預覽");
                }

                previewBtn.textContent = "預覽報表";
                previewBtn.disabled = false;
            });

            // Export Handler
            exportBtn.addEventListener('click', async () => {
                exportBtn.textContent = "匯出中...";
                exportBtn.disabled = true;

                const rows = await generateReportData();

                if (rows.length > 0) {
                    const reportType = document.getElementById('reportType').value;
                    let reportName = '構件狀態報表';

                    switch (reportType) {
                        case 'today_received':
                            reportName = '本日進料報表';
                            break;
                        case 'today_used':
                            reportName = '本日吊裝報表';
                            break;
                        case 'progress':
                            reportName = '構件進度表';
                            break;
                        case 'all':
                        default:
                            reportName = '構件狀態報表';
                            break;
                    }

                    const blob = window.buildExcelFromRows(rows, reportName);
                    const filename = `${reportName}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    window.downloadBlob(filename, blob);
                } else {
                    alert("無資料可匯出");
                }

                exportBtn.textContent = "匯出 Excel 報表";
                exportBtn.disabled = false;
            });
        });
    </script>

    <script src="backToTop.js"></script>
</body>

</html>
