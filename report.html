<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報表匯出</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .report-card {
            background: #1c2433;
            padding: 24px;
            border-radius: 18px;
            margin-bottom: 20px;
        }

        .report-desc {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.6;
        }

        .preview-container {
            margin-top: 20px;
            background: #141821;
            border-radius: 12px;
            padding: 16px;
            overflow-x: auto;
            display: none;
            /* Initially hidden */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #ddd;
            font-size: 14px;
            white-space: nowrap;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #2a3142;
            text-align: left;
        }

        th {
            background: #242d3f;
            font-weight: 600;
        }

        /* ===== 小日曆 ===== */
        #calendarOverlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2000;
        }

        #calendarPanel {
            position: absolute;
            background: #1c2433;
            padding: 14px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .7);
            width: 280px;
            color: #fff;
            font-size: 14px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .cal-nav-btn {
            background: #2f7dff;
            border-radius: 999px;
            padding: 4px 10px;
            border: none;
            color: #fff;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .day-name {
            text-align: center;
            color: #9aa0a6;
            font-size: 12px;
        }

        .day-cell {
            text-align: center;
            padding: 7px 0;
            border-radius: 10px;
            background: #141a28;
            cursor: pointer;
        }

        .day-cell:hover {
            background: #2f7dff;
        }

        .day-disabled {
            opacity: .15;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div class="top-bar">
        <div class="top-bar-title">報表匯出</div>
        <div class="top-bar-actions">
            <a href="index.html" class="top-btn">返回主畫面</a>
        </div>
    </div>

    <div class="screen-card">
        <div class="section-title">匯出選項</div>
        <div class="report-desc">
            此功能將彙整構件庫、預定進料與每日記錄，產生完整的構件狀態報表。<br>
            包含：構件編號、規格、位置、重量、目前狀態、進料時間、使用時間等資訊。
        </div>

        <!-- Report Type Selection -->
        <div class="section-title" style="font-size:16px; margin-top:20px;">報表類型</div>
        <select id="reportType" class="input-bar" style="margin-bottom:20px;">
            <option value="all">所有構件資訊</option>
            <option value="today_received">本日進料</option>
            <option value="today_used">本日吊裝</option>
            <option value="progress">進度表</option>
        </select>

        <!-- Date Selection -->
        <div id="dateSelectionContainer" style="display:none;">
            <div class="section-title" style="font-size:16px; margin-top:20px;">選擇日期</div>
            <input type="text" id="reportDate" class="input-bar" placeholder="點擊選擇日期" readonly
                style="margin-bottom:20px; cursor:pointer; background:#1c2433;">
        </div>

        <div class="row-btns">
            <button id="previewBtn" class="ghost-btn">預覽報表</button>
            <button id="exportBtn" class="primary-btn" style="flex:2">匯出 Excel 報表</button>
        </div>

        <div id="previewContainer" class="preview-container">
            <div class="section-title" style="font-size:16px; margin-bottom:10px;">報表預覽 (前 50 筆)</div>
            <div id="tableWrapper"></div>
        </div>
    </div>

    <!-- 小日曆 -->
    <div id="calendarOverlay">
        <div id="calendarPanel">
            <div class="calendar-header">
                <button id="calPrev" class="cal-nav-btn">〈</button>
                <div id="calTitle"></div>
                <button id="calNext" class="cal-nav-btn">〉</button>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
    </div>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="back.js"></script>

    <script>
        const db = window.supabaseClient;

        async function fetchAllData() {
            // Fetch all necessary data
            const [libRes, planRes, todayRes] = await Promise.all([
                db.from('components_library').select('*'),
                db.from('planned_items').select('*'),
                db.from('today_records').select('*')
            ]);

            if (libRes.error) throw libRes.error;
            if (planRes.error) throw planRes.error;
            if (todayRes.error) throw todayRes.error;

            return {
                library: libRes.data,
                planned: planRes.data,
                today: todayRes.data
            };
        }

        async function generateReportData() {
            try {
                const reportType = document.getElementById('reportType').value;
                const { library, planned, today } = await fetchAllData();

                let rows = [];
                // Use selected date or default to today
                const reportDateInput = document.getElementById('reportDate');
                const selectedDate = reportDateInput.value || new Date().toISOString().split('T')[0];
                const todayDate = selectedDate;

                switch (reportType) {
                    case 'today_received':
                        // 本日進料：show all items received on selected date (regardless of current status)
                        const receivedToday = today.filter(r => {
                            const recordDate = r.received_at ? r.received_at.split('T')[0] : (r.created_at ? r.created_at.split('T')[0] : '');
                            // Show items that were received on this date, even if later used
                            return recordDate === todayDate;
                        });

                        rows = receivedToday.map(r => {
                            const libItem = library.find(l => l.item_id === r.item_id && l.position === r.position);
                            return {
                                '構件編號': r.item_id || '',
                                '構件規格': libItem?.spec || '',
                                '構件位置': r.position || '',
                                '構件重量': libItem?.weight || '',
                                '進料數量': r.qty || 0,
                                '進料時間': r.received_at || r.created_at || '',
                                '當前狀態': r.status === 'used' ? '已吊裝' : '已簽收'
                            };
                        });
                        break;

                    case 'today_used':
                        // 本日吊裝：today_records where status='used' and used today
                        const usedToday = today.filter(r => {
                            const usedDate = r.used_at ? r.used_at.split('T')[0] : '';
                            return r.status === 'used' && usedDate === todayDate;
                        });

                        rows = usedToday.map(r => {
                            const libItem = library.find(l => l.item_id === r.item_id && l.position === r.position);
                            return {
                                '構件編號': r.item_id || '',
                                '構件規格': libItem?.spec || '',
                                '構件位置': r.position || '',
                                '構件重量': libItem?.weight || '',
                                '吊裝數量': r.qty || 0,
                                '吊裝時間': r.used_at || ''
                            };
                        });
                        break;

                    case 'progress':
                        // 進度表：彙總每個構件的進料/使用進度
                        rows = library.map(item => {
                            const key = item.item_id + '|' + item.position;
                            const totalQty = item.qty || 0;

                            // 計算已進料數量
                            const plannedItem = planned.find(p => p.item_id === item.item_id && p.position === item.position);
                            const receivedQty = plannedItem?.received_qty || 0;

                            // 計算已使用數量
                            const usedRecords = today.filter(t => t.item_id === item.item_id && t.position === item.position && t.status === 'used');
                            const usedQty = usedRecords.reduce((sum, r) => sum + (r.qty || 0), 0);

                            const receivedPct = totalQty > 0 ? Math.round((receivedQty / totalQty) * 100) : 0;
                            const usedPct = totalQty > 0 ? Math.round((usedQty / totalQty) * 100) : 0;

                            return {
                                '構件編號': item.item_id || '',
                                '構件規格': item.spec || '',
                                '構件位置': item.position || '',
                                '總數量': totalQty,
                                '已進料數量': receivedQty,
                                '進料進度': `${receivedPct}%`,
                                '已使用數量': usedQty,
                                '使用進度': `${usedPct}%`
                            };
                        });
                        break;

                    case 'all':
                    default:
                        // 所有構件資訊：使用原本的 buildSummaryRows
                        rows = window.buildSummaryRows(library, planned, today);
                        break;
                }

                return rows;
            } catch (error) {
                console.error("Error generating report:", error);
                alert("產生報表失敗：" + error.message);
                return [];
            }
        }

        function renderPreviewTable(rows) {
            const tableWrapper = document.getElementById('tableWrapper');
            if (!rows || rows.length === 0) {
                tableWrapper.innerHTML = '<div style="color:#aaa; padding:10px;">無資料</div>';
                return;
            }

            const headers = Object.keys(rows[0]);
            let html = '<table><thead><tr>';

            headers.forEach(h => {
                html += `<th>${h}</th>`;
            });

            html += '</tr></thead><tbody>';

            rows.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                    html += `<td>${row[h]}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            tableWrapper.innerHTML = html;
        }

        // Wait for DOM to be ready before attaching event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const previewBtn = document.getElementById('previewBtn');
            const exportBtn = document.getElementById('exportBtn');
            const previewContainer = document.getElementById('previewContainer');
            const reportTypeSelect = document.getElementById('reportType');
            const dateSelectionContainer = document.getElementById('dateSelectionContainer');
            const reportDateInput = document.getElementById('reportDate');
            const calOverlay = document.getElementById('calendarOverlay');
            const calPanel = document.getElementById('calendarPanel');
            const calGrid = document.getElementById('calendarGrid');
            const calTitle = document.getElementById('calTitle');
            const calPrev = document.getElementById('calPrev');
            const calNext = document.getElementById('calNext');

            let calCurrent = new Date();
            calCurrent.setDate(1);

            // Set default date to today
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            reportDateInput.value = todayStr;

            // Calendar functions
            function renderCalendar() {
                calGrid.innerHTML = '';
                const y = calCurrent.getFullYear();
                const m = calCurrent.getMonth();
                calTitle.textContent = `${y} / ${String(m + 1).padStart(2, '0')}`;
                const first = new Date(y, m, 1);
                const last = new Date(y, m + 1, 0);

                const weekday = first.getDay();
                const days = last.getDate();

                ['日', '一', '二', '三', '四', '五', '六'].forEach(n => {
                    const d = document.createElement('div');
                    d.className = 'day-name';
                    d.textContent = n;
                    calGrid.appendChild(d);
                });

                for (let i = 0; i < weekday; i++) {
                    const blank = document.createElement('div');
                    blank.className = 'day-cell day-disabled';
                    calGrid.appendChild(blank);
                }

                for (let d = 1; d <= days; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.textContent = d;
                    cell.onclick = () => {
                        const mm = String(m + 1).padStart(2, '0');
                        const dd = String(d).padStart(2, '0');
                        reportDateInput.value = `${y}-${mm}-${dd}`;
                        calOverlay.style.display = 'none';
                    };
                    calGrid.appendChild(cell);
                }
            }

            // Calendar event listeners
            reportDateInput.addEventListener('click', () => {
                const rect = reportDateInput.getBoundingClientRect();
                calOverlay.style.display = 'block';
                calPanel.style.top = rect.bottom + 8 + 'px';
                calPanel.style.left = rect.left + 'px';
                renderCalendar();
            });

            calOverlay.addEventListener('click', e => {
                if (e.target === calOverlay) calOverlay.style.display = 'none';
            });

            calPrev.onclick = () => {
                calCurrent.setMonth(calCurrent.getMonth() - 1);
                renderCalendar();
            };

            calNext.onclick = () => {
                calCurrent.setMonth(calCurrent.getMonth() + 1);
                renderCalendar();
            };

            // Show/hide date selection based on report type
            reportTypeSelect.addEventListener('change', () => {
                const reportType = reportTypeSelect.value;
                if (reportType === 'today_received' || reportType === 'today_used') {
                    dateSelectionContainer.style.display = 'block';
                } else {
                    dateSelectionContainer.style.display = 'none';
                }
            });

            // Preview Handler
            previewBtn.addEventListener('click', async () => {
                console.log("Preview button clicked");
                previewBtn.textContent = "載入中...";
                previewBtn.disabled = true;

                const rows = await generateReportData();
                console.log("Report rows generated:", rows);

                if (rows && rows.length > 0) {
                    console.log("Rendering preview table...");
                    renderPreviewTable(rows.slice(0, 50)); // Show top 50
                    previewContainer.style.display = 'block';
                    console.log("Preview container display set to block");
                } else {
                    console.log("No data to preview");
                    alert("無資料可預覽");
                }

                previewBtn.textContent = "預覽報表";
                previewBtn.disabled = false;
            });

            // Export Handler
            exportBtn.addEventListener('click', async () => {
                exportBtn.textContent = "匯出中...";
                exportBtn.disabled = true;

                const rows = await generateReportData();

                if (rows.length > 0) {
                    const reportType = document.getElementById('reportType').value;
                    const selectedDate = document.getElementById('reportDate').value || new Date().toISOString().split('T')[0];
                    let reportName = '構件狀態報表';

                    switch (reportType) {
                        case 'today_received':
                            reportName = '本日進料報表';
                            break;
                        case 'today_used':
                            reportName = '本日吊裝報表';
                            break;
                        case 'progress':
                            reportName = '構件進度表';
                            break;
                        case 'all':
                        default:
                            reportName = '構件狀態報表';
                            break;
                    }

                    const blob = window.buildExcelFromRows(rows, reportName);
                    const filename = `${reportName}_${selectedDate}.xlsx`;
                    window.downloadBlob(filename, blob);
                } else {
                    alert("無資料可匯出");
                }

                exportBtn.textContent = "匯出 Excel 報表";
                exportBtn.disabled = false;
            });
        });
    </script>

    <script src="backToTop.js"></script>
</body>

</html>
