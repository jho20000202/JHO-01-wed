<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>報表匯出</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body>
    <div class="section">
      <div class="card">
        <div class="row" style="flex-wrap:wrap;">
          <div class="app-title">報表匯出</div>
          <a class="btn" href="index.html">返回主畫面</a>
        </div>
        <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn primary" id="excel">匯出 Excel</button>
          <button class="btn" id="exportDevice">匯出到手機</button>
          <button class="btn" id="previewXLSX">預覽 Excel</button>
          <button class="btn" id="csv">匯出 CSV</button>
          <button class="btn" id="exportGoogle">匯出到 Google</button>
          <button class="btn" id="downloads">最近匯出</button>
        </div>
        <div class="muted" style="margin-top:8px;">匯出資料範圍：構件庫＋登記資料（含進/使用/進度）</div>
      </div>
    </div>
    <script src="back.js"></script>
    <script src="vendor/xlsx.full.min.js"></script>
    <script>
      document.getElementById('excel').addEventListener('click', ()=>{
        if (window.__exportExcel) window.__exportExcel();
        else fallback('excel');
      });
      document.getElementById('csv').addEventListener('click', ()=>{
        if (window.__exportCSV) window.__exportCSV();
        else fallback('csv');
      });
      document.getElementById('downloads').addEventListener('click', ()=>{ if(window.showDownloads) window.showDownloads(); });
      document.getElementById('previewXLSX').addEventListener('click', async ()=>{
        try {
          const get=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
          const libs = get('componentsLibrary', []);
          const today = get('todayRecords', []);
          const planned = get('plannedItems', []);
          const used = get('usedRecords', []);
          const key = (x)=> `${String(x.id)}|${String(x.position||'')}`;
          const stat = new Map(); planned.forEach(r=>{ stat.set(key(r), { status:r.status||'scheduled', plannedAt:r.plannedAt||'', actualAt:'' }); }); today.forEach(r=>{ stat.set(key(r), { status:r.status||'', plannedAt:r.plannedAt||'', actualAt:r.actualAt||'' }); });
          const latestUsed = new Map(); used.forEach(u=>{ const k=`${String(u.id)}|${String(u.position||'')}`; const t=String(u.usedAt||''); const prev=latestUsed.get(k)||''; const pd=(used||[]).find(x=>`${String(x.id)}|${String(x.position||'')}`===k && String(x.usedAt)===prev)?.usedAtDate || ''; const nd = u.usedAtDate || ''; if(!prev || (nd && pd && nd>pd)) latestUsed.set(k, t); else latestUsed.set(k, t); });
          const num = (v)=>{ const n=Number(String(v??'').replace(/,/g,'')); return Number.isFinite(n)?n:0; };
          const recKeys = new Set(today.filter(r=>r.status==='received').map(r=> `${String(r.id)}|${String(r.position||'')}`));
          const usedSumByKey = (()=>{ const m=new Map(); (used||[]).forEach(u=>{ const k=`${String(u.id)}|${String(u.position||'')}`; m.set(k,(m.get(k)||0)+num(u.qty ?? u.quantity ?? u.usedQty)); }); return m; })();
          const rows = libs.slice().sort((a,b)=>String(a.id).localeCompare(String(b.id))).map(item=>{ const k = key(item); const s = stat.get(k) || {}; const isDate = /\d{4}-\d{2}-\d{2}/.test(String(s.plannedAt||'')); const recTime = (isDate? String(s.plannedAt) : '') + (s.actualAt? (isDate? ` ${s.actualAt}` : String(s.actualAt)) : ''); const useTime = latestUsed.get(`${String(item.id)}|${String(item.position||'')}`) || ''; const statusLabel = (useTime && String(useTime).trim()!=='') ? '已使用' : (s.status==='received' ? '已進料' : ''); const qty = num(item.quantity); const usedQty = Math.min(usedSumByKey.get(k)||0, qty); const recvPct = qty ? (recKeys.has(k) ? 100 : 0) : 0; const usedPct = qty ? Math.round(usedQty*100/qty) : 0; return ['構件編號', item.id || '', '規格', item.spec || '', '位置', item.position || '', '重量', (item.weight!==undefined? item.weight : ''), '數量', (item.quantity!==undefined? item.quantity : ''), '狀態', statusLabel, '進料時間', recTime, '使用時間', useTime, '進料進度', `${recvPct}%`, '使用進度', `${usedPct}%`]; });
          const ws = XLSX.utils.aoa_to_sheet([['報表'], ...rows]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '報表'); const data = XLSX.write(wb, { bookType:'xlsx', type:'array' }); const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          if (window.showExcelPreview) window.showExcelPreview(blob, 'report.xlsx');
        } catch (e) { alert('預覽失敗：'+(e?.message||e)); }
      });

      document.getElementById('exportGoogle').addEventListener('click', async ()=>{
        try {
          const get=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
          const libs = get('componentsLibrary', []);
          const today = get('todayRecords', []);
          const planned = get('plannedItems', []);
          const used = get('usedRecords', []);
          const key = (x)=> `${String(x.id)}|${String(x.position||'')}`;
          const stat = new Map(); planned.forEach(r=>{ stat.set(key(r), { status:r.status||'scheduled', plannedAt:r.plannedAt||'', actualAt:'' }); }); today.forEach(r=>{ stat.set(key(r), { status:r.status||'', plannedAt:r.plannedAt||'', actualAt:r.actualAt||'' }); });
          const latestUsed = new Map(); used.forEach(u=>{ const k=`${String(u.id)}|${String(u.position||'')}`; const t=String(u.usedAt||''); const prev=latestUsed.get(k)||''; const pd=(used||[]).find(x=>`${String(x.id)}|${String(x.position||'')}`===k && String(x.usedAt)===prev)?.usedAtDate || ''; const nd = u.usedAtDate || ''; if(!prev || (nd && pd && nd>pd)) latestUsed.set(k, t); else latestUsed.set(k, t); });
          const num = (v)=>{ const n=Number(String(v??'').replace(/,/g,'')); return Number.isFinite(n)?n:0; };
          const recKeys = new Set(today.filter(r=>r.status==='received').map(r=> `${String(r.id)}|${String(r.position||'')}`));
          const usedSumByKey = (()=>{ const m=new Map(); (used||[]).forEach(u=>{ const k=`${String(u.id)}|${String(u.position||'')}`; m.set(k,(m.get(k)||0)+num(u.qty ?? u.quantity ?? u.usedQty)); }); return m; })();
          const rows = libs.slice().sort((a,b)=>String(a.id).localeCompare(String(b.id))).map(item=>{ const k = key(item); const s = stat.get(k) || {}; const isDate = /\d{4}-\d{2}-\d{2}/.test(String(s.plannedAt||'')); const recTime = (isDate? String(s.plannedAt) : '') + (s.actualAt? (isDate? ` ${s.actualAt}` : String(s.actualAt)) : ''); const useTime = latestUsed.get(`${String(item.id)}|${String(item.position||'')}`) || ''; const statusLabel = (useTime && String(useTime).trim()!=='') ? '已使用' : (s.status==='received' ? '已進料' : ''); const qty = num(item.quantity); const usedQty = Math.min(usedSumByKey.get(k)||0, qty); const recvPct = qty ? (recKeys.has(k) ? 100 : 0) : 0; const usedPct = qty ? Math.round(usedQty*100/qty) : 0; return ['構件編號', item.id || '', '規格', item.spec || '', '位置', item.position || '', '重量', (item.weight!==undefined? item.weight : ''), '數量', (item.quantity!==undefined? item.quantity : ''), '狀態', statusLabel, '進料時間', recTime, '使用時間', useTime, '進料進度', `${recvPct}%`, '使用進度', `${usedPct}%`]; });
          const ws = XLSX.utils.aoa_to_sheet([['報表'], ...rows]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '報表'); const data = XLSX.write(wb, { bookType:'xlsx', type:'array' }); const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          // 先嘗試 Google 直傳
          if (window.GoogleAuth) {
            try {
              if (!GoogleAuth.isLogged()) { await GoogleAuth.login(); }
              const folderId = (localStorage.getItem('google:folderId')? JSON.parse(localStorage.getItem('google:folderId')):'');
              const meta = await GoogleAuth.uploadFile('report.xlsx', blob, blob.type, folderId);
              const link = meta?.webViewLink || '';
              if (window.showExportToast) window.showExportToast('report.xlsx', link);
              try { if (link) window.open(link, '_blank'); } catch {}
              return;
            } catch {}
          }
          const ok = await (window.saveBlobWithPicker ? window.saveBlobWithPicker(blob, 'report.xlsx') : false);
          if (!ok) alert('裝置不支援原生儲存');
        } catch (e) { alert('匯出至 Google 失敗：'+(e?.message||e)); }
      });
      async function fallback(type){
        const get=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
        const libs = get('componentsLibrary', []);
        const today = get('todayRecords', []);
        const planned = get('plannedItems', []);
        const used = get('usedRecords', []);
        const key = (x)=> `${String(x.id)}|${String(x.position||'')}`;
        const stat = new Map();
        planned.forEach(r=>{ stat.set(key(r), { status:r.status||'scheduled', plannedAt:r.plannedAt||'', actualAt:'' }); });
        today.forEach(r=>{ stat.set(key(r), { status:r.status||'', plannedAt:r.plannedAt||'', actualAt:r.actualAt||'' }); });
        const latestUsed = new Map();
        used.forEach(u=>{
          const k=`${String(u.id)}|${String(u.position||'')}`;
          const t=String(u.usedAt||'');
          const prev=latestUsed.get(k)||'';
          const pd = (used||[]).find(x=>`${String(x.id)}|${String(x.position||'')}`===k && String(x.usedAt)===prev)?.usedAtDate || '';
          const nd = u.usedAtDate || '';
          if(!prev || (nd && pd && nd>pd)) latestUsed.set(k, t); else latestUsed.set(k, t);
        });
        // 工具
        const num = (v)=>{ const n=Number(String(v??'').replace(/,/g,'')); return Number.isFinite(n)?n:0; };
        const recKeys = new Set(today.filter(r=>r.status==='received').map(r=> `${String(r.id)}|${String(r.position||'')}`));
        const usedSumByKey = (()=>{
          const m=new Map();
          (used||[]).forEach(u=>{
            const k=`${String(u.id)}|${String(u.position||'')}`;
            m.set(k,(m.get(k)||0)+num(u.qty ?? u.quantity ?? u.usedQty));
          });
          return m;
        })();
        const rows = libs.slice().sort((a,b)=>String(a.id).localeCompare(String(b.id))).map(item=>{
          const k = key(item);
          const s = stat.get(k) || {};
          // 進料時間：以 plannedAt(日期)+actualAt(時間) 組合；若無日期則僅時間
          const isDate = /\d{4}-\d{2}-\d{2}/.test(String(s.plannedAt||''));
          const recTime = (isDate? String(s.plannedAt) : '') + (s.actualAt? (isDate? ` ${s.actualAt}` : String(s.actualAt)) : '');
          // 使用時間：採用最新的 usedAt（已為日期+時間）
          const useTime = latestUsed.get(`${String(item.id)}|${String(item.position||'')}`) || '';
          const statusLabel = (useTime && String(useTime).trim()!=='')
            ? '已使用'
            : (s.status==='received' ? '已進料' : '');
          // 進度（依該構件數量）
          const qty = num(item.quantity);
          const usedQty = Math.min(usedSumByKey.get(k)||0, qty);
          const recvPct = qty ? (recKeys.has(k) ? 100 : 0) : 0;
          const usedPct = qty ? Math.round(usedQty*100/qty) : 0;
          return {
            '構件編號': item.id || '',
            '構件規格': item.spec || '',
            '構件重量': (item.weight!==undefined? item.weight : ''),
            '構件位置': item.position || '',
            '構件數量': (item.quantity!==undefined? item.quantity : ''),
            '構件目前狀態': statusLabel,
            '構件進料時間': recTime,
            '構件使用時間': useTime,
            '構件進料進度': `${recvPct}%`,
            '構件使用進度': `${usedPct}%`
          };
        });
        if(type==='excel'){
          const ws=XLSX.utils.json_to_sheet(rows);
          const wb=XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, '報表');
          const data = XLSX.write(wb, { bookType:'xlsx', type:'array' });
          const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          const saved = await (window.saveBlobWithPicker ? window.saveBlobWithPicker(blob, 'report.xlsx') : false);
          if (!saved) alert('裝置不支援原生儲存');
        } else {
          const header=['構件編號','構件規格','構件重量','構件位置','構件數量','構件目前狀態','構件進料時間','構件使用時間','構件進料進度','構件使用進度'];
          const csvRows = rows.map(r=> header.map(h=> r[h]??'' ));
          const csv=[header,...csvRows].map(row=>row.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
          const saved = await (window.saveBlobWithPicker ? window.saveBlobWithPicker(blob, 'report.csv') : false);
          if (!saved) alert('裝置不支援原生儲存');
      }
      }
    </script>
  </body>
</html>
