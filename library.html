<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ§‹ä»¶åº«</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<!-- XLSX è§£æå·¥å…· -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* ====== ç‹€æ…‹é» ====== */
.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}

.dot-grey { background:#7f8c8d; }
.dot-yellow { background:#f1c40f; }
.dot-orange { background:#e67e22; }
.dot-green { background:#2ecc71; }

/* ====== æ§‹ä»¶å¡ç‰‡ï¼ˆå¯å±•é–‹ï¼‰ ====== */
.item-card {
    background:#1c2433;
    padding:14px;
    margin:12px 0;
    border-radius:14px;
    color:#fff;
    cursor:pointer;
    transition:0.25s;
    border:1px solid #2a2f3a;
}
.item-card:hover {
    background:#242d40;
}

.item-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.item-id {
    font-size:18px;
    font-weight:700;
}

.item-status-dot {
    width:14px;
    height:14px;
    border-radius:50%;
}

/* ====== éš±è—å€ï¼ˆå±•é–‹å…§å®¹ï¼‰ ====== */
.item-details {
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #2a2f3a;
    display:none;
}
.item-sub { font-size:14px; color:#bbb; margin:4px 0; }
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">æ§‹ä»¶åº«</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
    </div>
</div>

<div class="screen-card">

    <!-- ğŸŸ¦ æ§‹ä»¶ç‹€æ…‹ -->
    <div class="section-title">æ§‹ä»¶ç‹€æ…‹</div>

    <div class="row" style="margin-bottom:12px;">
        <label><input type="radio" name="filterStatus" value="all" checked> å…¨éƒ¨</label>
        <label><span class="status-dot dot-grey"></span>æœªé€²æ–™</label>
        <label><span class="status-dot dot-yellow"></span>é å®šä¸­</label>
        <label><span class="status-dot dot-orange"></span>å·²é€²æ–™</label>
        <label><span class="status-dot dot-green"></span>å·²ä½¿ç”¨</label>
    </div>

    <!-- æœå°‹ -->
    <input id="searchBox" class="input-bar" placeholder="æœå°‹ï¼šç·¨è™Ÿ / è¦æ ¼ / æè³ª / ä½ç½®">

    <!-- ğŸ“¤ åŒ¯å…¥ Excel è‡ªå‹•è§£æ -->
    <div class="section-title">åŒ¯å…¥ Excel / CSV</div>

    <!-- éš±è—æª”æ¡ˆé¸æ“‡å™¨ -->
    <input type="file" id="filePicker" accept=".xlsx,.xls,.csv" style="display:none">

    <!-- é¡¯ç¤ºå¯æŒ‰çš„æŒ‰éˆ• -->
    <div id="importBtn" class="primary-btn full">åŒ¯å…¥ Excel / CSV</div>

    <!-- ğŸ“¥ ä¸‹è¼‰ CSV æ¨¡æ¿ -->
    <div id="downloadCSV" class="ghost-btn full">ä¸‹è¼‰ CSV æ¨¡æ¿</div>

</div>

<!-- æ§‹ä»¶æ¸…å–® -->
<div class="screen-card">
    <div class="section-title">æ§‹ä»¶æ¸…å–®</div>
    <div id="itemList"></div>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ==========================================
   ğŸ“Œ Supabase åˆå§‹åŒ–ï¼ˆç¬¬ 3 æ®µæœƒè£œé½Šï¼‰
========================================== */


/* ==========================================
   ğŸ“Œ ä¾ç‹€æ…‹æ±ºå®šé¡è‰²é»
========================================== */
function statusToDot(status) {
    switch (status) {
        case "grey": return "dot-grey";
        case "yellow": return "dot-yellow";
        case "orange": return "dot-orange";
        case "green": return "dot-green";
        default: return "dot-grey";
    }
}

/* ==========================================
   ğŸ“Œ Step 3ï¼šæ¸²æŸ“æ§‹ä»¶åˆ—è¡¨ï¼ˆå«å±•é–‹è©³ç´°è³‡è¨Šï¼‰
========================================== */
function renderList() {
    const list = document.getElementById("itemList");
    const query = document.getElementById("searchBox").value.trim();

    list.innerHTML = "";

    components.forEach(c => {
        const status = getStatus(c.item_id);

        // ğŸ” æœå°‹éæ¿¾
        if (query && !(
            c.item_id.includes(query) ||
            (c.spec || "").includes(query) ||
            (c.position || "").includes(query)
        )) return;

        // ğŸ”µ ç”¢ç”Ÿå¯å±•é–‹å¡ç‰‡ HTML
        const card = document.createElement("div");
        card.className = "item-card";

        card.innerHTML = `
            <div class="item-header">
                <div class="item-id">${c.item_id}</div>
                <div class="item-status-dot ${statusToDot(status)}"></div>
            </div>

            <div class="item-details">
                <div class="item-sub">è¦æ ¼ï¼š${c.spec || ""}</div>
                <div class="item-sub">æè³ªï¼š${c.material || ""}</div>
                <div class="item-sub">é‡é‡ï¼š${c.weight || ""}</div>
                <div class="item-sub">ä½ç½®ï¼š${c.position || ""}</div>
                <div class="item-sub">æ•¸é‡ï¼š${c.qty || ""}</div>
                <div class="item-sub">
                    ç‹€æ…‹ï¼š${
                        status==="grey" ? "æœªé€²æ–™" :
                        status==="yellow" ? "é å®šä¸­" :
                        status==="orange" ? "å·²é€²æ–™" : "å·²ä½¿ç”¨"
                    }
                </div>
            </div>
        `;

        // ğŸ”½ é»æ“Šå±•é–‹/æ”¶åˆ
        card.addEventListener("click", () => {
            const detail = card.querySelector(".item-details");
            detail.style.display = detail.style.display === "block" ? "none" : "block";
        });

        list.appendChild(card);
    });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ==========================================
   ğŸ”§ Supabase åˆå§‹åŒ–
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   ğŸ“Œ å…¨åŸŸè³‡æ–™
========================================== */
let components = [];  // components_library
let planned = [];     // planned_items
let used = [];        // today_records

/* ==========================================
   ğŸŸ¢ Step 1ï¼šè®€å–æ‰€æœ‰è³‡æ–™
========================================== */
async function loadData() {
    const { data: lib } = await db.from("components_library").select("*");
    const { data: plan } = await db.from("planned_items").select("*");
    const { data: use } = await db.from("today_records").select("*");

    components = lib || [];
    planned = plan || [];
    used = use || [];

    renderList();
}

/* ==========================================
   ğŸ“Œ Step 2ï¼šå››è‰²ç‹€æ…‹é‚è¼¯
========================================== */
function getStatus(item_id) {
    const plan = planned.find(p => p.item_id === item_id);
    const useRec = used.find(u => u.item_id === item_id);

    if (!plan && !useRec) return "grey";           // æœªé€²æ–™
    if (plan && plan.status === "planned") return "yellow"; // é å®šä¸­
    if (plan && plan.status === "received" && !useRec) return "orange"; // å·²é€²æ–™
    if (plan && plan.status === "received" && useRec) return "green";   // å·²ä½¿ç”¨

    return "grey";
}

/* ==========================================
   ğŸ” å³æ™‚æœå°‹
========================================== */
document.getElementById("searchBox").addEventListener("input", renderList);

/* ==========================================
   ğŸ“¤ åŒ¯å…¥ Excel / CSV
========================================== */
document.getElementById("importBtn").addEventListener("click", () => {
    document.getElementById("filePicker").click();
});

document.getElementById("filePicker").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    alert("æ­£åœ¨åŒ¯å…¥è³‡æ–™â€¦");

    const ext = file.name.split(".").pop().toLowerCase();
    const buffer = await file.arrayBuffer();
    let json = [];

    try {
        if (ext === "csv") {
            json = csvToJSON(new TextDecoder("utf-8").decode(new Uint8Array(buffer)));
        } else {
            const wb = XLSX.read(buffer, { type: "array" });
            const ws = wb.Sheets[wb.SheetNames[0]];
            json = XLSX.utils.sheet_to_json(ws);
        }
    } catch (err) {
        console.error(err);
        alert("æª”æ¡ˆè§£æå¤±æ•—");
        return;
    }

    if (!json.length) {
        alert("æª”æ¡ˆç„¡è³‡æ–™");
        return;
    }

    const required = ["æ§‹ä»¶ç·¨è™Ÿ","æ§‹ä»¶è¦æ ¼","æ§‹ä»¶æè³ª","æ§‹ä»¶é‡é‡","æ§‹ä»¶ä½ç½®","æ§‹ä»¶æ•¸é‡"];
    for (let r of required) {
        if (!json[0][r]) return alert("ç¼ºå°‘æ¬„ä½ï¼š" + r);
    }

    const insertData = json.map(r => ({
        item_id: String(r["æ§‹ä»¶ç·¨è™Ÿ"]).trim(),
        spec: r["æ§‹ä»¶è¦æ ¼"] || "",
        material: r["æ§‹ä»¶æè³ª"] || "",
        weight: Number(r["æ§‹ä»¶é‡é‡"]) || 0,
        position: r["æ§‹ä»¶ä½ç½®"] || "",
        qty: Number(r["æ§‹ä»¶æ•¸é‡"]) || 1
    }));

    const { error } = await db.from("components_library").upsert(insertData);

    if (error) {
        console.error(error);
        alert("åŒ¯å…¥å¤±æ•—ï¼š" + error.message);
    } else {
        alert("åŒ¯å…¥å®Œæˆï¼");
        loadData();
    }

    e.target.value = "";
});

/* ==========================================
   ğŸ“¥ CSV æ¨¡æ¿ä¸‹è¼‰ï¼ˆUTF-8ï¼‰
========================================== */
document.getElementById("downloadCSV").addEventListener("click", () => {
    const header = "æ§‹ä»¶ç·¨è™Ÿ,æ§‹ä»¶è¦æ ¼,æ§‹ä»¶æè³ª,æ§‹ä»¶é‡é‡,æ§‹ä»¶ä½ç½®,æ§‹ä»¶æ•¸é‡\n";
    const sample =
        "UV0E3,PL25*500*650,SN490BM,89,32-33/F,1\n" +
        "UV0V1,RH300*300*10*15*5836.8,SN490BM,576,32-33/H,1\n";

    const BOM = header + sample;
    const blob = new Blob(["\uFEFF" + BOM], { type: "text/csv;charset=utf-8;" });  // UTF-8 BOM
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "æ§‹ä»¶æ¸…å–®æ¨¡æ¿.csv";
    a.click();
});

/* ==========================================
   ğŸ“„ CSV â†’ JSON
========================================== */
function csvToJSON(csv) {
    const lines = csv.split("\n").map(l => l.trim()).filter(l => l);
    const headers = lines[0].split(",");
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        const obj = {};
        const row = lines[i].split(",");
        headers.forEach((h, idx) => obj[h] = row[idx] || "");
        result.push(obj);
    }
    return result;
}

/* ==========================================
   ğŸš€ åˆå§‹åŒ–
========================================== */
loadData();

</script>
