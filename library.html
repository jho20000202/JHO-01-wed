<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ§‹ä»¶åº«</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<!-- XLSX è§£æå·¥å…· -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}

.dot-grey { background:#7f8c8d; }
.dot-yellow { background:#f1c40f; }
.dot-orange { background:#e67e22; }
.dot-green { background:#2ecc71; }

.item-card {
    background:#1c2433;
    padding:12px;
    margin:10px 0;
    border-radius:12px;
    color:#fff;
}
.item-id { font-size:18px; font-weight:700; }
.item-sub { font-size:14px; color:#bbb; }
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">æ§‹ä»¶åº«</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
    </div>
</div>

<div class="screen-card">

    <!-- ğŸ”µ æ§‹ä»¶ç‹€æ…‹åˆ‡æ› -->
    <div class="section-title">æ§‹ä»¶ç‹€æ…‹</div>

    <div class="row" style="margin-bottom:12px;">
        <label><input type="radio" name="filterStatus" value="all" checked> å…¨éƒ¨</label>
        <label><span class="status-dot dot-grey"></span>æœªé€²æ–™</label>
        <label><span class="status-dot dot-yellow"></span>é å®šä¸­</label>
        <label><span class="status-dot dot-orange"></span>å·²é€²æ–™</label>
        <label><span class="status-dot dot-green"></span>å·²ä½¿ç”¨</label>
    </div>

    <!-- æœå°‹ -->
    <input id="searchBox" class="input-bar" placeholder="æœå°‹ï¼šç·¨è™Ÿ / è¦æ ¼ / æè³ª / ä½ç½®">

    <!-- ğŸ“¤ åŒ¯å…¥ Excel è‡ªå‹•è§£æ -->
    <div class="section-title">ä¸Šå‚³ Excel / CSV</div>

    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="full">

    <div id="importBtn" class="primary-btn full">åŒ¯å…¥ Excel / CSV</div>

    <!-- ğŸ“¥ ä¸‹è¼‰ CSV æ¨¡æ¿ -->
    <div id="downloadCSV" class="ghost-btn full">ä¸‹è¼‰ CSV æ¨¡æ¿</div>

</div>

<!-- æ§‹ä»¶æ¸…å–® -->
<div class="screen-card">
    <div class="section-title">æ§‹ä»¶æ¸…å–®</div>
    <div id="itemList"></div>
</div>

<script>
/* ==========================================
   ğŸ”§ Supabase åˆå§‹åŒ–
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";  // <<< ç¬¬äºŒæ®µæœƒçµ¦ä½ æ›¿æ›
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   ğŸ“Œ å…¨åŸŸè³‡æ–™
========================================== */
let components = []; // components_library
let planned = [];    // planned_items
let used = [];       // today_records

/* ==========================================
   ğŸŸ¢ Step 1ï¼šè®€å–å…¨éƒ¨è³‡æ–™
========================================== */
async function loadData() {
    const { data: lib } = await db.from("components_library").select("*");
    const { data: plan } = await db.from("planned_items").select("*");
    const { data: use } = await db.from("today_records").select("*");

    components = lib || [];
    planned = plan || [];
    used = use || [];

    renderList();
}

/* ==========================================
   ğŸ“Œ Step 2ï¼šåˆ¤æ–·æ§‹ä»¶ç‹€æ…‹ï¼ˆå››ç¨®é¡è‰²ï¼‰
========================================== */
function getStatus(item_id) {
    const plan = planned.find(p => p.item_id === item_id);
    const useRec = used.find(u => u.item_id === item_id);

    if (!plan && !useRec) return "grey";   // æœªé€²æ–™
    if (plan && plan.status === "planned") return "yellow"; // é å®šä¸­
    if (plan && plan.status === "received" && !useRec) return "orange"; // å·²é€²æ–™
    if (plan && plan.status === "received" && useRec) return "green"; // å·²ä½¿ç”¨
    return "grey";
}

/* ==========================================
   ğŸ–¥ï¸ Step 3ï¼šæ¸²æŸ“æ§‹ä»¶åˆ—è¡¨
========================================== */
function renderList() {
    const list = document.getElementById("itemList");
    const query = document.getElementById("searchBox").value.trim();

    list.innerHTML = "";

    components.forEach(c => {
        const status = getStatus(c.item_id);

        if (query && !(
            c.item_id.includes(query) ||
            (c.spec || "").includes(query) ||
            (c.position || "").includes(query)
        )) return;

        list.innerHTML += `
            <div class="item-card">
                <div class="item-id">${c.item_id}</div>
                <div class="item-sub">${c.spec || ""}</div>
                <div class="item-sub">ä½ç½®ï¼š${c.position || ""}</div>
                <div class="item-sub">é‡é‡ï¼š${c.weight || ""} / æè³ªï¼š${c.material || ""}</div>
                <div class="item-sub">
                    ç‹€æ…‹ï¼š 
                    ${status === "grey" ? "æœªé€²æ–™" :
                      status === "yellow" ? "é å®šä¸­" :
                      status === "orange" ? "å·²é€²æ–™" : "å·²ä½¿ç”¨"}
                </div>
            </div>
        `;
    });
}

/* ==========================================
   ğŸ” æœå°‹å³æ™‚é‹ä½œ
========================================== */
document.getElementById("searchBox").addEventListener("input", renderList);

/* ==========================================
   ğŸ“¤ Step 4ï¼šåŒ¯å…¥ Excel / CSV
========================================== */
document.getElementById("fileInput").addEventListener("change", handleFile);
document.getElementById("importBtn").addEventListener("click", () => {
    const f = document.getElementById("fileInput").files[0];
    if (!f) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
    handleFile({ target: { files: [f] } });
});

async function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;

    const ext = file.name.split(".").pop().toLowerCase();
    const data = await file.arrayBuffer();
    let json = [];

    try {
        if (ext === "csv") {
            json = csvToJSON(new TextDecoder("utf-8").decode(new Uint8Array(data)));
        } else {
            const wb = XLSX.read(data, { type: "array" });
            const ws = wb.Sheets[wb.SheetNames[0]];
            json = XLSX.utils.sheet_to_json(ws);
        }
    } catch (err) {
        console.error(err);
        alert("æª”æ¡ˆè§£æå¤±æ•—");
        return;
    }

    if (!json.length) return alert("æª”æ¡ˆæ²’æœ‰è³‡æ–™");

    // å¿…è¦æ¬„ä½
    const required = ["æ§‹ä»¶ç·¨è™Ÿ", "æ§‹ä»¶è¦æ ¼", "æ§‹ä»¶æè³ª", "æ§‹ä»¶é‡é‡", "æ§‹ä»¶ä½ç½®", "æ§‹ä»¶æ•¸é‡"];
    for (let r of required) {
        if (!json[0][r]) return alert("ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š" + r + "\nè«‹ä¸‹è¼‰æ¨¡æ¿ç¢ºèªæ ¼å¼");
    }

    // çµ„æˆè³‡æ–™
    const insertData = json.map(r => ({
        item_id: String(r["æ§‹ä»¶ç·¨è™Ÿ"]).trim(),
        spec: r["æ§‹ä»¶è¦æ ¼"] || "",
        material: r["æ§‹ä»¶æè³ª"] || "",
        weight: Number(r["æ§‹ä»¶é‡é‡"]) || 0,
        position: r["æ§‹ä»¶ä½ç½®"] || "",
        qty: Number(r["æ§‹ä»¶æ•¸é‡"]) || 1
    }));

    // å¯«å…¥è³‡æ–™åº«
    const { error } = await db.from("components_library").upsert(insertData);

    if (error) {
        console.error(error);
        alert("åŒ¯å…¥å¤±æ•—ï¼š " + error.message);
        return;
    }

    alert("åŒ¯å…¥å®Œæˆï¼");
    loadData(); // é‡æ–°è¼‰å…¥æ¸…å–®
}

/* ==========================================
   ğŸ“¥ CSV æ¨¡æ¿ä¸‹è¼‰ï¼ˆUTF-8ï¼‰
========================================== */
document.getElementById("downloadCSV").addEventListener("click", () => {
    const header = "æ§‹ä»¶ç·¨è™Ÿ,æ§‹ä»¶è¦æ ¼,æ§‹ä»¶æè³ª,æ§‹ä»¶é‡é‡,æ§‹ä»¶ä½ç½®,æ§‹ä»¶æ•¸é‡\n";
    const sample =
        "UV0E3,PL25*500*650,SN490BM,89,32-33/F,1\n" +
        "UV0V1,RH300*300*10*15*5836.8,SN490BM,576,32-33/H,1\n";

    const blob = new Blob([header + sample], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "æ§‹ä»¶æ¸…å–®æ¨¡æ¿.csv";
    a.click();
});

/* CSV â†’ JSON (UTF-8 safe) */
function csvToJSON(csv) {
    const lines = csv.split("\n").map(l => l.trim()).filter(l => l);
    const headers = lines[0].split(",");
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        const obj = {};
        const row = lines[i].split(",");

        headers.forEach((h, idx) => obj[h] = row[idx] || "");
        result.push(obj);
    }
    return result;
}

/* ==========================================
   ğŸš€ åˆå§‹åŒ–
========================================== */
loadData();
</script>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</body>
</html>
