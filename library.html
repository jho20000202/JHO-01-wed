<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>構件庫</title>
<link rel="stylesheet" href="styles.css">

<!-- XLSX 解析工具 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allComponents = [];
let plannedMap = {};
let usedMap = {};

window.onload = async () => {
    await loadData();
};
async function loadData() {
    const c = await sb.from("components_library").select("*");
    const p = await sb.from("planned_items").select("item_id,status");
    const u = await sb.from("today_records").select("item_id,status");

    allComponents = c.data || [];

    plannedMap = {};
    (p.data || []).forEach(x => plannedMap[x.item_id] = x.status);

    usedMap = {};
    (u.data || []).forEach(x => usedMap[x.item_id] = true);

    renderList();
}

function getStatusColor(item) {
    const id = item.item_id;

    if (!plannedMap[id] && !usedMap[id])
        return "#7a7a7a";   // 未進料灰

    if (plannedMap[id] === "planned")
        return "#f1c40f";   // 預定中黃

    if (plannedMap[id] === "received" && !usedMap[id])
        return "#e67e22";   // 已進料橘

    if (plannedMap[id] === "received" && usedMap[id])
        return "#2ecc71";   // 已使用綠

    return "#7a7a7a";
}

function renderList() {
    const container = document.getElementById("list");
    container.innerHTML = "";

    allComponents.forEach(item => {
        const color = getStatusColor(item);

        const div = document.createElement("div");
        div.className = "card";
        div.style.borderLeft = `10px solid ${color}`;
        div.style.marginBottom = "10px";

        div.innerHTML = `
            <div class="app-title">${item.item_id}</div>
            <div class="muted-sm">規格：${item.spec || "-"}</div>
            <div class="muted-sm">材質：${item.material || "-"}</div>
            <div class="muted-sm">位置：${item.position || "-"}</div>
            <div class="muted-sm">重量：${item.weight || "-"}</div>
            <div class="muted-sm">數量：${item.qty || 1}</div>
        `;

        container.appendChild(div);
    });
}

function downloadCSVTemplate() {
    const csv =
`構件編號,構件規格,構件材質,構件重量,構件位置,構件數量
UV0E3,PL25*500*650,SN490BM,89,32-33/F,1`;

    const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "構件清單模板.csv";
    link.click();
}

async function uploadExcel() {
    const input = document.getElementById("fileInput");
    if (!input.files.length) return alert("請選擇 Excel 或 CSV 檔案");

    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        const items = rows.map(r => ({
            item_id: r["構件編號"],
            spec: r["構件規格"],
            material: r["構件材質"],
            weight: Number(r["構件重量"] || 0),
            position: r["構件位置"],
            qty: Number(r["構件數量"] || 1)
        }));

        for (const it of items) {
            if (!it.item_id) {
                alert("缺少構件編號，請下載模板確認格式");
                return;
            }
        }

        await sb.from("components_library").upsert(items);

        alert("匯入成功！");
        await loadData();
    };

    reader.readAsArrayBuffer(file);
}
</script>

</head>
<body>

<div class="top-bar">
    <div class="top-bar-title">構件庫</div>
    <button class="top-btn" onclick="location.href='index.html'">返回主畫面</button>
</div>

<div class="screen-card">
    <div class="section-title">上傳 Excel / CSV</div>

    <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="input-bar">
    <button class="primary-btn" onclick="uploadExcel()">匯入 Excel / CSV</button>

    <button class="ghost-btn full" onclick="downloadCSVTemplate()">下載 CSV 模板</button>
</div>

<div class="screen-card">
    <div class="section-title">構件清單</div>
    <div id="list"></div>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</body>
</html>
