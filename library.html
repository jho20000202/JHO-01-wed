<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ§‹ä»¶åº«</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
/* ç‹€æ…‹é» */
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.dot-grey  { background:#7f8c8d; }
.dot-yellow{ background:#f1c40f; }
.dot-orange{ background:#e67e22; }
.dot-green { background:#2ecc71; }

/* å¡ç‰‡ */
.item-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
    cursor:pointer;
    transition:background 0.2s;
}
.item-card:hover { background:#222b3b; }

.item-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.item-id {
    font-size:18px;
    font-weight:700;
}

.status-text {
    font-size:14px;
    opacity:0.8;
    display:flex;
    align-items:center;
    gap:6px;
}

/* å±•é–‹é¢æ¿ */
.item-details {
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #2a3142;
    display:none;
}
.item-sub {
    font-size:14px;
    color:#bbb;
    margin:6px 0;
}

/* å·²è¼‰å…¥å…¨éƒ¨ */
#loadMessage {
    text-align:center;
    color:#aaa;
    font-size:14px;
    padding:14px;
    display:none;
}

/* Loading åœˆåœˆ */
#loadingSpinner {
    display:none;
    text-align:center;
    padding:14px;
}
#loadingSpinner svg {
    width:28px;
    height:28px;
    animation: spin 0.9s linear infinite;
}
@keyframes spin {
    from { transform:rotate(0deg); }
    to   { transform:rotate(360deg); }
}

/* å›åˆ°é ‚ç«¯ */
#backTopBtn {
    position: fixed;
    right: 18px;
    bottom: 22px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(6px);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;

    opacity: 0;
    pointer-events: none;

    transition:
        opacity 0.3s ease,
        transform 0.25s ease,
        bottom 0.25s ease;
}

#backTopBtn.visible {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
}

#backTopBtn svg {
    width: 22px;
    height: 22px;
    fill: #fff;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">æ§‹ä»¶åº«</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
    </div>
</div>

<div class="screen-card">

    <!-- ğŸ”µ æ§‹ä»¶ç‹€æ…‹åˆ‡æ› -->
    <div class="section-title">æ§‹ä»¶ç‹€æ…‹</div>

    <div class="row" id="statusFilters" style="margin-bottom:12px;">
        <label><input type="radio" name="filterStatus" value="all" checked> å…¨éƒ¨</label>
        <label><input type="radio" name="filterStatus" value="grey"> <span class="status-dot dot-grey"></span>æœªé€²æ–™</label>
        <label><input type="radio" name="filterStatus" value="yellow"> <span class="status-dot dot-yellow"></span>é å®šä¸­</label>
        <label><input type="radio" name="filterStatus" value="orange"> <span class="status-dot dot-orange"></span>å·²é€²æ–™</label>
        <label><input type="radio" name="filterStatus" value="green"> <span class="status-dot dot-green"></span>å·²ä½¿ç”¨</label>
    </div>

    <!-- ğŸ”½ æ’åº -->
    <div class="section-title">æ’åºæ–¹å¼</div>

    <select id="sortSelect" class="input-bar">
        <option value="id_asc">æ§‹ä»¶ç·¨è™Ÿï¼ˆA â†’ Zï¼‰</option>
        <option value="id_desc">æ§‹ä»¶ç·¨è™Ÿï¼ˆZ â†’ Aï¼‰</option>
        <option value="status_order">æ§‹ä»¶ç‹€æ…‹ï¼ˆæœªâ†’é â†’é€²â†’ç”¨ï¼‰</option>
        <option value="position_asc">ä½ç½®ï¼ˆA â†’ Zï¼‰</option>
        <option value="position_desc">ä½ç½®ï¼ˆZ â†’ Aï¼‰</option>
    </select>

    <!-- æœå°‹ -->
    <input id="searchBox" class="input-bar" placeholder="æœå°‹ï¼šç·¨è™Ÿ / è¦æ ¼ / æè³ª / ä½ç½®">

    <!-- ğŸ“¤ åŒ¯å…¥ Excel è‡ªå‹•è§£æ -->
    <div class="section-title">åŒ¯å…¥ Excel / CSV</div>

    <!-- éš±è—æª”æ¡ˆé¸æ“‡å™¨ -->
    <input type="file" id="filePicker" accept=".xlsx,.xls,.csv" style="display:none">

    <div id="importBtn" class="primary-btn full">åŒ¯å…¥ Excel / CSV</div>

    <!-- ğŸ“¥ ä¸‹è¼‰ CSV æ¨¡æ¿ -->
    <div id="downloadCSV" class="ghost-btn full">ä¸‹è¼‰ CSV æ¨¡æ¿</div>

</div>

<!-- æ§‹ä»¶æ¸…å–® -->
<div class="screen-card">
    <div class="section-title">æ§‹ä»¶æ¸…å–®</div>

    <div id="itemList"></div>

    <!-- Loading åœˆåœˆ -->
    <div id="loadingSpinner">
        <svg viewBox="0 0 24 24">
            <path fill="#ccc" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>

    <div id="loadMessage">å·²è¼‰å…¥å…¨éƒ¨æ§‹ä»¶</div>
</div>

<!-- å›åˆ°é ‚ç«¯æŒ‰éˆ• -->
<div id="backTopBtn">
    <svg viewBox="0 0 24 24">
        <path d="M12 4l-8 8h5v8h6v-8h5z"></path>
    </svg>
</div>
<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ==========================================
   ğŸ”§ Supabase åˆå§‹åŒ–
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   ğŸ“Œ å…¨åŸŸè³‡æ–™
========================================== */
let planned = [];  
let used = [];     

/* Infinite Scroll ç‹€æ…‹ */
let offset = 0;         // ä¸‹ä¸€æ‰¹èµ·é»
let limit = 80;         // æ¯æ‰¹ 80 ç­†
let loading = false;    // é¿å…å¤šæ¬¡è§¸ç™¼
let allLoaded = false;  // æ˜¯å¦å·²è¼‰å®Œ

/* æ’åº/åˆ†é¡ç‹€æ…‹ï¼ˆå‰ç«¯æ§åˆ¶ï¼‰ */
let currentSort   = "id_asc";
let currentFilter = "all";

/* DOM */
const itemList       = document.getElementById("itemList");
const loadMessage    = document.getElementById("loadMessage");
const loadingSpinner = document.getElementById("loadingSpinner");

/* ==========================================
   Step 1ï¼šè¼‰å…¥ planned_items / today_records
========================================== */
async function loadMetaData() {
    const { data: plan } = await db.from("planned_items").select("*");
    const { data: use }  = await db.from("today_records").select("*");

    planned = plan || [];
    used = use || [];
}

/* ==========================================
   Step 2ï¼šä¾æ’åºåˆ†æ‰¹è¼‰å…¥æ§‹ä»¶
========================================== */
async function loadNextBatch() {
    if (loading || allLoaded) return;

    loading = true;
    loadingSpinner.style.display = "block";

    let query = db
        .from("components_library")
        .select("*")
        .range(offset, offset + limit - 1);

    /* æ’åºæ–¹å¼ï¼ˆå¾Œç«¯æ’åºï¼‰ */
    if (currentSort === "id_asc") {
        query = query.order("item_id", { ascending: true });
    } else if (currentSort === "id_desc") {
        query = query.order("item_id", { ascending: false });
    } else if (currentSort === "position_asc") {
        query = query.order("position", { ascending: true });
    } else if (currentSort === "position_desc") {
        query = query.order("position", { ascending: false });
    } else if (currentSort === "status_order") {
        query = query.order("item_id", { ascending: true });
    }

    const { data, error } = await query;

    loadingSpinner.style.display = "none";

    if (error) {
        console.error(error);
        loading = false;
        return;
    }

    if (!data || data.length === 0) {
        allLoaded = true;
        loadMessage.style.display = "block";
        loading = false;
        return;
    }

    renderBatch(data);

    offset += limit;
    loading = false;
}

/* ==========================================
   Step 3ï¼šå››è‰²ç‹€æ…‹åˆ¤æ–·
========================================== */
function getStatus(item_id) {
    const plan   = planned.find(p => p.item_id === item_id);
    const useRec = used.find(u => u.item_id === item_id);

    if (!plan && !useRec) return "grey";                     // æœªé€²æ–™
    if (plan && plan.status === "planned") return "yellow";  // é å®šä¸­
    if (plan && plan.status === "received" && !useRec) return "orange"; // å·²é€²æ–™
    if (plan && plan.status === "received" && useRec) return "green";   // å·²ä½¿ç”¨

    return "grey";
}

function statusText(s) {
    return s==="grey"   ? "æœªé€²æ–™" :
           s==="yellow" ? "é å®šä¸­" :
           s==="orange" ? "å·²é€²æ–™" :
           "å·²ä½¿ç”¨";
}

function statusDot(s) {
    return s==="grey"   ? "dot-grey" :
           s==="yellow" ? "dot-yellow" :
           s==="orange" ? "dot-orange" :
           "dot-green";
}
/* ==========================================
   Step 4ï¼šæ¸²æŸ“ä¸€æ‰¹æ§‹ä»¶
========================================== */
function renderBatch(records) {

    records.forEach(c => {
        const status = getStatus(c.item_id);

        // ç‹€æ…‹åˆ†é¡éæ¿¾
        if (currentFilter !== "all" && status !== currentFilter) return;

        const cardId = "details_" + c.item_id;

        const html = `
            <div class="item-card" onclick="toggleDetails('${cardId}')">

                <div class="item-header">
                    <div class="item-id">${c.item_id}</div>

                    <div class="status-text">
                        <span class="status-dot ${statusDot(status)}"></span>
                        ${statusText(status)}
                    </div>
                </div>

                <div id="${cardId}" class="item-details">
                    <div class="item-sub">${c.spec || ""}</div>
                    <div class="item-sub">æè³ªï¼š${c.material || ""}</div>
                    <div class="item-sub">ä½ç½®ï¼š${c.position || ""}</div>
                    <div class="item-sub">é‡é‡ï¼š${c.weight || ""}</div>
                    <div class="item-sub">æ•¸é‡ï¼š${c.qty || 1}</div>
                </div>

            </div>
        `;

        itemList.insertAdjacentHTML("beforeend", html);
    });
}

/* ==========================================
   Step 5ï¼šå¡ç‰‡å±•é–‹ / æ”¶åˆ
========================================== */
function toggleDetails(id) {
    const el = document.getElementById(id);
    const btn = document.getElementById("backTopBtn");

    if (el.style.display === "block") {
        el.style.display = "none";
        btn.style.bottom = "22px";
    } else {
        el.style.display = "block";
        btn.style.bottom = "90px"; // é¿å…è¢«æ“‹ä½
    }
}

/* ==========================================
   Step 6ï¼šæœå°‹ï¼ˆåœç”¨ Infinite Scrollï¼‰
========================================== */
document.getElementById("searchBox").addEventListener("input", async (e) => {

    const q = e.target.value.trim().toLowerCase();

    itemList.innerHTML = "";
    loadMessage.style.display = "none";

    // è‹¥æœå°‹æ¡†æ¸…ç©º â†’ å›åˆ° Infinite Scroll
    if (!q) {
        offset = 0;
        allLoaded = false;
        await loadNextBatch();
        return;
    }

    // æœå°‹æ¨¡å¼ï¼ˆæœ€å¤š 200 ç­†ï¼‰
    const { data, error } = await db
        .from("components_library")
        .select("*")
        .or(`item_id.ilike.%${q}%,spec.ilike.%${q}%,material.ilike.%${q}%,position.ilike.%${q}%`)
        .limit(200);

    if (error) return console.error(error);

    if (!data || data.length === 0) {
        itemList.innerHTML =
            "<div style='color:#aaa;text-align:center;padding:20px;'>æŸ¥ç„¡è³‡æ–™</div>";
        return;
    }

    renderBatch(data);
});

/* ==========================================
   Step 7ï¼šæ§‹ä»¶ç‹€æ…‹åˆ†é¡ï¼ˆæœª / é  / é€² / ç”¨ï¼‰
========================================== */
document.querySelectorAll("input[name=filterStatus]").forEach(radio => {
    radio.addEventListener("change", async (e) => {

        currentFilter = e.target.value;

        // Reset infinite scroll
        offset = 0;
        allLoaded = false;
        itemList.innerHTML = "";
        loadMessage.style.display = "none";

        await loadNextBatch();
    });
});

/* ==========================================
   Step 8ï¼šæ’åºæ¨¡å¼ï¼ˆç·¨è™Ÿ / ä½ç½® / ç‹€æ…‹ï¼‰
========================================== */
document.getElementById("sortSelect").addEventListener("change", async (e) => {

    currentSort = e.target.value;

    offset = 0;
    allLoaded = false;
    itemList.innerHTML = "";
    loadMessage.style.display = "none";

    await loadNextBatch();
});

/* ==========================================
   Step 9ï¼šåŒ¯å…¥ Excel / CSVï¼ˆLazy XLSXï¼‰
========================================== */
document.getElementById("importBtn").addEventListener("click", () => {
    document.getElementById("filePicker").click();
});

document.getElementById("filePicker").addEventListener("change", async (e) => {

    const file = e.target.files[0];
    if (!file) return;

    alert("æ­£åœ¨åŒ¯å…¥è³‡æ–™â€¦");

    const ext = file.name.split(".").pop().toLowerCase();
    const buffer = await file.arrayBuffer();
    let json = [];

    try {
        if (ext === "csv") {
            json = csvToJSON(new TextDecoder("utf-8").decode(new Uint8Array(buffer)));
        } else {
            const wb = XLSX.read(buffer, { type:"array" });
            const ws = wb.Sheets[wb.SheetNames[0]];
            json = XLSX.utils.sheet_to_json(ws);
        }
    } catch(err) {
        console.error(err);
        alert("æª”æ¡ˆè§£æå¤±æ•—");
        return;
    }

    if (!json.length) return alert("æª”æ¡ˆç„¡è³‡æ–™");

    const required = [
        "æ§‹ä»¶ç·¨è™Ÿ","æ§‹ä»¶è¦æ ¼","æ§‹ä»¶æè³ª",
        "æ§‹ä»¶é‡é‡","æ§‹ä»¶ä½ç½®","æ§‹ä»¶æ•¸é‡"
    ];

    for (let r of required) {
        if (!json[0][r]) return alert("ç¼ºå°‘æ¬„ä½ï¼š" + r);
    }

    const insertData = json.map(r => ({
        item_id: String(r["æ§‹ä»¶ç·¨è™Ÿ"]).trim(),
        spec: r["æ§‹ä»¶è¦æ ¼"] || "",
        material: r["æ§‹ä»¶æè³ª"] || "",
        weight: Number(r["æ§‹ä»¶é‡é‡"]) || 0,
        position: r["æ§‹ä»¶ä½ç½®"] || "",
        qty: Number(r["æ§‹ä»¶æ•¸é‡"]) || 1
    }));

    const { error } = await db.from("components_library").upsert(insertData);

    if (error) {
        alert("åŒ¯å…¥å¤±æ•—ï¼š" + error.message);
    } else {
        alert("åŒ¯å…¥å®Œæˆï¼");
        offset = 0;
        allLoaded = false;
        itemList.innerHTML = "";
        await loadMetaData();
        await loadNextBatch();
    }

    e.target.value = "";
});

/* ==========================================
   CSV â†’ JSON
========================================== */
function csvToJSON(csv) {
    const lines = csv.split("\n").map(x=>x.trim()).filter(x=>x);
    const headers = lines[0].split(",");
    const result = [];

    for (let i=1; i<lines.length; i++) {
        const row = lines[i].split(",");
        const obj = {};
        headers.forEach((h, idx)=> obj[h] = row[idx] || "");
        result.push(obj);
    }
    return result;
}

/* ==========================================
   Step 10ï¼šå›åˆ°é ‚ç«¯æŒ‰éˆ•
========================================== */
const backTopBtn = document.getElementById("backTopBtn");

window.addEventListener("scroll", () => {
    if (window.scrollY > 300) {
        backTopBtn.classList.add("visible");
        backTopBtn.style.transform = "scale(1)";
    } else {
        backTopBtn.classList.remove("visible");
        backTopBtn.style.transform = "scale(0.7)";
    }
});

backTopBtn.addEventListener("click", () => {
    window.scrollTo({ top:0, behavior:"smooth" });
});

/* ==========================================
   Step 11ï¼šInfinite Scrollï¼ˆæ»‘åˆ°åº•è‡ªå‹•è¼‰å…¥ï¼‰
========================================== */
window.addEventListener("scroll", async () => {
    if (allLoaded || loading) return;

    const nearBottom =
        window.innerHeight + window.scrollY >= document.body.offsetHeight - 180;

    if (nearBottom) {
        await loadNextBatch();
    }
});

/* ==========================================
   ğŸš€ åˆå§‹åŒ–ï¼ˆè¼‰ metadata â†’ ç¬¬ä¸€æ‰¹æ§‹ä»¶ï¼‰
========================================== */
(async () => {
    await loadMetaData();
    await loadNextBatch();
})();
</script>
