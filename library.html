<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>構件庫</title>
<link rel="stylesheet" href="styles.css">

<style>
/* 額外補強 mobile 顯示與顏色點 */
.status-row {
    display: flex;
    gap: 26px;
    margin: 12px 0 18px 0;
    padding-left: 8px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
}

.s-gray  { background:#7d7d7d; }
.s-yellow{ background:#f1c40f; }
.s-orange{ background:#e67e22; }
.s-green { background:#2ecc71; }

/* 卡片列出每個構件 */
.item-card {
    background:#1c2433;
    padding:14px;
    border-radius:16px;
    margin-bottom:12px;
}
.item-title {
    font-size:16px;
    font-weight:700;
    color:#fff;
}
.item-sub {
    color:#bbb;
    font-size:14px;
    margin-top:6px;
}
</style>
</head>

<body>

<!-- top bar -->
<div class="top-bar">
    <div class="top-bar-title">構件庫</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">返回主畫面</a>
    </div>
</div>

<!-- 主卡片 -->
<div class="screen-card">

    <!-- 標題：構件狀態 -->
    <div class="section-title">構件狀態</div>

    <div class="status-row">
        <div class="row">
            <div class="status-dot s-gray"></div><span class="muted">未進料</span>
        </div>

        <div class="row">
            <div class="status-dot s-yellow"></div><span class="muted">預定中</span>
        </div>

        <div class="row">
            <div class="status-dot s-orange"></div><span class="muted">已進料</span>
        </div>

        <div class="row">
            <div class="status-dot s-green"></div><span class="muted">已使用</span>
        </div>
    </div>

    <!-- 搜尋列 -->
    <span class="field-label">搜尋構件</span>
    <input id="searchInput" class="input-bar" placeholder="搜尋：編號 / 規格 / 材質 / 位置 / 重量 / 數量">

    <!-- 匯入 -->
    <button class="primary-btn" onclick="openFile()">匯入 Excel / CSV</button>

    <!-- 被安全移出的 file input（不會遮住按鈕） -->
    <input id="fileInput" type="file" accept=".csv, .xlsx" 
           onchange="handleFile(event)"
           style="position:fixed; left:-9999px;">

    <!-- 下載 CSV 模板 -->
    <button class="ghost-btn full" onclick="downloadTemplate()">下載 CSV 模板</button>

    <!-- 排序 -->
    <span class="field-label">排序方式</span>
    <select id="sortSelect" class="input-bar" onchange="renderList()">
        <option value="id_asc">構件名稱 ↑</option>
        <option value="id_desc">構件名稱 ↓</option>
        <option value="pos_asc">位置 ↑</option>
        <option value="pos_desc">位置 ↓</option>
    </select>

    <!-- 顯示結果 -->
    <div id="listArea" style="margin-top:20px;"></div>

</div>

<script src="back.js"></script>
<script>
// -----------------------------
// 匯入 CSV / Excel
// -----------------------------
function openFile() {
    document.getElementById("fileInput").click();
}

function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    alert("檔案讀取中…（若為 Excel 需後端處理）");

    // 你可在 back.js 實作 parse 與上傳 supabase 的流程
}


// -----------------------------
// 模板 CSV
// -----------------------------
function downloadTemplate() {
    const csv =
`鐵件編號,規格,材質,位置,重量,數量
sample-001,H300*200,SS400,A1,123.4,8`;

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "構件庫模板.csv";
    a.click();

    URL.revokeObjectURL(url);
}


// -----------------------------
// 抓資料 & 顯示
// -----------------------------
let ITEMS = [];

async function loadData() {
    const { data, error } = await supabase
        .from("components_library")
        .select("*");

    if (error) {
        alert("讀取失敗: " + error.message);
        return;
    }

    ITEMS = data || [];
    renderList();
}

// 狀態顏色
function getStatusColor(status) {
    if (status === "used") return "s-green";
    if (status === "received") return "s-orange";
    if (status === "planned") return "s-yellow";
    return "s-gray";
}

// 排序
function renderList() {
    const key = document.getElementById("sortSelect").value;
    let list = [...ITEMS];

    if (key === "id_asc") list.sort((a,b)=>a.item_id.localeCompare(b.item_id));
    if (key === "id_desc") list.sort((a,b)=>b.item_id.localeCompare(a.item_id));
    if (key === "pos_asc") list.sort((a,b)=> (a.position||"").localeCompare(b.position||""));
    if (key === "pos_desc") list.sort((a,b)=> (b.position||"").localeCompare(a.position||""));

    const area = document.getElementById("listArea");
    area.innerHTML = "";

    list.forEach(item=>{
        const div = document.createElement("div");
        div.className = "item-card";

        div.innerHTML = `
            <div class="row">
                <div class="status-dot ${getStatusColor(item.status)}"></div>
                <div class="item-title">${item.item_id}</div>
            </div>
            <div class="item-sub">${item.position || "無位置"}</div>
            <div class="item-sub">${item.spec || "-"}</div>
            <div class="item-sub">重量：${item.weight || "-"}　數量：${item.qty || "-"}</div>
        `;

        area.appendChild(div);
    });
}

// 初始化
loadData();

</script>
</body>
</html>
