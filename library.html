<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>構件庫</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

<!-- 頂部標題 -->
<header class="top-bar">
    <div class="top-bar-title">構件庫</div>
</header>

<main>

<!-- 狀態 Chips -->
<section class="screen-card">
    <div class="chip-row">
        <div class="chip" data-status="none">未進料</div>
        <div class="chip chip-yellow" data-status="planned">預定中</div>
        <div class="chip chip-orange" data-status="received">已進料</div>
        <div class="chip chip-green" data-status="used">已使用</div>
    </div>
</section>

<!-- 搜尋欄 -->
<section class="screen-card">
    <input id="searchBar" class="input-bar" placeholder="搜尋：編號 / 規格 / 材質 / 位置 / 重量 / 數量">
</section>

<!-- 匯入 / 模板 -->
<section class="screen-card row-btns">
    <button class="ghost-btn full" onclick="importCSV()">匯入 Excel / CSV</button>
    <button class="ghost-btn full" onclick="downloadTemplate()">下載 CSV 模板</button>
</section>

<!-- 排序 -->
<section class="screen-card">
    <label class="field-label">排序：</label>
    <select id="sortSelect" class="input-bar">
        <option value="id-asc">構件名稱 ↑</option>
        <option value="id-desc">構件名稱 ↓</option>
        <option value="position-asc">位置 ↑</option>
        <option value="position-desc">位置 ↓</option>
        <option value="spec-asc">規格 ↑</option>
        <option value="spec-desc">規格 ↓</option>
        <option value="weight-asc">重量 ↑</option>
        <option value="weight-desc">重量 ↓</option>
        <option value="qty-asc">數量 ↑</option>
        <option value="qty-desc">數量 ↓</option>
    </select>
</section>

<!-- 說明文字 -->
<section class="screen-card">
    <div class="note-text">
        • 構件庫匯入格式為 6 欄  
        • 構件編號 / 規格 / 材質 / 重量 / 位置 / 數量  
        • 建議先下載模板再進行編輯  
    </div>
</section>

<!-- 構件列表 -->
<section class="screen-card" id="listContainer">
    <!-- 動態生成 -->
</section>

</main>

<script src="back.js"></script>
<script>
/* ---------------------------
   全局資料
----------------------------*/
let rawList = [];   // 原始構件
let statusMaps = {}; // 用於判斷狀態
let activeStatus = ""; // 篩選狀態
let keyword = "";
let sortMode = "id-asc";

/* ---------------------------
   初始化
----------------------------*/
document.addEventListener("DOMContentLoaded", () => {
    loadLibrary();
    bindEvents();
});

function bindEvents() {
    document.getElementById("searchBar").addEventListener("input", (e)=> {
        keyword = e.target.value.trim();
        renderList();
    });

    document.getElementById("sortSelect").addEventListener("change", (e)=>{
        sortMode = e.target.value;
        renderList();
    });

    document.querySelectorAll(".chip").forEach(chip=>{
        chip.addEventListener("click", ()=>{
            if (activeStatus === chip.dataset.status){
                activeStatus = "";
                chip.classList.remove("active-chip");
            } else {
                activeStatus = chip.dataset.status;
                document.querySelectorAll(".chip").forEach(c=> c.classList.remove("active-chip"));
                chip.classList.add("active-chip");
            }
            renderList();
        });
    });
}

/* ---------------------------
   讀取構件庫
----------------------------*/
function loadLibrary(){
    rawList = db_read("componentsLibrary") || [];
    statusMaps = buildStatusMaps();
    renderList();
}

/* ---------------------------
   渲染清單
----------------------------*/
function renderList(){
    let list = rawList.slice();

    // 狀態過濾
    list = list.filter(item => matchStatus(item));

    // 關鍵字搜尋
    if (keyword){
        const k = keyword.toLowerCase();
        list = list.filter(x =>
            String(x.id||"").toLowerCase().includes(k) ||
            String(x.spec||"").toLowerCase().includes(k) ||
            String(x.material||"").toLowerCase().includes(k) ||
            String(x.position||"").toLowerCase().includes(k) ||
            String(x.weight||"").toLowerCase().includes(k) ||
            String(x.quantity||"").toLowerCase().includes(k)
        );
    }

    // 排序
    list.sort(sortFunction);

    // 清空並重建
    const box = document.getElementById("listContainer");
    box.innerHTML = "";

    if (!list.length){
        box.innerHTML = `<div class="empty-text">目前沒有構件資料</div>`;
        return;
    }

    list.forEach(item=>{
        const k = keyOf(item);
        const isReceived = statusMaps.receivedKeys?.has(k);
        const usedQty = statusMaps.usedSumByKey?.get(k) || 0;
        const statusColor =
            usedQty > 0 ? "green" :
            isReceived ? "orange" : 
            ""; 

        const card = document.createElement("div");
        card.className = "list-card";

        card.innerHTML = `
            <div class="list-card-row">
                <span class="item-id">${item.id || ""}</span>
                <span class="status-dot ${statusColor}"></span>
            </div>
            <div class="list-sub">規格：${item.spec || "-"}</div>
            <div class="list-sub">材質：${item.material || "-"}</div>
            <div class="list-sub">位置：${item.position || "-"}</div>
            <div class="list-sub">重量：${item.weight || 0}</div>
            <div class="list-sub">數量：${item.quantity || 0}</div>
        `;
        box.appendChild(card);
    });
}

/* ---------------------------
   匯入 CSV
----------------------------*/
function importCSV(){
    alert("匯入功能預留，稍後會整合 Excel / CSV 解析");
}

/* ---------------------------
   下載 CSV 模板
----------------------------*/
function downloadTemplate(){
    const csv =
`構件編號,構件規格,構件材質,構件重量,構件位置,構件數量
UVOE3,PL-25*500*650,SN490BM,112.2936,0/A,3`;

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "構件庫模板.csv";
    a.click();

    URL.revokeObjectURL(url);
}

/* ---------------------------
   狀態篩選器
----------------------------*/
function matchStatus(item){
    if (!activeStatus) return true;

    const k = keyOf(item);
    const isReceived = statusMaps.receivedKeys?.has(k);
    const usedQty = statusMaps.usedSumByKey?.get(k) || 0;

    switch(activeStatus){
        case "none": return !isReceived && usedQty === 0;
        case "planned": return false; // 預定中未實作
        case "received": return isReceived;
        case "used": return usedQty > 0;
    }
    return true;
}

/* ---------------------------
   排序函數
----------------------------*/
function sortFunction(a,b){
    switch(sortMode){
        case "id-asc": return String(a.id).localeCompare(String(b.id));
        case "id-desc": return String(b.id).localeCompare(String(a.id));
        case "position-asc": return String(a.position).localeCompare(String(b.position));
        case "position-desc": return String(b.position).localeCompare(String(a.position));
        case "spec-asc": return String(a.spec).localeCompare(String(b.spec));
        case "spec-desc": return String(b.spec).localeCompare(String(a.spec));
        case "weight-asc": return (Number(a.weight)||0) - (Number(b.weight)||0);
        case "weight-desc": return (Number(b.weight)||0) - (Number(a.weight)||0);
        case "qty-asc": return (Number(a.quantity)||0) - (Number(b.quantity)||0);
        case "qty-desc": return (Number(b.quantity)||0) - (Number(a.quantity)||0);
    }
    return 0;
}

</script>

</body>
</html>
