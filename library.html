<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>構件庫</title>

    <!-- 你的 styles.css -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Excel 處理套件：SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">構件庫</div>

    <div class="top-bar-actions">
        <button class="top-btn" onclick="window.location.href='index.html'">返回主畫面</button>
    </div>
</div>

<div class="screen-card">

    <!-- 狀態篩選 -->
    <div class="section-title">構件狀態</div>

    <div class="row" style="margin-bottom: 16px;">
        <span style="color:#9aa0a6"><input type="radio" name="s" onclick="filterStatus('all')" checked> 全部</span>
        <span style="color:#9aa0a6"><input type="radio" name="s" onclick="filterStatus('unreceived')"> 未進料</span>
        <span style="color:#9aa0a6"><input type="radio" name="s" onclick="filterStatus('planned')"> 預定中</span>
        <span style="color:#9aa0a6"><input type="radio" name="s" onclick="filterStatus('received')"> 已進料</span>
        <span style="color:#9aa0a6"><input type="radio" name="s" onclick="filterStatus('used')"> 已使用</span>
    </div>

    <!-- 搜尋 -->
    <input id="searchBox" class="input-bar" placeholder="搜尋：編號 / 規格 / 材質 / 位置 / 重量 / 數量" oninput="applyFilters()">

    <!-- 匯入按鈕 -->
    <button class="primary-btn full" onclick="document.getElementById('fileInput').click()">匯入 Excel / CSV</button>
    <input id="fileInput" type="file" accept=".xlsx,.csv" style="display:none" onchange="handleFile(event)">

    <!-- 下載模板 -->
    <button class="ghost-btn full" onclick="downloadTemplate()">下載 CSV 模板</button>

    <!-- 排序 -->
    <div class="field-label">排序方式</div>
    <select id="sortMode" class="input-bar" onchange="applyFilters()">
        <option value="id_asc">構件編號 ↑</option>
        <option value="id_desc">構件編號 ↓</option>
        <option value="status">狀態排序</option>
    </select>

</div>

<!-- 資料列表 -->
<div id="listContainer" style="margin: 16px;"></div>

<script>
/* -----------------------------------------------------
   Supabase 初始化
----------------------------------------------------- */
const supabaseUrl = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const supabaseKey = "YOUR-ANON-KEY";
const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

let allItems = [];
let currentFilter = "all";

/* -----------------------------------------------------
   匯入 Excel / CSV
----------------------------------------------------- */
function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = async function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        if (rows.length === 0) return alert("檔案為空");

        // 必要欄位
        const required = ["鐵件編號","規格","材質","位置","重量","數量"];
        for (let c of required) {
            if (!rows[0].hasOwnProperty(c)) {
                alert(`缺少必要欄位：${c}\n請下載模板確認格式`);
                return;
            }
        }

        // 自動分類邏輯
        const uploadData = rows.map(r => ({
            item_id: r["鐵件編號"],
            spec: r["規格"],
            material: r["材質"],
            position: r["位置"],
            weight: Number(r["重量"]),
            qty: Number(r["數量"]),
            status: detectStatus(r)
        }));

        // 上傳至 Supabase
        const { error } = await supabase
            .from("components_library")
            .insert(uploadData);

        if (error) return alert("上傳失敗：" + error.message);

        alert("匯入成功！");
        loadData();
    };

    reader.readAsArrayBuffer(file);
}

/* -----------------------------------------------------
   狀態自動判斷
----------------------------------------------------- */
function detectStatus(row) {
    const hasPlanned = row["預定日期"]?.trim() !== "";
    const hasReceived = row["進料日期"]?.trim() !== "";
    const usedQty = Number(row["已使用數量"] || 0);

    if (usedQty > 0) return "used";
    if (hasReceived) return "received";
    if (hasPlanned) return "planned";
    return "unreceived";
}

/* -----------------------------------------------------
   下載模板
----------------------------------------------------- */
function downloadTemplate() {
    const csv =
"鐵件編號,規格,材質,位置,重量,數量\n" +
"SAMPLE-01,H100x50x5x7,SS400,A1-01,12.5,4\n";

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "構件庫模板.csv";
    link.click();
}

/* -----------------------------------------------------
   讀取 Supabase 資料
----------------------------------------------------- */
async function loadData() {
    const { data, error } = await supabase
        .from("components_library")
        .select("*")
        .order("item_id");

    if (error) {
        alert("資料讀取失敗：" + error.message);
        return;
    }

    allItems = data || [];
    applyFilters();
}

/* -----------------------------------------------------
   狀態篩選
----------------------------------------------------- */
function filterStatus(s) {
    currentFilter = s;
    applyFilters();
}

/* -----------------------------------------------------
   套用搜尋 + 排序 + 狀態過濾
----------------------------------------------------- */
function applyFilters() {
    let list = [...allItems];

    // 狀態
    if (currentFilter !== "all") {
        list = list.filter(x => x.status === currentFilter);
    }

    // 搜尋
    const q = document.getElementById("searchBox").value.trim().toLowerCase();
    if (q !== "") {
        list = list.filter(x =>
            JSON.stringify(x).toLowerCase().includes(q)
        );
    }

    // 排序
    const sortMode = document.getElementById("sortMode").value;
    if (sortMode === "id_asc") list.sort((a,b)=>a.item_id.localeCompare(b.item_id));
    if (sortMode === "id_desc") list.sort((a,b)=>b.item_id.localeCompare(a.item_id));
    if (sortMode === "status") list.sort((a,b)=>a.status.localeCompare(b.status));

    // 繪製 UI
    renderList(list);
}

/* -----------------------------------------------------
   顯示列表
----------------------------------------------------- */
function renderList(list) {
    const container = document.getElementById("listContainer");
    container.innerHTML = "";

    list.forEach(item => {
        const color = getStatusColor(item.status);

        const div = document.createElement("div");
        div.className = "card";
        div.style.borderLeft = `6px solid ${color}`;
        div.style.marginBottom = "12px";

        div.innerHTML = `
            <div class="app-title">${item.item_id}</div>
            <div class="muted-sm">${item.position}</div>
            <div class="muted-sm">${item.spec}</div>
            <div class="muted-sm">重量：${item.weight} | 數量：${item.qty}</div>
            <div class="muted-sm">狀態：<span style="color:${color}">${translateStatus(item.status)}</span></div>
        `;

        container.appendChild(div);
    });
}

function getStatusColor(s) {
    return {
        unreceived: "#888",
        planned: "#f1c40f",
        received: "#e67e22",
        used: "#2ecc71"
    }[s] || "#999";
}

function translateStatus(s) {
    return {
        unreceived: "未進料",
        planned: "預定中",
        received: "已進料",
        used: "已使用"
    }[s];
}

// 載入資料
loadData();
</script>

</body>
</html>
