<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ§‹ä»¶åº«</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<!-- XLSXï¼ˆLazy Load å‰å…ˆç§»é™¤ï¼Œé€™è£¡ä¿ç•™è¨»è§£ï¼‰
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
-->

<style>
/* ç‹€æ…‹é» */
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.dot-grey  { background:#7f8c8d; }
.dot-yellow{ background:#f1c40f; }
.dot-orange{ background:#e67e22; }
.dot-green { background:#2ecc71; }

/* æ§‹ä»¶æ¸…å–®å¡ç‰‡ï¼ˆå¯å±•é–‹ï¼‰ */
.item-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
    cursor:pointer;
    transition:background 0.2s;
}

.item-card:hover {
    background:#222b3b;
}

.item-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.item-id {
    font-size:18px;
    font-weight:700;
}

.status-text {
    font-size:14px;
    opacity:0.8;
    display:flex;
    align-items:center;
    gap:6px;
}

/* å±•é–‹å€åŸŸ */
.item-details {
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #2a3142;
    display:none;
}

.item-sub {
    font-size:14px;
    color:#bbb;
    margin:6px 0;
}

/* åº•éƒ¨è¨Šæ¯ï¼ˆå·²è¼‰å…¥å…¨éƒ¨æ§‹ä»¶ï¼‰ */
#loadMessage {
    text-align:center;
    color:#aaa;
    font-size:14px;
    padding:14px;
    display:none;
}

/* æµ®å‹•å›é ‚æŒ‰éˆ• */
#backTopBtn {
    position: fixed;
    right: 18px;
    bottom: 22px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(6px);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: 
        opacity 0.3s ease,
        transform 0.25s ease,
        bottom 0.25s ease;
}

#backTopBtn.visible {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
}

#backTopBtn:hover {
    background: rgba(255,255,255,0.25);
}

#backTopBtn svg {
    width: 22px;
    height: 22px;
    fill: #fff;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">æ§‹ä»¶åº«</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
    </div>
</div>

<div class="screen-card">

    <!-- ğŸ”µ æ§‹ä»¶ç‹€æ…‹åˆ‡æ› -->
    <div class="section-title">æ§‹ä»¶ç‹€æ…‹</div>

    <div class="row" style="margin-bottom:12px;">
        <label><input type="radio" name="filterStatus" value="all" checked> å…¨éƒ¨</label>
        <label><span class="status-dot dot-grey"></span>æœªé€²æ–™</label>
        <label><span class="status-dot dot-yellow"></span>é å®šä¸­</label>
        <label><span class="status-dot dot-orange"></span>å·²é€²æ–™</label>
        <label><span class="status-dot dot-green"></span>å·²ä½¿ç”¨</label>
    </div>

    <!-- æœå°‹ -->
    <input id="searchBox" class="input-bar" placeholder="æœå°‹ï¼šç·¨è™Ÿ / è¦æ ¼ / æè³ª / ä½ç½®">

    <!-- ğŸ“¤ åŒ¯å…¥ Excel è‡ªå‹•è§£æ -->
    <div class="section-title">åŒ¯å…¥ Excel / CSV</div>

    <!-- éš±è—æª”æ¡ˆé¸æ“‡å™¨ -->
    <input type="file" id="filePicker" accept=".xlsx,.xls,.csv" style="display:none">

    <!-- ä½¿ç”¨è€…æŒ‰çš„æŒ‰éˆ• -->
    <div id="importBtn" class="primary-btn full">åŒ¯å…¥ Excel / CSV</div>

    <!-- ğŸ“¥ ä¸‹è¼‰ CSV æ¨¡æ¿ -->
    <div id="downloadCSV" class="ghost-btn full">ä¸‹è¼‰ CSV æ¨¡æ¿</div>

</div>

<!-- æ§‹ä»¶æ¸…å–® -->
<div class="screen-card">
    <div class="section-title">æ§‹ä»¶æ¸…å–®</div>
    <div id="itemList"></div>

    <!-- è¼‰åˆ°æœ€å¾Œçš„æç¤º -->
    <div id="loadMessage">å·²è¼‰å…¥å…¨éƒ¨æ§‹ä»¶</div>
</div>

<!-- å›é ‚æŒ‰éˆ• -->
<div id="backTopBtn">
    <svg viewBox="0 0 24 24">
        <path d="M12 4l-8 8h5v8h6v-8h5z"></path>
    </svg>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ==========================================
   ğŸ”§ Supabase åˆå§‹åŒ–
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   ğŸ“Œ å…¨åŸŸè³‡æ–™
========================================== */
let planned = [];    
let used = [];       

/* Infinite Scroll æ§åˆ¶ */
let offset = 0;          // ç•¶å‰èµ·å§‹ç­†æ•¸
let limit = 100;         // æ¯æ¬¡è®€å– 100 ç­†
let loading = false;     // é¿å…é€£çºŒè§¸ç™¼
let allLoaded = false;   // æ˜¯å¦å·²è¼‰å®Œå…¨éƒ¨è³‡æ–™

/* DOM */
const itemList = document.getElementById("itemList");
const loadMessage = document.getElementById("loadMessage");

/* ==========================================
   Step 1ï¼šè¼‰å…¥ planned_items / today_records
========================================== */
async function loadMetaData() {
    const { data: plan } = await db.from("planned_items").select("*");
    const { data: use } = await db.from("today_records").select("*");
    planned = plan || [];
    used = use || [];
}

/* ==========================================
   Step 2ï¼šå¾ Supabase è®€å–ä¸‹ä¸€æ‰¹æ§‹ä»¶
========================================== */
async function loadNextBatch() {
    if (loading || allLoaded) return;
    loading = true;

    const { data, error } = await db
        .from("components_library")
        .select("*")
        .range(offset, offset + limit - 1);

    if (error) {
        console.error(error);
        loading = false;
        return;
    }

    // è‹¥æ²’æœ‰æ›´å¤šè³‡æ–™
    if (!data || data.length === 0) {
        allLoaded = true;
        loadMessage.style.display = "block"; // é¡¯ç¤ºã€Œå·²è¼‰å…¥å…¨éƒ¨æ§‹ä»¶ã€
        loading = false;
        return;
    }

    renderBatch(data);

    offset += limit;
    loading = false;
}

/* ==========================================
   Step 3ï¼šå››è‰²ç‹€æ…‹åˆ¤æ–·
========================================== */
function getStatus(item_id) {
    const plan = planned.find(p => p.item_id === item_id);
    const useRec = used.find(u => u.item_id === item_id);

    if (!plan && !useRec) return "grey"; // æœªé€²æ–™
    if (plan && plan.status === "planned") return "yellow"; // é å®šä¸­
    if (plan && plan.status === "received" && !useRec) return "orange"; // å·²é€²æ–™
    if (plan && plan.status === "received" && useRec) return "green"; // å·²ä½¿ç”¨

    return "grey";
}

function statusText(s) {
    return s==="grey"   ? "æœªé€²æ–™" :
           s==="yellow" ? "é å®šä¸­" :
           s==="orange" ? "å·²é€²æ–™" :
           "å·²ä½¿ç”¨";
}

function statusDot(s) {
    return s==="grey"   ? "dot-grey" :
           s==="yellow" ? "dot-yellow" :
           s==="orange" ? "dot-orange" :
           "dot-green";
}

/* ==========================================
   Step 4ï¼šæ¸²æŸ“ä¸€æ‰¹ï¼ˆ100 ç­†ï¼‰
========================================== */
function renderBatch(records) {
    records.forEach(c => {
        const status = getStatus(c.item_id);
        const cardId = "details_" + c.item_id;

        const cardHTML = `
            <div class="item-card" onclick="toggleDetails('${cardId}')">
                <div class="item-header">
                    <div class="item-id">${c.item_id}</div>
                    <div class="status-text">
                        <span class="status-dot ${statusDot(status)}"></span>
                        ${statusText(status)}
                    </div>
                </div>

                <div id="${cardId}" class="item-details">
                    <div class="item-sub">${c.spec || ""}</div>
                    <div class="item-sub">æè³ªï¼š${c.material || ""}</div>
                    <div class="item-sub">ä½ç½®ï¼š${c.position || ""}</div>
                    <div class="item-sub">é‡é‡ï¼š${c.weight || ""}</div>
                    <div class="item-sub">æ•¸é‡ï¼š${c.qty || 1}</div>
                </div>
            </div>
        `;

        itemList.insertAdjacentHTML("beforeend", cardHTML);
    });
}

/* ==========================================
   Step 5ï¼šå±•é–‹ / æ”¶åˆè©³ç´°è³‡è¨Š
========================================== */
function toggleDetails(id) {
    const el = document.getElementById(id);
    const backBtn = document.getElementById("backTopBtn");

    if (el.style.display === "block") {
        el.style.display = "none";
        backBtn.style.bottom = "22px";
    } else {
        el.style.display = "block";
        backBtn.style.bottom = "90px";
    }
}

/* ==========================================
   Step 6ï¼šæœå°‹ï¼ˆåœç”¨ infinite scrollï¼‰
========================================== */
document.getElementById("searchBox").addEventListener("input", async (e) => {
    const q = e.target.value.trim().toLowerCase();

    itemList.innerHTML = "";
    loadMessage.style.display = "none";

    if (!q) {
        // æ¸…é™¤æœå°‹ â†’ å›åˆ° infinite scroll
        offset = 0;
        allLoaded = false;
        await loadNextBatch();
        return;
    }

    // æœå°‹æ¨¡å¼ï¼ˆæœ€å¤š 200 ç­†ä»¥æå‡é€Ÿåº¦ï¼‰
    const { data, error } = await db
        .from("components_library")
        .select("*")
        .ilike("item_id", `%${q}%`)
        .limit(200);

    if (error) return;

    if (!data || data.length === 0) {
        itemList.innerHTML = "<div style='color:#aaa;text-align:center;padding:20px;'>ç„¡ç¬¦åˆè³‡æ–™</div>";
        return;
    }

    renderBatch(data);
});
/* ==========================================
   ğŸ“¤ åŒ¯å…¥ Excel / CSVï¼ˆLazy XLSXï¼‰
========================================== */
document.getElementById("importBtn").addEventListener("click", () => {
    document.getElementById("filePicker").click();
});

document.getElementById("filePicker").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    alert("æ­£åœ¨åŒ¯å…¥è³‡æ–™â€¦");

    const ext = file.name.split(".").pop().toLowerCase();
    const buffer = await file.arrayBuffer();
    let json = [];

    try {
        if (ext === "csv") {
            json = csvToJSON(new TextDecoder("utf-8").decode(new Uint8Array(buffer)));
        } else {
            // lazy load XLSX
            const wb = XLSX.read(buffer, { type:"array" });
            const ws = wb.Sheets[wb.SheetNames[0]];
            json = XLSX.utils.sheet_to_json(ws);
        }
    } catch (err) {
        console.error(err);
        alert("æª”æ¡ˆè§£æå¤±æ•—");
        return;
    }

    if (!json.length) {
        alert("æª”æ¡ˆç„¡è³‡æ–™");
        return;
    }

    /* å¿…è¦æ¬„ä½ */
    const required = [
        "æ§‹ä»¶ç·¨è™Ÿ","æ§‹ä»¶è¦æ ¼","æ§‹ä»¶æè³ª",
        "æ§‹ä»¶é‡é‡","æ§‹ä»¶ä½ç½®","æ§‹ä»¶æ•¸é‡"
    ];
    for (let r of required) {
        if (!json[0][r]) return alert("ç¼ºå°‘æ¬„ä½ï¼š" + r);
    }

    /* è½‰æˆè³‡æ–™åº«æ ¼å¼ */
    const insertData = json.map(r => ({
        item_id: String(r["æ§‹ä»¶ç·¨è™Ÿ"]).trim(),
        spec: r["æ§‹ä»¶è¦æ ¼"] || "",
        material: r["æ§‹ä»¶æè³ª"] || "",
        weight: Number(r["æ§‹ä»¶é‡é‡"]) || 0,
        position: r["æ§‹ä»¶ä½ç½®"] || "",
        qty: Number(r["æ§‹ä»¶æ•¸é‡"]) || 1
    }));

    /* å¯«å…¥ Supabase */
    const { error } = await db.from("components_library").upsert(insertData);

    if (error) {
        console.error(error);
        alert("åŒ¯å…¥å¤±æ•—ï¼š" + error.message);
    } else {
        alert("åŒ¯å…¥å®Œæˆï¼");
        // é‡æ–°è¼‰å…¥ï¼ˆreset infinite scrollï¼‰
        offset = 0;
        allLoaded = false;
        itemList.innerHTML = "";
        loadMessage.style.display = "none";
        await loadMetaData();
        await loadNextBatch();
    }

    e.target.value = "";
});

/* ==========================================
   ğŸ“¥ CSV æ¨¡æ¿ä¸‹è¼‰ï¼ˆUTF-8ï¼‰
========================================== */
document.getElementById("downloadCSV").addEventListener("click", () => {
    const header =
        "æ§‹ä»¶ç·¨è™Ÿ,æ§‹ä»¶è¦æ ¼,æ§‹ä»¶æè³ª,æ§‹ä»¶é‡é‡,æ§‹ä»¶ä½ç½®,æ§‹ä»¶æ•¸é‡\n";
    const sample =
        "UV0E3,PL25*500*650,SN490BM,89,32-33/F,1\n" +
        "UV0V1,RH300*300*10*15*5836.8,SN490BM,576,32-33/H,1\n";

    const blob = new Blob([header + sample], { type:"text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "æ§‹ä»¶æ¸…å–®æ¨¡æ¿.csv";
    a.click();
});

/* CSV â†’ JSONï¼ˆUTF-8 safeï¼‰ */
function csvToJSON(csv) {
    const lines = csv.split("\n").map(x => x.trim()).filter(x => x);
    const headers = lines[0].split(",");
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(",");
        const obj = {};
        headers.forEach((h, idx) => obj[h] = row[idx] || "");
        result.push(obj);
    }
    return result;
}

/* ==========================================
   â¬†ï¸ å›åˆ°é ‚ç«¯æŒ‰éˆ•
========================================== */
const backTopBtn = document.getElementById("backTopBtn");

window.addEventListener("scroll", () => {
    if (window.scrollY > 200) {
        backTopBtn.classList.add("visible");
        backTopBtn.style.transform = "scale(1)";
    } else {
        backTopBtn.classList.remove("visible");
        backTopBtn.style.transform = "scale(0.8)";
    }
});

backTopBtn.addEventListener("click", () => {
    window.scrollTo({ top:0, behavior:"smooth" });
});

/* ==========================================
   ğŸš€ åˆå§‹åŒ–ï¼šå…ˆè¼‰ metadata â†’ è¼‰ç¬¬1æ‰¹æ§‹ä»¶
========================================== */
(async () => {
    await loadMetaData();
    await loadNextBatch();  // è®€ 100 ç­†
})();
</script>
</body>
</html>
