<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>進度表</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* 進度表專用樣式 */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      font-size: 22px;
      font-weight: 700;
      color: #fff;
    }

    .select-box {
      width: 92%;
      margin: 0 auto 20px auto;
      padding: 18px;
      background: #1f1f1f;
      border-radius: 14px;
      border: 1px solid #333;
      font-size: 18px;
      color: #ddd;
    }

    .progress-circles {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    .circle-box {
      text-align: center;
      color: #ddd;
    }

    .circle-label {
      margin-top: 10px;
      font-size: 16px;
    }

    .item-card {
      background: #1e1e1e;
      border-radius: 14px;
      padding: 18px;
      margin: 14px auto;
      width: 92%;
      color: #fff;
      font-size: 17px;
      line-height: 1.6;
      border: 1px solid #2d2d2d;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="header-row">
    <span>進度表</span>
    <a href="index.html" class="top-btn">返回主畫面</a>
  </div>

  <!-- 日期篩選 -->
  <select id="dateFilter" class="select-box">
    <option value="all">全部日期</option>
  </select>

  <!-- 進度環 -->
  <div class="progress-circles">
    <div class="circle-box">
      <canvas id="circleReceived" width="120" height="120"></canvas>
      <div class="circle-label" id="receivedLabel">已進料 0/0 (0%)</div>
    </div>

    <div class="circle-box">
      <canvas id="circleUsed" width="120" height="120"></canvas>
      <div class="circle-label" id="usedLabel">已使用 0/0 (0%)</div>
    </div>
  </div>

  <!-- 列表 -->
  <div id="listContainer"></div>

  <script src="back.js"></script>
  <script>
    /***************************
     *  圓形進度環繪製
     ***************************/
    function drawProgress(canvasId, percent) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext("2d");
      const radius = 50;
      const center = 60;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 背景圓
      ctx.beginPath();
      ctx.strokeStyle = "#333";
      ctx.lineWidth = 12;
      ctx.arc(center, center, radius, 0, 2 * Math.PI);
      ctx.stroke();

      // 進度圓
      ctx.beginPath();
      ctx.strokeStyle = "#4da6ff";
      ctx.lineWidth = 12;
      ctx.arc(center, center, radius, -Math.PI / 2, (percent * 2 * Math.PI) - Math.PI / 2);
      ctx.stroke();
    }

    /***************************
     *  主邏輯：抓資料 + 畫 UI
     ***************************/
    async function loadProgress() {
      const components = await db_getAllComponents();   // components_library
      const records = await db_getAllTodayRecords();    // today_records

      // 去除 item_id 重複
      const total = new Set(components.map(x => x.item_id)).size;

      const receivedSet = new Set(
        records.filter(r => r.status === "received").map(r => r.item_id)
      );

      const usedSet = new Set(
        records.filter(r => r.status === "used").map(r => r.item_id)
      );

      const received = receivedSet.size;
      const used = usedSet.size;

      // 更新進度環
      drawProgress("circleReceived", total ? received / total : 0);
      drawProgress("circleUsed", total ? used / total : 0);

      document.getElementById("receivedLabel").textContent =
        `已進料 ${received}/${total} (${((received / total) * 100).toFixed(0)}%)`;

      document.getElementById("usedLabel").textContent =
        `已使用 ${used}/${total} (${((used / total) * 100).toFixed(0)}%)`;

      /*********************
       *   產生列表（排序 B1）
       *********************/
      const sorted = [...components].sort((a, b) => {
        if (a.item_id < b.item_id) return -1;
        if (a.item_id > b.item_id) return 1;
        return (a.position || "").localeCompare(b.position || "");
      });

      const list = document.getElementById("listContainer");
      list.innerHTML = "";

      sorted.forEach(c => {
        const recR = records.find(r => r.item_id === c.item_id && r.status === "received");
        const recU = records.find(r => r.item_id === c.item_id && r.status === "used");

        const receivedDate = recR ? (recR.usedAt || "-") : "-";
        const usedDate = recU ? (recU.usedAt || "-") : "-";

        const card = document.createElement("div");
        card.className = "item-card";
        card.innerHTML = `
          <div style="font-size:20px;font-weight:600">${c.item_id}</div>
          <div>${c.position || "-"}</div>
          <div>${receivedDate}</div>
          <div>${usedDate}</div>
        `;
        list.appendChild(card);
      });
    }

    loadProgress();
  </script>

</body>
</html>
