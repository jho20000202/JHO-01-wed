<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>進度表</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
  </head>
  <body>
    <div class="section">
      <div class="card">
        <div class="row" style="flex-wrap:wrap;">
          <div class="app-title">進度表</div>
          <a class="btn" href="index.html">返回主畫面</a>
        </div>
        <div class="row" style="gap:8px; flex-wrap:nowrap; overflow-x:auto; margin-top:8px;">
          <select id="dateSel" class="btn" style="min-width:160px; flex:0 0 auto"></select>
          <button id="applyDate" class="btn" style="flex:0 0 auto">套用</button>
        </div>


        <div class="row" style="margin-top:12px; gap:12px; flex-wrap:wrap; justify-content:center;">
          <div style="display:flex; flex-direction:column; align-items:center;">
            <canvas id="chartReceived" width="112" height="112"></canvas>
            <div class="muted" id="labelReceived" style="margin-top:6px;">已進料 0/0 (0%)</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:center;">
            <canvas id="chartUsed" width="112" height="112"></canvas>
            <div class="muted" id="labelUsed" style="margin-top:6px;">已使用 0/0 (0%)</div>
          </div>
        </div>

        <div id="progressBars" class="prog" style="margin-top:8px;"></div>

        

        <div id="progressList" class="list" style="margin-top:8px;"></div>
      </div>
    </div>
    

    <script src="back.js"></script>
    <script src="vendor/xlsx.full.min.js"></script>
    <script>
      function get(k,f){ try { return JSON.parse(localStorage.getItem(k)) ?? f } catch { return f } }
      function set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
      const today=()=>{ const arr=get('todayRecords', []); const d=window.__selectedDate||''; return d? arr.filter(r=>String(r.plannedAt||'')===d) : arr; };
      const libs=()=>get('componentsLibrary', []);
      const planned=()=>get('plannedItems', []);
      const used=()=>{ const arr=get('usedRecords', []); const d=window.__selectedDate||''; return d? arr.filter(u=>String(u.usedAtDate||'')===d) : arr; };
      const isDate=(s)=>/^\d{4}-\d{2}-\d{2}$/.test(String(s||''));

      function render(){
        const list=document.getElementById('progressList'); list.innerHTML='';
        const t=today();
        const stat=new Map(t.map(r=>[String(r.id), r]));
        const all=libs().slice().sort((a,b)=>String(a.id).localeCompare(String(b.id)));
        if(all.length===0){ list.innerHTML='<div class="muted">構件庫為空</div>'; renderCharts(); renderBars(); return; }
        all.forEach(item=>{
          const s=stat.get(String(item.id));
          const row=document.createElement('div'); row.className='list-item';
          const zhStatus = s?.status==='received' ? '已進料' : (s?.status==='scheduled' ? '預定中' : (s?.status==='pending' ? '未進料' : (s?.status==='used' ? '已使用' : '-')));
          const dateForStatus = (function(){
            const dSel = window.__selectedDate || '';
            if(s?.status==='received') return dSel || (s?.plannedAt||'');
            if(s?.status==='scheduled' || s?.status==='pending') return s?.plannedAt || '';
            return s?.plannedAt || '';
          })();
          row.innerHTML=`
            <div>${item.id}</div>
            <div class="muted">${item.position||'-'}</div>
            <div class="muted">${zhStatus}</div>
            <div class="muted">${dateForStatus||'-'}</div>
          `;
          list.appendChild(row);
          });
          renderCharts();
          renderBars();
        }

      function renderCharts(){
        const num = (v)=>{ const n=Number(String(v??'').replace(/,/g,'')); return Number.isFinite(n)? n : 0; };
        const libsArr = libs();
        const totalQty = libsArr.reduce((s,i)=> s + num(i?.quantity), 0);
        const recKeys = new Set(today().filter(r=>r.status==='received').map(r=> `${String(r.id)}|${String(r.position||'')}`));
        const recQty = libsArr.reduce((s,i)=> s + (recKeys.has(`${String(i.id)}|${String(i.position||'')}`) ? num(i?.quantity) : 0), 0);
        const usedQtyRaw = (used()||[]).reduce((s,u)=> s + num(u?.qty ?? u?.quantity ?? u?.usedQty), 0);
        const usedQty = Math.min(usedQtyRaw, totalQty);

        const recRemain = Math.max(totalQty - recQty, 0);
        const usedRemain = Math.max(totalQty - usedQty, 0);

        const recPercent = totalQty? Math.round(recQty*100/totalQty) : 0;
        const usedPercent = totalQty? Math.round(usedQty*100/totalQty) : 0;

        const lr = document.getElementById('labelReceived');
        const lu = document.getElementById('labelUsed');
        if(lr) lr.textContent = `已進料 ${recQty}/${totalQty} (${recPercent}%)`;
        if(lu) lu.textContent = `已使用 ${usedQty}/${totalQty} (${usedPercent}%)`;

        const ctxR = document.getElementById('chartReceived')?.getContext('2d');
        const ctxU = document.getElementById('chartUsed')?.getContext('2d');
        const cfgR = {
          type: 'doughnut',
          data: { datasets: [{ data: [recQty, recRemain], backgroundColor: ['#2f80ed', 'rgba(154,160,166,0.28)'], borderWidth: 0 }] },
          options: { plugins: { legend: { display: false } }, cutout: '70%', responsive: false }
        };
        const cfgU = {
          type: 'doughnut',
          data: { datasets: [{ data: [usedQty, usedRemain], backgroundColor: ['#27ae60', 'rgba(154,160,166,0.28)'], borderWidth: 0 }] },
          options: { plugins: { legend: { display: false } }, cutout: '70%', responsive: false }
        };
        if(ctxR){ if(!window._chartReceived){ window._chartReceived = new Chart(ctxR, cfgR); } else { window._chartReceived.data.datasets[0].data=[recQty,recRemain]; window._chartReceived.update(); } }
        if(ctxU){ if(!window._chartUsed){ window._chartUsed = new Chart(ctxU, cfgU); } else { window._chartUsed.data.datasets[0].data=[usedQty,usedRemain]; window._chartUsed.update(); } }
      }

      
      (function setupDate(){
        const dates = Array.from(new Set([
          ...get('plannedItems', []).map(p=>p.plannedAt).filter(isDate),
          ...get('todayRecords', []).map(r=>r.plannedAt).filter(isDate)
        ])).sort();
        const sel=document.getElementById('dateSel'); const btn=document.getElementById('applyDate');
        if(sel){ sel.innerHTML='<option value="">全部日期</option>'+dates.map(d=>`<option value="${d}">${d}</option>`).join(''); }
        if(btn){ btn.addEventListener('click',()=>{ window.__selectedDate = sel?.value || ''; render(); }); }
      })();

      

      render();
      
    </script>
  </body>
</html>
      function renderBars(){
        const barsEl=document.getElementById('progressBars'); if(!barsEl) return;
        const comps=libs();
        const num=(v)=>{ const n=Number(String(v??'').replace(/,/g,'')); return Number.isFinite(n)?n:0; };
        const totalQty=comps.reduce((s,c)=> s + num(c?.quantity), 0);
        const key=(x)=>`${String(x.id)}|${String(x.position||'')}`;
        const recKeys=new Set(today().filter(r=>r.status==='received').map(key));
        const recQty=comps.reduce((s,i)=> s + (recKeys.has(key(i))? num(i?.quantity):0), 0);
        const usedQtyRaw=(used()||[]).reduce((s,u)=> s + num(u?.qty??u?.quantity??u?.usedQty), 0);
        const usedQty=Math.min(usedQtyRaw,totalQty);
        const mkBar=(label, cls, numv, denom)=>{
          const row=document.createElement('div'); row.className='bar-row';
          const pct = denom>0 ? Math.min(100, Math.max(0, numv/denom*100)) : 0;
          row.innerHTML=`<div class="muted" style="min-width:96px">${label}</div><div class="bar"><div class="fill ${cls}" style="width:${pct.toFixed(2)}%"></div></div><div class="muted" style="min-width:160px;text-align:right">${numv} / ${denom}</div>`;
          return row;
        };
        barsEl.innerHTML='';
        barsEl.appendChild(mkBar('已進料進度','received',recQty,totalQty));
        barsEl.appendChild(mkBar('已使用進度','used',usedQty,totalQty));
      }
