<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é€²åº¦è¡¨</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* é€²åº¦è¡¨å°ˆç”¨æ¨£å¼ */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      font-size: 22px;
      font-weight: 700;
      color: #fff;
    }

    .select-box {
      width: 92%;
      margin: 0 auto 20px auto;
      padding: 18px;
      background: #1f1f1f;
      border-radius: 14px;
      border: 1px solid #333;
      font-size: 18px;
      color: #ddd;
    }

    .progress-circles {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    .circle-box {
      text-align: center;
      color: #ddd;
    }

    .circle-label {
      margin-top: 10px;
      font-size: 16px;
    }

    .item-card {
      background: #1e1e1e;
      border-radius: 14px;
      padding: 18px;
      margin: 14px auto;
      width: 92%;
      color: #fff;
      font-size: 17px;
      line-height: 1.6;
      border: 1px solid #2d2d2d;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="header-row">
    <span>é€²åº¦è¡¨</span>
    <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
  </div>

  <!-- æœå°‹èˆ‡æ’åº -->
  <div class="controls-area" style="width: 92%; margin: 0 auto 20px auto; display: flex; gap: 10px; flex-wrap: wrap;">
    <input type="text" id="searchInput" placeholder="æœå°‹æ§‹ä»¶ç·¨è™Ÿæˆ–ä½ç½®..." oninput="this.value = this.value.toUpperCase()"
      style="flex: 1; padding: 14px; background: #1f1f1f; border: 1px solid #333; border-radius: 14px; color: #fff; font-size: 16px; text-transform: uppercase;">

    <select id="sortSelect"
      style="padding: 14px; background: #1f1f1f; border: 1px solid #333; border-radius: 14px; color: #fff; font-size: 16px;">
      <option value="default">é è¨­æ’åº</option>
      <option value="planned">æ ¹æ“šé å®šæ™‚é–“</option>
      <option value="received">æ ¹æ“šç°½æ”¶æ™‚é–“</option>
      <option value="used">æ ¹æ“šåŠè£æ™‚é–“</option>
    </select>
  </div>

  <!-- é€²åº¦ç’° -->
  <div class="progress-circles">
    <div class="circle-box">
      <canvas id="circleReceived" width="120" height="120"></canvas>
      <div class="circle-label" id="receivedLabel">å·²é€²æ–™ 0/0 (0%)</div>
    </div>

    <div class="circle-box">
      <canvas id="circleUsed" width="120" height="120"></canvas>
      <div class="circle-label" id="usedLabel">å·²ä½¿ç”¨ 0/0 (0%)</div>
    </div>
  </div>

  <!-- åˆ—è¡¨ -->
  <div id="listContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="back.js?v=2"></script>
  <script>
    /***************************
     *  åœ“å½¢é€²åº¦ç’°ç¹ªè£½
     ***************************/
    function drawProgress(canvasId, percent) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext("2d");
      const radius = 50;
      const center = 60;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // èƒŒæ™¯åœ“
      ctx.beginPath();
      ctx.strokeStyle = "#333";
      ctx.lineWidth = 12;
      ctx.arc(center, center, radius, 0, 2 * Math.PI);
      ctx.stroke();

      // é€²åº¦åœ“
      ctx.beginPath();
      ctx.strokeStyle = "#4da6ff";
      ctx.lineWidth = 12;
      ctx.arc(center, center, radius, -Math.PI / 2, (percent * 2 * Math.PI) - Math.PI / 2);
      ctx.stroke();
    }

    /***************************
     *  ä¸»é‚è¼¯ï¼šæŠ“è³‡æ–™ + ç•« UI
     ***************************/
    let allItems = []; // Store all processed items for filtering/sorting

    async function loadProgress() {
      const components = await db_read("components_library");
      const records = await db_read("today_records");
      const planned = await db_read("planned_items");

      // è¨ˆç®—ç¸½æ•¸é‡ï¼ˆç´¯åŠ æ‰€æœ‰æ§‹ä»¶çš„ qtyï¼‰
      const total = components.reduce((sum, x) => sum + (x.qty || 0), 0);

      // è¨ˆç®—å·²é€²æ–™æ•¸é‡ï¼ˆå¾ planned_items ä¸­ç´¯åŠ  received_qtyï¼‰
      const receivedQty = planned
        .filter(p => p.status === "received")
        .reduce((sum, p) => sum + (p.received_qty || 0), 0);

      // è¨ˆç®—å·²ä½¿ç”¨æ•¸é‡ï¼ˆå¾ today_records ä¸­ç´¯åŠ  qtyï¼‰
      const usedQty = records
        .filter(r => r.status === "used")
        .reduce((sum, r) => sum + (r.qty || 0), 0);

      // æ›´æ–°é€²åº¦ç’°
      drawProgress("circleReceived", total ? receivedQty / total : 0);
      drawProgress("circleUsed", total ? usedQty / total : 0);

      document.getElementById("receivedLabel").textContent =
        `å·²é€²æ–™ ${receivedQty}/${total} (${total ? ((receivedQty / total) * 100).toFixed(0) : 0}%)`;

      document.getElementById("usedLabel").textContent =
        `å·²ä½¿ç”¨ ${usedQty}/${total} (${total ? ((usedQty / total) * 100).toFixed(0) : 0}%)`;

      // Process all items first
      allItems = components.map(c => {
        const planRec = planned.find(p => p.item_id === c.item_id && p.position === c.position);
        const actualRec = records.find(r => r.item_id === c.item_id && r.position === c.position);

        let plannedDate = planRec ? planRec.planned_date : null;
        let receivedTime = null;
        let usedTime = null;

        if (actualRec) {
          // For received items, use received_at as the received timestamp
          if (actualRec.status === 'received' && actualRec.received_at) {
            receivedTime = actualRec.received_at;
          }
          // For used items, they were also received, so show both times
          if (actualRec.status === 'used') {
            receivedTime = actualRec.received_at || actualRec.used_at; // Use received_at if available, fallback to used_at
            usedTime = actualRec.used_at;
          }
        }

        return {
          ...c,
          plannedDate,
          receivedTime,
          usedTime,
          displayPlanned: plannedDate || "å°šæœªæ’ç¨‹",
          displayReceived: receivedTime ? new Date(receivedTime).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : "-",
          displayUsed: usedTime ? new Date(usedTime).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : "-"
        };
      });

      renderList();
    }

    function renderList() {
      const searchText = document.getElementById("searchInput").value.toLowerCase();
      const sortMode = document.getElementById("sortSelect").value;

      // Filter
      let filtered = allItems.filter(item => {
        return (item.item_id || "").toLowerCase().includes(searchText) ||
          (item.position || "").toLowerCase().includes(searchText);
      });

      // Sort
      filtered.sort((a, b) => {
        if (sortMode === 'default') {
          if (a.item_id < b.item_id) return -1;
          if (a.item_id > b.item_id) return 1;
          return (a.position || "").localeCompare(b.position || "");
        } else if (sortMode === 'planned') {
          return (b.plannedDate || "").localeCompare(a.plannedDate || "");
        } else if (sortMode === 'received') {
          return (b.receivedTime || "").localeCompare(a.receivedTime || "");
        } else if (sortMode === 'used') {
          return (b.usedTime || "").localeCompare(a.usedTime || "");
        }
        return 0;
      });

      const list = document.getElementById("listContainer");
      list.innerHTML = "";

      filtered.forEach(c => {
        const card = document.createElement("div");
        card.className = "item-card";
        card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-size:22px; font-weight:700; color:#fff;">${c.item_id}</div>
                <div style="font-size:16px; color:#aaa; background:#333; padding:4px 10px; border-radius:8px;">${c.position || "ç„¡ä½ç½®"}</div>
              </div>

              <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; font-size:14px; text-align:center;">
                <div style="background:#2a2a2a; padding:8px; border-radius:8px;">
                    <div style="color:#aaa; margin-bottom:4px;">ğŸ“… é å®š</div>
                    <div style="color:#fff;">${c.displayPlanned}</div>
                </div>
                <div style="background:#2a2a2a; padding:8px; border-radius:8px;">
                    <div style="color:#aaa; margin-bottom:4px;">ğŸ“¥ ç°½æ”¶</div>
                    <div style="color:#4da6ff;">${c.displayReceived}</div>
                </div>
                <div style="background:#2a2a2a; padding:8px; border-radius:8px;">
                    <div style="color:#aaa; margin-bottom:4px;">ğŸ—ï¸ åŠè£</div>
                    <div style="color:#27ae60;">${c.displayUsed}</div>
                </div>
              </div>
            `;
        list.appendChild(card);
      });
    }

    // Event Listeners
    document.getElementById("searchInput").addEventListener("input", renderList);
    document.getElementById("sortSelect").addEventListener("change", renderList);

    loadProgress();
  </script>

  <script src="backToTop.js"></script>
</body>

</html>
