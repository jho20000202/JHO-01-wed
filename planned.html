<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é è¨ˆé€²æ–™</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
/* æ—¥æœŸåˆ†çµ„æ¨™é¡Œ */
.group-title {
    font-size: 18px;
    font-weight: 700;
    margin: 20px 0 10px;
    color: #fff;
}

/* å¡ç‰‡ */
.plan-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
    cursor:pointer;
    transition:background 0.2s;
}
.plan-card:hover { background:#222b3b; }

.card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.plan-status {
    font-size:14px;
    opacity:0.8;
}

/* å±•é–‹é¢æ¿ */
.plan-details {
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #2a3142;
    display:none;
}
.detail-sub {
    font-size:14px;
    color:#bbb;
    margin:6px 0;
}

.receive-btn {
    margin-top:10px;
    padding:10px;
    width:100%;
    text-align:center;
    background:#27ae60;
    border-radius:10px;
    font-weight:700;
}

/* Loading åœˆåœˆ */
#loadingSpinner {
    display:none;
    text-align:center;
    padding:14px;
}
#loadingSpinner svg {
    width:28px;
    height:28px;
    animation: spin 0.9s linear infinite;
}
@keyframes spin {
    from { transform:rotate(0deg); }
    to   { transform:rotate(360deg); }
}

/* å·²è¼‰å…¥å…¨éƒ¨ */
#loadMessage {
    color:#aaa;
    text-align:center;
    padding:12px;
    display:none;
}

/* å›åˆ°é ‚ç«¯ */
#backTopBtn {
    position: fixed;
    right: 18px;
    bottom: 22px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(6px);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;

    opacity: 0;
    pointer-events: none;

    transition:
        opacity 0.3s ease,
        transform 0.25s ease,
        bottom 0.25s ease;
}

#backTopBtn.visible {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
}

#backTopBtn svg {
    width: 22px;
    height: 22px;
    fill: #fff;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">é è¨ˆé€²æ–™</div>
    <div class="top-bar-actions">
        <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
    </div>
</div>

<div class="screen-card">

    <!-- æœå°‹ -->
    <div class="section-title">æœå°‹</div>
    <input id="searchBox" class="input-bar" placeholder="æœå°‹ï¼šç·¨è™Ÿ / è¦æ ¼ / ä½ç½®">

    <!-- æ’åºæ–¹å¼ -->
    <div class="section-title">æ’åºæ–¹å¼</div>
    <select id="sortSelect" class="input-bar">
        <option value="date_asc">æ—¥æœŸï¼ˆè¿‘ â†’ é ï¼‰</option>
        <option value="date_desc">æ—¥æœŸï¼ˆé  â†’ è¿‘ï¼‰</option>
        <option value="id_asc">æ§‹ä»¶ç·¨è™Ÿï¼ˆA â†’ Zï¼‰</option>
        <option value="id_desc">æ§‹ä»¶ç·¨è™Ÿï¼ˆZ â†’ Aï¼‰</option>
    </select>

</div>

<div class="screen-card">
    <div class="section-title">é è¨ˆé€²æ–™åˆ—è¡¨</div>

    <div id="planList"></div>

    <div id="loadingSpinner">
        <svg viewBox="0 0 24 24">
            <path fill="#ccc" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>

    <div id="loadMessage">å·²è¼‰å…¥å…¨éƒ¨è³‡æ–™</div>
</div>

<!-- å›åˆ°é ‚ç«¯ -->
<div id="backTopBtn">
    <svg viewBox="0 0 24 24">
        <path d="M12 4l-8 8h5v8h6v-8h5z"></path>
    </svg>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="planned.js"></script>

</body>
</html>
/* ==========================================
   ğŸ”§ Supabase åˆå§‹åŒ–
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   ğŸ“Œ å…¨åŸŸè®Šæ•¸
========================================== */
let plans = [];           // planned_items
let components = [];      // components_libraryï¼ˆç‚ºé¡¯ç¤ºè©³ç´°è³‡è¨Šï¼‰
let offset = 0;           // Infinite Scroll ä½ç½®
let limit = 50;           // æ¯æ‰¹è¼‰å…¥ 50
let loading = false;
let allLoaded = false;

let currentSort = "date_asc";  // é è¨­ï¼šæ—¥æœŸè¿‘â†’é 
let searchKeyword = "";        // æœå°‹ç”¨

const planList       = document.getElementById("planList");
const loadingSpinner = document.getElementById("loadingSpinner");
const loadMessage    = document.getElementById("loadMessage");

/* ==========================================
   Step 1ï¼šè¼‰å…¥è³‡æ–™åº«
========================================== */
async function loadMetaData() {

    // 1. planned_items
    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .order("date", { ascending: true });

    plans = plan || [];

    // 2. components_library
    const { data: comp } = await db
        .from("components_library")
        .select("*");

    components = comp || [];
}

/* ==========================================
   Step 2ï¼šä¸»æ‰¹æ¬¡è¼‰å…¥ï¼ˆä¾æ’åºã€æœå°‹ï¼‰
========================================== */
async function loadNextBatch() {

    if (loading || allLoaded) return;
    loading = true;
    loadingSpinner.style.display = "block";

    let filtered = [...plans];

    /* ğŸ” æœå°‹ï¼šç·¨è™Ÿ / è¦æ ¼ / ä½ç½® */
    if (searchKeyword) {
        const q = searchKeyword.toLowerCase();
        filtered = filtered.filter(p => {

            const comp = components.find(c => c.item_id === p.item_id);

            return (
                p.item_id.toLowerCase().includes(q) ||
                (comp?.spec || "").toLowerCase().includes(q) ||
                (comp?.position || "").toLowerCase().includes(q)
            );
        });
    }

    /* ğŸ”½ æ’åº */
    if (currentSort === "date_asc") {
        filtered.sort((a,b) => new Date(a.date) - new Date(b.date));
    } else if (currentSort === "date_desc") {
        filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
    } else if (currentSort === "id_asc") {
        filtered.sort((a,b) => a.item_id.localeCompare(b.item_id));
    } else if (currentSort === "id_desc") {
        filtered.sort((a,b) => b.item_id.localeCompare(a.item_id));
    }

    /* å–å‡ºæ­¤æ¬¡è¦é¡¯ç¤ºçš„ */
    const slice = filtered.slice(offset, offset + limit);

    if (slice.length === 0) {
        allLoaded = true;
        loadingSpinner.style.display = "none";
        loadMessage.style.display = "block";
        loading = false;
        return;
    }

    renderBatch(slice);   // ç¬¬ 3 æ®µæ‰æœƒå®šç¾©

    offset += limit;
    loading = false;
    loadingSpinner.style.display = "none";
}

/* ==========================================
   Step 3ï¼šæœå°‹æ¡†äº‹ä»¶ï¼ˆé‡æ–°è¼‰å…¥ï¼‰
========================================== */
document.getElementById("searchBox").addEventListener("input", async (e) => {
    searchKeyword = e.target.value.trim();

    resetList();
    await loadNextBatch();
});

/* ==========================================
   Step 4ï¼šæ’åºäº‹ä»¶
========================================== */
document.getElementById("sortSelect").addEventListener("change", async (e) => {
    currentSort = e.target.value;

    resetList();
    await loadNextBatch();
});

/* ==========================================
   Step 5ï¼šInfinite Scroll
========================================== */
window.addEventListener("scroll", async () => {

    if (allLoaded || loading) return;

    const nearBottom =
        window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;

    if (nearBottom) {
        await loadNextBatch();
    }
});

/* ==========================================
   å·¥å…·ï¼šé‡ç½®åˆ—è¡¨
========================================== */
function resetList() {
    offset = 0;
    allLoaded = false;
    planList.innerHTML = "";
    loadMessage.style.display = "none";
}
/* ==========================================
   Step 6ï¼šæ¸²æŸ“ä¸€æ‰¹ï¼ˆä¾æ—¥æœŸè‡ªå‹•åˆ†çµ„ï¼‰
========================================== */
function renderBatch(records) {

    let lastDate = null;

    records.forEach(p => {

        const comp = components.find(c => c.item_id === p.item_id) || {};
        const status = p.status === "received" ? "green" : "grey";
        const shortStatus = p.status === "received" ? "å·²æ”¶è²¨" : "æœªæ”¶";

        /* éœ€è¦æ–°æ—¥æœŸæ¨™é¡Œï¼Ÿ */
        if (p.date !== lastDate) {

            const dateHeader = `
                <div class="section-title" style="margin-top:16px;">
                    ${p.date}
                </div>
            `;

            planList.insertAdjacentHTML("beforeend", dateHeader);
            lastDate = p.date;
        }

        /* å¡ç‰‡ ID */
        const cardId = "details_" + p.item_id + "_" + p.date.replace(/-/g, "");

        const html = `
            <div class="item-card">

                <!-- ======================
                     ä¸Šå±¤ Header
                ======================= -->
                <div class="item-header" onclick="toggleDetails('${cardId}')">
                    <div class="item-id">${p.item_id}</div>

                    <div class="status-text">
                        <span class="status-dot ${status === "green" ? "dot-green" : "dot-grey"}"></span>
                        ${shortStatus}
                    </div>
                </div>

                <!-- ======================
                     å±•é–‹å…§å®¹
                ======================= -->
                <div id="${cardId}" class="item-details">

                    <div class="item-sub">${comp.spec || ""}</div>
                    <div class="item-sub">æè³ªï¼š${comp.material || ""}</div>
                    <div class="item-sub">ä½ç½®ï¼š${comp.position || ""}</div>
                    <div class="item-sub">é‡é‡ï¼š${comp.weight || ""}</div>
                    <div class="item-sub">æ•¸é‡ï¼š${comp.qty || 1}</div>

                    <!-- æ¨™è¨˜å·²æ”¶è²¨æŒ‰éˆ• -->
                    <div class="primary-btn full" style="margin-top:12px;"
                        onclick="markReceived('${p.item_id}', '${p.date}')">
                        æ¨™è¨˜ç‚ºã€Œå·²æ”¶è²¨ã€
                    </div>

                </div>
            </div>
        `;

        planList.insertAdjacentHTML("beforeend", html);
    });
}

/* ==========================================
   Step 7ï¼šå±•é–‹/æ”¶åˆæ˜ç´°
========================================== */
function toggleDetails(id) {
    const el = document.getElementById(id);
    const btn = document.getElementById("backTopBtn");

    if (el.style.display === "block") {
        el.style.display = "none";
        btn.style.bottom = "22px";
    } else {
        el.style.display = "block";
        btn.style.bottom = "90px";
    }
}

/* ==========================================
   Step 8ï¼šæ¨™è¨˜ã€Œå·²æ”¶è²¨ã€
   â†’ å¯«å…¥ today_records
   â†’ æ›´æ–° planned_items.status = 'received'
========================================== */
async function markReceived(item_id, date) {

    if (!confirm(`ç¢ºå®šå°‡ ${item_id} æ¨™è¨˜ç‚ºå·²æ”¶è²¨ï¼Ÿ`)) return;

    /* 1. today_records æ–°å¢ä¸€ç­† */
    await db.from("today_records").upsert({
        item_id: item_id,
        date: date
    });

    /* 2. planned_items.status æ”¹ç‚º received */
    await db.from("planned_items")
        .update({ status: "received" })
        .eq("item_id", item_id)
        .eq("date", date);

    alert("å·²æ¨™è¨˜ç‚ºå·²æ”¶è²¨ï¼");

    /* é‡æ–°è¼‰å…¥ */
    resetList();
    await loadMetaData();
    await loadNextBatch();
}
/* ==========================================
   Step 9ï¼šæœå°‹ï¼ˆåŒ library é‚è¼¯ï¼‰
========================================== */
document.getElementById("searchBox").addEventListener("input", async (e) => {

    const q = e.target.value.trim().toLowerCase();

    planList.innerHTML = "";
    loadMessage.style.display = "none";

    if (!q) {
        /* å›åˆ° Infinite Scroll */
        offset = 0;
        allLoaded = false;
        await loadNextBatch();
        return;
    }

    const { data, error } = await db
        .from("planned_items")
        .select("*")
        .or(`item_id.ilike.%${q}%,date.ilike.%${q}%`)
        .order("date", { ascending: true })
        .limit(200);

    if (error) return console.error(error);

    if (!data.length) {
        planList.innerHTML =
            "<div style='color:#aaa;text-align:center;padding:20px;'>æŸ¥ç„¡è³‡æ–™</div>";
        return;
    }

    renderBatch(data);
});


/* ==========================================
   Step 10ï¼šå›åˆ°é ‚ç«¯æŒ‰éˆ•
========================================== */
const backTopBtn = document.getElementById("backTopBtn");

window.addEventListener("scroll", () => {
    if (window.scrollY > 300) {
        backTopBtn.classList.add("visible");
        backTopBtn.style.transform = "scale(1)";
    } else {
        backTopBtn.classList.remove("visible");
        backTopBtn.style.transform = "scale(0.7)";
    }
});

backTopBtn.addEventListener("click", () => {
    window.scrollTo({ top:0, behavior:"smooth" });
});


/* ==========================================
   Step 11ï¼šInfinite Scrollï¼ˆæ»‘åˆ°åº•è‡ªå‹•è¼‰å…¥ï¼‰
========================================== */
window.addEventListener("scroll", async () => {
    if (allLoaded || loading) return;

    const nearBottom =
        window.innerHeight + window.scrollY >= document.body.offsetHeight - 180;

    if (nearBottom) {
        await loadNextBatch();
    }
});


/* ==========================================
   Step 12ï¼šReset Listï¼ˆåˆ†é¡/æœå°‹å¾Œéœ€è¦ï¼‰
========================================== */
function resetList() {
    offset = 0;
    allLoaded = false;
    planList.innerHTML = "";
    loadMessage.style.display = "none";
}


/* ==========================================
   ğŸš€ Step 13ï¼šåˆå§‹åŒ–
========================================== */
(async () => {
    await loadMetaData();     // è¼‰å…¥ planned_items + today_records
    await loadComponents();   // è¼‰å…¥ components_libraryï¼ˆçµ¦æ˜ç´°ç”¨ï¼‰
    await loadNextBatch();    // ç¬¬ä¸€æ‰¹
})();
