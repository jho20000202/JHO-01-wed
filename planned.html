<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é è¨ˆé€²æ–™ç™»è¨˜</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
/* å¡ç‰‡æ¨£å¼ï¼ˆæ²¿ç”¨ä½ çš„æ·±è‰²é¢¨æ ¼ï¼‰ */
.plan-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
}

.plan-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.position-select {
    width:100%;
    padding:12px;
    border-radius:14px;
    background:#1e2737;
    color:#fff;
    margin-top:10px;
    font-size:15px;
    border:1px solid #2a2f3a;
}

/* Loading */
#loadingSpinner {
    display:none;
    text-align:center;
    padding:16px;
}
#loadingSpinner svg {
    width:28px;
    height:28px;
    animation: spin 0.9s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
}

#loadMessage {
    display:none;
    color:#aaa;
    text-align:center;
    padding:16px;
}

/* ===== æ·±è‰²å°å‹å½ˆå‡ºæ—¥æ›† ===== */
#calendarOverlay {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 2000;
}

#calendarPanel {
    position:absolute;
    background:#1c2433;
    padding:14px;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.7);
    width:280px;
    color:#fff;
    font-size:14px;
    animation: calFadeIn .18s ease-out;
}

@keyframes calFadeIn {
    from { opacity:0; transform:scale(.95); }
    to   { opacity:1; transform:scale(1); }
}

.calendar-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
}

.calendar-header-title {
    font-weight:600;
}

.cal-nav-btn {
    background:#2f7dff;
    border-radius:999px;
    padding:4px 10px;
    font-size:13px;
}

.calendar-grid {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
}

.day-name {
    text-align:center;
    color:#9aa0a6;
    font-size:12px;
}

.day-cell {
    text-align:center;
    padding:7px 0;
    border-radius:10px;
    background:#141a28;
    cursor:pointer;
    font-size:13px;
}

.day-cell:hover {
    background:#2f7dff;
}

.day-disabled {
    opacity:.15;
    pointer-events:none;
}
</style>
</head>

<body>

<!-- é ‚éƒ¨åˆ— -->
<div class="top-bar">
    <div class="top-bar-title">é è¨ˆé€²æ–™ç™»è¨˜</div>
    <a href="index.html" class="top-btn">è¿”å›ä¸»ç•«é¢</a>
</div>

<!-- è¼¸å…¥å€ -->
<div class="screen-card">

    <div class="section-title">æ§‹ä»¶ç·¨è™Ÿ</div>
    <input id="itemIdInput" class="input-bar" placeholder="ä¾‹å¦‚ A-001">

    <div class="section-title">é è¨ˆåˆ°è²¨æ—¥æœŸ</div>
    <!-- ç”¨æ–‡å­—è¼¸å…¥æ¡† + è‡ªè£½æ—¥æ›† -->
    <input id="dateInput"
           class="input-bar"
           placeholder="é»æ“Šé¸æ“‡æ—¥æœŸ"
           readonly
           style="cursor:pointer;background:#1c2433;">

    <button id="submitBtn" class="primary-btn full" style="margin-top:12px;">
        é€å‡º
    </button>
</div>

<!-- æ¸…å–®å€ -->
<div class="screen-card">
    <div class="section-title">ç›®å‰é è¨ˆé€²æ–™æ¸…å–®</div>

    <div id="planList"></div>

    <div id="loadingSpinner">
        <svg viewBox="0 0 24 24">
            <path fill="#ccc" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>

    <div id="loadMessage">å·²è¼‰å…¥å…¨éƒ¨è³‡æ–™</div>
</div>

<!-- å°å‹æ·±è‰²æ—¥æ›†ï¼ˆè¦†è“‹å±¤ + é¢æ¿ï¼‰ -->
<div id="calendarOverlay">
    <div id="calendarPanel">
        <div class="calendar-header">
            <button id="calPrev" class="cal-nav-btn">ã€ˆ</button>
            <div id="calTitle" class="calendar-header-title">2025 / 01</div>
            <button id="calNext" class="cal-nav-btn">ã€‰</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
    </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ==========================================
   ğŸ”§ Supabase åˆå§‹åŒ–
========================================== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==========================================
   ğŸ“Œ å…¨åŸŸè³‡æ–™
========================================== */
let plans = [];        // planned_itemsï¼ˆæœªæ”¶è²¨ï¼‰
let components = [];   // components_library
let usedPositions = {}; // { item_id: Set(positions) }

const planList       = document.getElementById("planList");
const loadingSpinner = document.getElementById("loadingSpinner");
const loadMessage    = document.getElementById("loadMessage");

/* ==========================================
   æ·±è‰²å°æ—¥æ›†ï¼šUI æ§åˆ¶
========================================== */
const dateInput   = document.getElementById("dateInput");
const calOverlay  = document.getElementById("calendarOverlay");
const calPanel    = document.getElementById("calendarPanel");
const calGrid     = document.getElementById("calendarGrid");
const calTitle    = document.getElementById("calTitle");
const calPrevBtn  = document.getElementById("calPrev");
const calNextBtn  = document.getElementById("calNext");

let calCurrent = new Date();
calCurrent.setDate(1);

/* æ‰“é–‹æ—¥æ›†ï¼ˆå®šä½åœ¨è¼¸å…¥æ¡†ä¸‹æ–¹ï¼‰ */
function openCalendar() {
    const rect = dateInput.getBoundingClientRect();
    calOverlay.style.display = "block";

    const panelWidth = 280;
    let left = rect.left + window.scrollX;
    const top  = rect.bottom + window.scrollY + 6;

    if (left + panelWidth + 8 > window.innerWidth + window.scrollX) {
        left = window.innerWidth + window.scrollX - panelWidth - 8;
    }

    calPanel.style.top  = top + "px";
    calPanel.style.left = left + "px";

    renderCalendar();
}

/* é—œé–‰æ—¥æ›† */
function closeCalendar() {
    calOverlay.style.display = "none";
}

/* é»è¼¸å…¥æ¡†é–‹å•Ÿ */
dateInput.addEventListener("click", openCalendar);

/* é»è¦†è“‹å±¤ç©ºç™½é—œé–‰ï¼ˆé¿å…é»åˆ° panelï¼‰ */
calOverlay.addEventListener("click", (e)=>{
    if (e.target === calOverlay) closeCalendar();
});

/* æœˆä»½åˆ‡æ› */
calPrevBtn.addEventListener("click", ()=>{
    calCurrent.setMonth(calCurrent.getMonth() - 1);
    renderCalendar();
});
calNextBtn.addEventListener("click", ()=>{
    calCurrent.setMonth(calCurrent.getMonth() + 1);
    renderCalendar();
});

/* ç•«å‡ºæ•´å€‹æœˆä»½ */
function renderCalendar() {
    calGrid.innerHTML = "";

    const year  = calCurrent.getFullYear();
    const month = calCurrent.getMonth();

    calTitle.textContent = `${year} / ${String(month+1).padStart(2,"0")}`;

    const first = new Date(year, month, 1);
    const last  = new Date(year, month+1, 0);

    const firstWeekDay = first.getDay();
    const daysInMonth  = last.getDate();

    const names = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    names.forEach(n=>{
        const e = document.createElement("div");
        e.className = "day-name";
        e.textContent = n;
        calGrid.appendChild(e);
    });

    for (let i=0;i<firstWeekDay;i++) {
        const blank = document.createElement("div");
        blank.className = "day-cell day-disabled";
        calGrid.appendChild(blank);
    }

    for (let d=1; d<=daysInMonth; d++) {
        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.textContent = d;

        cell.addEventListener("click", ()=>{
            const mm = String(month+1).padStart(2,"0");
            const dd = String(d).padStart(2,"0");
            dateInput.value = `${year}-${mm}-${dd}`;
            closeCalendar();
        });

        calGrid.appendChild(cell);
    }
}

/* ==========================================
   Step 1ï¼šè¼‰å…¥ DB è³‡æ–™
========================================== */
async function loadMetaData() {
    // å°šæœªæ”¶è²¨çš„é è¨ˆé€²æ–™
    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .neq("status", "received")
        .order("planned_date", { ascending: true });

    plans = plan || [];

    // æ§‹ä»¶åº«
    const { data: comp } = await db
        .from("components_library")
        .select("*");

    components = comp || [];

    // today_recordsï¼šç´€éŒ„å·²ç¶“æ”¶è²¨çš„ position
    const { data: today } = await db
        .from("today_records")
        .select("item_id, position");

    usedPositions = {};
    (today || []).forEach(r=>{
        if (!r.item_id || !r.position) return;
        if (!usedPositions[r.item_id]) usedPositions[r.item_id] = new Set();
        usedPositions[r.item_id].add(r.position);
    });
}

/* ==========================================
   Step 2ï¼šæ¸²æŸ“æ¸…å–®ï¼ˆä¸€æ¬¡å…¨éƒ¨ï¼‰
========================================== */
function renderPlanList() {
    planList.innerHTML = "";
    loadMessage.style.display = plans.length ? "none" : "block";

    // ä¾æ—¥æœŸåˆ†çµ„
    let lastDate = null;

    plans.forEach(p=>{
        const dateText = p.planned_date || "";

        if (dateText !== lastDate) {
            const header = document.createElement("div");
            header.className = "section-title";
            header.style.marginTop = "14px";
            header.textContent = dateText || "æœªå¡«æ—¥æœŸ";
            planList.appendChild(header);
            lastDate = dateText;
        }

        const card = document.createElement("div");
        card.className = "plan-card";
        card.id = "card_" + p.id;

        const compList = components.filter(c=> c.item_id === p.item_id);
        const allPositions = Array.from(new Set(
            compList.map(c=> c.position).filter(Boolean)
        ));

        const usedSet = usedPositions[p.item_id] || new Set();
        const availablePositions = allPositions.filter(pos=> !usedSet.has(pos));

        const headerRow = document.createElement("div");
        headerRow.className = "plan-header";

        const title = document.createElement("div");
        title.style.fontSize = "18px";
        title.style.fontWeight = "700";
        title.textContent = p.item_id;

        const dateLabel = document.createElement("div");
        dateLabel.style.color = "#bbb";
        dateLabel.textContent = dateText;

        headerRow.appendChild(title);
        headerRow.appendChild(dateLabel);
        card.appendChild(headerRow);

        // ä½ç½®é¸å–®æˆ–æç¤º
        let selectEl = null;
        if (availablePositions.length > 0) {
            selectEl = document.createElement("select");
            selectEl.className = "position-select";
            selectEl.id = "pos_" + p.id;

            const opt0 = document.createElement("option");
            opt0.value = "";
            opt0.textContent = "é¸æ“‡ä½ç½®";
            selectEl.appendChild(opt0);

            availablePositions.forEach(pos=>{
                const opt = document.createElement("option");
                opt.value = pos;
                opt.textContent = pos;
                selectEl.appendChild(opt);
            });

            card.appendChild(selectEl);
        } else {
            const tip = document.createElement("div");
            tip.style.color = "#aaa";
            tip.style.fontSize = "13px";
            tip.style.marginTop = "10px";
            tip.textContent = "æ­¤æ§‹ä»¶æ‰€æœ‰ä½ç½®çš†å·²æ¨™è¨˜æ”¶è²¨";
            card.appendChild(tip);
        }

        // æŒ‰éˆ•åˆ—
        const btnRow = document.createElement("div");
        btnRow.style.display = "flex";
        btnRow.style.marginTop = "10px";
        btnRow.style.gap = "10px";

        const delBtn = document.createElement("button");
        delBtn.className = "danger-btn";
        delBtn.textContent = "åˆªé™¤";
        delBtn.addEventListener("click", ()=> deletePlan(p.id));

        const recvBtn = document.createElement("button");
        recvBtn.className = "primary-btn";
        recvBtn.textContent = "æ¨™è¨˜å·²æ”¶";
        recvBtn.addEventListener("click", ()=> markReceived(p.id, p.item_id));

        btnRow.appendChild(delBtn);
        btnRow.appendChild(recvBtn);
        card.appendChild(btnRow);

        planList.appendChild(card);
    });
}

/* ==========================================
   Step 3ï¼šé€å‡ºé è¨ˆé€²æ–™
========================================== */
document.getElementById("submitBtn").addEventListener("click", async ()=>{
    const itemId = document.getElementById("itemIdInput").value.trim();
    const date   = dateInput.value.trim();

    if (!itemId) return alert("è«‹è¼¸å…¥æ§‹ä»¶ç·¨è™Ÿ");
    if (!date)   return alert("è«‹é¸æ“‡é è¨ˆåˆ°è²¨æ—¥æœŸ");

    const { error } = await db.from("planned_items").insert({
        item_id: itemId,
        planned_date: date,
        status: "planned"
    });

    if (error) {
        console.error(error);
        alert("æ–°å¢å¤±æ•—ï¼š" + error.message);
        return;
    }

    document.getElementById("itemIdInput").value = "";
    // æ—¥æœŸä¸æ¸…ç©ºï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥

    await loadMetaData();
    renderPlanList();
});

/* ==========================================
   Step 4ï¼šæ¨™è¨˜å·²æ”¶ â†’ today_records + planned_items
========================================== */
async function markReceived(id, itemId) {
    const sel = document.getElementById("pos_" + id);
    if (!sel || !sel.value) {
        alert("è«‹å…ˆé¸æ“‡ä½ç½®");
        return;
    }

    const pos = sel.value;

    if (!confirm(`ç¢ºå®šå°‡ ${itemId}ï¼ˆ${pos}ï¼‰æ¨™è¨˜ç‚ºå·²æ”¶è²¨ï¼Ÿ`)) return;

    const nowIso = new Date().toISOString();

    const { error: e1 } = await db.from("today_records").insert({
        item_id: itemId,
        position: pos,
        status: "received",
        used_at: nowIso
    });

    if (e1) {
        console.error(e1);
        alert("å¯«å…¥ today_records å¤±æ•—ï¼š" + e1.message);
        return;
    }

    const { error: e2 } = await db
        .from("planned_items")
        .update({ status: "received", position: pos })
        .eq("id", id);

    if (e2) {
        console.error(e2);
        alert("æ›´æ–° planned_items å¤±æ•—ï¼š" + e2.message);
        return;
    }

    // å¾ç•«é¢ç§»é™¤
    const card = document.getElementById("card_" + id);
    if (card) card.remove();

    // é‡æ–°è¼‰å…¥ usedPositionsï¼ˆé¿å…ä½ç½®é‚„å‡ºç¾åœ¨å…¶ä»–å¡ï¼‰
    await loadMetaData();
    renderPlanList();

    alert("å·²æ¨™è¨˜ç‚ºå·²æ”¶è²¨");
}

/* ==========================================
   Step 5ï¼šåˆªé™¤é è¨ˆé€²æ–™
========================================== */
async function deletePlan(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é è¨ˆé€²æ–™å—ï¼Ÿ")) return;

    const { error } = await db.from("planned_items").delete().eq("id", id);
    if (error) {
        console.error(error);
        alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
        return;
    }

    const card = document.getElementById("card_" + id);
    if (card) card.remove();

    await loadMetaData();
    renderPlanList();
}

/* ==========================================
   ğŸš€ åˆå§‹åŒ–
========================================== */
(async ()=>{
    loadingSpinner.style.display = "block";
    await loadMetaData();
    loadingSpinner.style.display = "none";
    renderPlanList();
})();
</script>

</body>
</html>
