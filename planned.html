<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>預計進料登記</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
.plan-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
}
.plan-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.position-select {
    width:100%;
    padding:12px;
    border-radius:14px;
    background:#1e2737;
    color:#fff;
    margin-top:10px;
    font-size:15px;
    border:1px solid #2a2f3a;
}

#loadingSpinner { display:none;text-align:center;padding:16px; }
#loadingSpinner svg { width:28px;height:28px;animation: spin 0.9s linear infinite; }

@keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

#loadMessage { display:none;color:#aaa;text-align:center;padding:16px; }

/* ===== 深色小型日曆 ===== */
#calendarOverlay {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 2000;
}

#calendarPanel {
    position:absolute;
    background:#1c2433;
    padding:14px;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.7);
    width:280px;
    color:#fff;
    font-size:14px;
    animation: calFadeIn .18s ease-out;
}

@keyframes calFadeIn {
    from { opacity:0; transform:scale(.95); }
    to   { opacity:1; transform:scale(1); }
}

.calendar-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
}

.cal-nav-btn {
    background:#2f7dff;
    border-radius:999px;
    padding:4px 10px;
    font-size:13px;
}

.calendar-grid {
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
}

.day-name {
    text-align:center;
    color:#9aa0a6;
    font-size:12px;
}

.day-cell {
    text-align:center;
    padding:7px 0;
    border-radius:10px;
    background:#141a28;
    cursor:pointer;
    font-size:13px;
}
.day-cell:hover { background:#2f7dff; }

.day-disabled {
    opacity:.15;
    pointer-events:none;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">預計進料登記</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div class="screen-card">

    <div class="section-title">構件編號</div>
    <input id="itemIdInput" class="input-bar" placeholder="例如 A-001">

    <div class="section-title">預計到貨日期</div>
    <input id="dateInput"
           class="input-bar"
           placeholder="點擊選擇日期"
           readonly
           style="cursor:pointer;background:#1c2433;">

    <div class="section-title">預計數量</div>
    <input id="qtyInput"
           class="input-bar"
           value="1"
           type="number"
           min="1"
           style="background:#1c2433;color:#fff;">

    <button id="submitBtn" class="primary-btn full" style="margin-top:12px;">
        送出
    </button>
</div>

<div class="screen-card">
    <div class="section-title">目前預計進料清單</div>
    <div id="planList"></div>
    <div id="loadingSpinner">
        <svg viewBox="0 0 24 24">
            <path fill="#ccc" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>
    <div id="loadMessage">已載入全部資料</div>
</div>

<!-- 小日曆 -->
<div id="calendarOverlay">
    <div id="calendarPanel">
        <div class="calendar-header">
            <button id="calPrev" class="cal-nav-btn">〈</button>
            <div id="calTitle"></div>
            <button id="calNext" class="cal-nav-btn">〉</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY = "YOUR_KEY";   /* ← 請自行填回 */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let plans = [];
let components = [];

const planList = document.getElementById("planList");

/* ===== 小日曆控制 ===== */
const dateInput = document.getElementById("dateInput");
const calOverlay = document.getElementById("calendarOverlay");
const calPanel = document.getElementById("calendarPanel");
const calGrid = document.getElementById("calendarGrid");
const calTitle = document.getElementById("calTitle");
const calPrev = document.getElementById("calPrev");
const calNext = document.getElementById("calNext");

let calCurrent = new Date();
calCurrent.setDate(1);

/* 打開日曆 */
dateInput.addEventListener("click", ()=>{

    const rect = dateInput.getBoundingClientRect();

    calOverlay.style.display = "block";

    calPanel.style.top  = rect.bottom + window.scrollY + 8 + "px";
    calPanel.style.left = rect.left   + window.scrollX + "px";

    renderCalendar();
});

/* 關閉日曆 */
calOverlay.addEventListener("click", e=>{
    if (e.target === calOverlay) calOverlay.style.display="none";
});

/* 前/後月份 */
calPrev.onclick = ()=>{ calCurrent.setMonth(calCurrent.getMonth()-1); renderCalendar(); };
calNext.onclick = ()=>{ calCurrent.setMonth(calCurrent.getMonth()+1); renderCalendar(); };

/* ===== 小日曆渲染 ===== */
function renderCalendar(){
    calGrid.innerHTML = "";

    const y = calCurrent.getFullYear();
    const m = calCurrent.getMonth();

    calTitle.textContent = `${y} / ${String(m+1).padStart(2,"0")}`;

    const first = new Date(y, m, 1);
    const last  = new Date(y, m+1, 0);

    const weekday = first.getDay();
    const days = last.getDate();

    const names = ["日","一","二","三","四","五","六"];
    names.forEach(n=>{
        const d=document.createElement("div");
        d.className="day-name";
        d.textContent=n;
        calGrid.appendChild(d);
    });

    for(let i=0;i<weekday;i++){
        const blank=document.createElement("div");
        blank.className="day-cell day-disabled";
        calGrid.appendChild(blank);
    }

    for(let d=1;d<=days;d++){
        const cell=document.createElement("div");
        cell.className="day-cell";
        cell.textContent=d;

        cell.onclick = ()=>{
            const mm = String(m+1).padStart(2,"0");
            const dd = String(d).padStart(2,"0");
            dateInput.value = `${y}-${mm}-${dd}`;
            calOverlay.style.display="none";
        };

        calGrid.appendChild(cell);
    }
}

/* ===== Step 1：讀取 DB ===== */
async function loadMeta(){
    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .eq("status","planned")
        .order("planned_date",{ ascending:true });

    plans = plan || [];

    const { data: comp } = await db.from("components_library").select("*");
    components = comp || [];
}

/* ===== Step 2：渲染列表 ===== */
function renderPlanList(){
    planList.innerHTML = "";

    let lastDate=null;

    plans.forEach(p=>{
        if(p.planned_date !== lastDate){
            const hd=document.createElement("div");
            hd.className="section-title";
            hd.style.marginTop="12px";
            hd.textContent = p.planned_date;
            planList.appendChild(hd);
            lastDate=p.planned_date;
        }

        const card=document.createElement("div");
        card.className="plan-card";

        card.innerHTML = `
            <div class="plan-header">
                <div style="font-size:18px;font-weight:700">${p.item_id}</div>
                <div style="color:#bbb">${p.planned_date}</div>
            </div>
            <div style="margin-top:6px;color:#ccc">
                預計：${p.planned_qty}　已收：${p.received_qty}
            </div>
        `;

        /* 已收完 */
        if(p.received_qty >= p.planned_qty){
            const done=document.createElement("div");
            done.style.color="#70d470";
            done.style.marginTop="8px";
            done.textContent="已全數收貨";
            card.appendChild(done);

            planList.appendChild(card);
            return;
        }

        /* 位置選單 */
        const positions = components
            .filter(c=>c.item_id === p.item_id)
            .map(c=>c.position)
            .filter(Boolean);

        const select=document.createElement("select");
        select.className="position-select";

        const opt0=document.createElement("option");
        opt0.value="";
        opt0.textContent="選擇位置";
        select.appendChild(opt0);

        positions.forEach(pos=>{
            const o=document.createElement("option");
            o.value=pos;
            o.textContent=pos;
            select.appendChild(o);
        });

        card.appendChild(select);

        /* 標記已收 */
        const recv=document.createElement("button");
        recv.className="primary-btn";
        recv.style.marginTop="10px";
        recv.textContent="標記已收";
        recv.onclick = ()=> markReceived(p, select);

        card.appendChild(recv);

        planList.appendChild(card);
    });
}

/* ===== Step 3：新增預計進料 ===== */
submitBtn.onclick = async ()=>{
    const id = itemIdInput.value.trim();
    const date = dateInput.value.trim();
    const qty = Number(qtyInput.value||1);

    if(!id) return alert("請輸入構件編號");
    if(!date) return alert("請選擇日期");

    await db.from("planned_items").insert({
        item_id:id,
        planned_date:date,
        planned_qty:qty,
        received_qty:0,
        used_qty:0,
        status:"planned"
    });

    itemIdInput.value="";
    qtyInput.value="1";

    await loadMeta();
    renderPlanList();
};

/* ===== Step 4：標記已收 ===== */
async function markReceived(p, select){

    if(!select.value) return alert("請先選位置");

    const pos = select.value;

    /* 寫入 today_records */
    await db.from("today_records").insert({
        planned_id:p.id,
        item_id:p.item_id,
        position:pos,
        qty:1,
        action:"received",
        used_at:new Date().toISOString()
    });

    /* 更新已收數量 + 狀態改為 received */
    await db
        .from("planned_items")
        .update({
            received_qty: p.received_qty + 1,
            status: "received"
        })
        .eq("id", p.id);

    await loadMeta();
    renderPlanList();
}

/* ===== 初始化 ===== */
(async()=>{
    await loadMeta();
    renderPlanList();
})();
</script>

</body>
</html>
