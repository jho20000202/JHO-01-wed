<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>預計進料登記</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
.plan-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
}
.plan-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.position-select {
    width:100%;
    padding:12px;
    border-radius:14px;
    background:#1e2737;
    color:#fff;
    margin-top:10px;
    font-size:15px;
    border:1px solid #2a2f3a;
}

#loadingSpinner { display:none;text-align:center;padding:16px; }
#loadingSpinner svg { width:28px;height:28px;animation: spin 0.9s linear infinite; }

@keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
}

#loadMessage { display:none;color:#aaa;text-align:center;padding:16px; }
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">預計進料登記</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div class="screen-card">

    <div class="section-title">構件編號</div>
    <input id="itemIdInput" class="input-bar" placeholder="例如 A-001">

    <div class="section-title">預計到貨日期</div>
    <input id="dateInput" class="input-bar" placeholder="點擊選擇日期">

    <div class="section-title">預計數量</div>
    <input id="qtyInput" class="input-bar" value="1" type="number" min="1">

    <button id="submitBtn" class="primary-btn full" style="margin-top:12px;">
        送出
    </button>
</div>

<div class="screen-card">
    <div class="section-title">目前預計進料清單</div>

    <div id="planList"></div>

    <div id="loadingSpinner">
        <svg viewBox="0 0 24 24">
            <path fill="#ccc" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
    </div>

    <div id="loadMessage">已載入全部資料</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* Supabase */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkaWxoaG1wZG1ucmtmZ2tvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjE5MzAsImV4cCI6MjA3OTAzNzkzMH0.BeuRQFIWUmRV32D0a0qyhMwBTvUSO4G-g6yNapIYwE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let plans = [];
let components = [];

const planList = document.getElementById("planList");
const loadingSpinner = document.getElementById("loadingSpinner");
const loadMessage    = document.getElementById("loadMessage");


/* ============================================================
   Step 1：載入資料（預計進料 + 構件庫資料）
============================================================ */
async function loadMeta() {

    const { data: plan } = await db
        .from("planned_items")
        .select("*")
        .order("planned_date",{ ascending:true });

    plans = plan || [];

    const { data: comp } = await db.from("components_library").select("*");
    components = comp || [];
}


/* ============================================================
   Step 2：渲染預計進料列表
============================================================ */
function renderPlanList() {
    planList.innerHTML = "";
    if (!plans.length) {
        loadMessage.style.display="block";
        return;
    }
    loadMessage.style.display="none";

    let lastDate = null;

    plans.forEach(p => {

        /* 標頭日期 */
        if (p.planned_date !== lastDate) {
            const dateHeader = document.createElement("div");
            dateHeader.className = "section-title";
            dateHeader.style.marginTop = "14px";
            dateHeader.textContent = p.planned_date || "未填日期";
            planList.appendChild(dateHeader);
            lastDate = p.planned_date;
        }

        const card = document.createElement("div");
        card.className = "plan-card";
        card.id = "card_" + p.id;

        /* === 卡片 Header === */
        const head = document.createElement("div");
        head.className = "plan-header";

        const title = document.createElement("div");
        title.style.fontSize="18px";
        title.style.fontWeight="700";
        title.textContent = p.item_id;

        const dateLabel = document.createElement("div");
        dateLabel.style.color="#bbb";
        dateLabel.textContent = p.planned_date;

        head.append(title, dateLabel);
        card.appendChild(head);

        /* 預計 / 已收 */
        const qtyInfo = document.createElement("div");
        qtyInfo.style.marginTop="6px";
        qtyInfo.style.color="#ccc";
        qtyInfo.textContent =
            `預計：${p.planned_qty}　已收：${p.received_qty || 0}`;
        card.appendChild(qtyInfo);

        /* 若已收完 → 不需要位置選單 */
        if ((p.received_qty || 0) >= p.planned_qty) {
            const done = document.createElement("div");
            done.style.color="#70d470";
            done.style.marginTop="8px";
            done.textContent="已全數收貨";
            card.appendChild(done);

            planList.appendChild(card);
            return;
        }

        /* 位置選項 */
        const positions = components
            .filter(c => c.item_id === p.item_id)
            .map(c => c.position)
            .filter(Boolean);

        const select = document.createElement("select");
        select.className = "position-select";

        const opt0 = document.createElement("option");
        opt0.value="";
        opt0.textContent="選擇位置";
        select.appendChild(opt0);

        positions.forEach(pos=>{
            const o=document.createElement("option");
            o.value=pos; o.textContent=pos;
            select.appendChild(o);
        });

        card.appendChild(select);

        /* 按鈕列 */
        const btnRow = document.createElement("div");
        btnRow.style.display="flex";
        btnRow.style.marginTop="10px";
        btnRow.style.gap="10px";

        const del = document.createElement("button");
        del.className="danger-btn";
        del.textContent="刪除";
        del.onclick=()=>deletePlan(p.id);

        const recv = document.createElement("button");
        recv.className="primary-btn";
        recv.textContent="標記已收";
        recv.onclick=()=>markReceived(p, select);

        btnRow.append(del, recv);
        card.appendChild(btnRow);

        planList.appendChild(card);
    });
}


/* ============================================================
   Step 3：新增預計進料
============================================================ */
document.getElementById("submitBtn").onclick = async () => {

    const id   = itemIdInput.value.trim();
    const date = dateInput.value.trim();
    const qty  = Number(qtyInput.value || 1);

    if (!id)   return alert("請輸入構件編號");
    if (!date) return alert("請選擇日期");

    const { error } = await db.from("planned_items").insert({
        item_id: id,
        planned_date: date,
        planned_qty: qty,
        received_qty: 0,
        used_qty: 0
    });

    if (error) return alert("新增失敗：" + error.message);

    itemIdInput.value="";
    qtyInput.value="1";

    await loadMeta();
    renderPlanList();
};


/* ============================================================
   Step 4：標記已收（+1）
============================================================ */
async function markReceived(p, select) {

    if (!select.value) return alert("請先選擇位置");

    const pos = select.value;

    /* 1) 寫入 today_records */
    await db.from("today_records").insert({
        planned_id: p.id,
        item_id: p.item_id,
        position: pos,
        qty: 1,
        action: "received",
        used_at: new Date().toISOString()
    });

    /* 2) 更新 planned_items.received_qty */
    await db
        .from("planned_items")
        .update({ received_qty: (p.received_qty || 0) + 1 })
        .eq("id", p.id);

    await loadMeta();
    renderPlanList();
}


/* ============================================================
   Step 5：刪除
============================================================ */
async function deletePlan(id) {
    if (!confirm("確定要刪除？")) return;

    await db.from("planned_items").delete().eq("id", id);

    await loadMeta();
    renderPlanList();
}


/* ============================================================
   初始化
============================================================ */
(async ()=>{
    loadingSpinner.style.display="block";
    await loadMeta();
    loadingSpinner.style.display="none";
    renderPlanList();
})();
</script>

</body>
</html>
