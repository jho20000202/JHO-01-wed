<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>預計進料登記</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">

<style>
.plan-card {
    background:#1c2433;
    padding:16px;
    margin:10px 0;
    border-radius:14px;
    color:#fff;
}
.plan-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.position-select {
    width:100%;
    padding:12px;
    border-radius:14px;
    background:#1e2737;
    color:#fff;
    margin-top:10px;
    font-size:15px;
    border:1px solid #2a2f3a;
}

.primary-btn { background:#2f7dff;padding:10px;border-radius:12px;color:#fff; }
.danger-btn { background:#c0392b;padding:10px;border-radius:12px;color:#fff; }

#loadingSpinner { display:none;text-align:center;padding:16px; }
#loadMessage { display:none;color:#aaa;text-align:center;padding:16px; }

/* ===== 小日曆 ===== */
#calendarOverlay {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 2000;
}
#calendarPanel {
    position:absolute;
    background:#1c2433;
    padding:14px;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.7);
    width:280px;
    color:#fff;
    font-size:14px;
}
.calendar-header { display:flex; justify-content:space-between; margin-bottom:10px; }
.cal-nav-btn { background:#2f7dff; border-radius:999px; padding:4px 10px; }
.calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.day-name { text-align:center; color:#9aa0a6; font-size:12px; }
.day-cell { text-align:center; padding:7px 0; border-radius:10px; background:#141a28; cursor:pointer; }
.day-cell:hover { background:#2f7dff; }
.day-disabled { opacity:.15; pointer-events:none; }
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-title">預計進料登記</div>
    <a href="index.html" class="top-btn">返回主畫面</a>
</div>

<div class="screen-card">
    <div class="section-title">構件編號</div>
    <input id="itemIdInput" class="input-bar" placeholder="例如 A-001">

    <div class="section-title">預計到貨日期</div>
    <input id="dateInput" class="input-bar" placeholder="點擊選擇日期"
           readonly style="cursor:pointer;background:#1c2433;">

    <div class="section-title">預計數量</div>
    <input id="qtyInput" class="input-bar" value="1" type="number" min="1"
           style="background:#1c2433;color:#fff;">

    <button id="submitBtn" class="primary-btn full" style="margin-top:12px;">送出</button>
</div>

<div class="screen-card">
    <div class="section-title">目前預計進料清單</div>
    <div id="planList"></div>
</div>

<div id="calendarOverlay">
    <div id="calendarPanel">
        <div class="calendar-header">
            <button id="calPrev" class="cal-nav-btn">〈</button>
            <div id="calTitle"></div>
            <button id="calNext" class="cal-nav-btn">〉</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://udilhhmpdmnrkfgkowqo.supabase.co";
const SUPABASE_KEY = "YOUR_KEY";   // ← 換成你的 anon key
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let plans = [];
let components = [];

const itemIdInput = document.getElementById("itemIdInput");
const qtyInput = document.getElementById("qtyInput");
const submitBtn = document.getElementById("submitBtn");

/* ===== 小日曆控制 (無改動) ===== */
const dateInput = document.getElementById("dateInput");
const calOverlay = document.getElementById("calendarOverlay");
const calPanel   = document.getElementById("calendarPanel");
const calGrid    = document.getElementById("calendarGrid");
const calTitle   = document.getElementById("calTitle");
const calPrev    = document.getElementById("calPrev");
const calNext    = document.getElementById("calNext");

let calCurrent = new Date();
calCurrent.setDate(1);

dateInput.addEventListener("click", ()=> {
    const rect = dateInput.getBoundingClientRect();
    calOverlay.style.display = "block";
    calPanel.style.top  = rect.bottom + window.scrollY + 8 + "px";
    calPanel.style.left = rect.left   + window.scrollX + "px";
    renderCalendar();
});
calOverlay.addEventListener("click", e=>{
    if (e.target === calOverlay) calOverlay.style.display="none";
});
calPrev.onclick = ()=>{ calCurrent.setMonth(calCurrent.getMonth()-1); renderCalendar(); };
calNext.onclick = ()=>{ calCurrent.setMonth(calCurrent.getMonth()+1); renderCalendar(); };

function renderCalendar(){
    calGrid.innerHTML="";
    const y = calCurrent.getFullYear();
    const m = calCurrent.getMonth();
    calTitle.textContent = `${y} / ${String(m+1).padStart(2,"0")}`;
    const first = new Date(y, m, 1);
    const last  = new Date(y, m+1, 0);

    const weekday = first.getDay();
    const days    = last.getDate();

    ["日","一","二","三","四","五","六"].forEach(n=>{
        const d=document.createElement("div");
        d.className="day-name";
        d.textContent=n;
        calGrid.appendChild(d);
    });

    for(let i=0;i<weekday;i++){
        const blank=document.createElement("div");
        blank.className="day-cell day-disabled";
        calGrid.appendChild(blank);
    }

    for(let d=1;d<=days;d++){
        const cell=document.createElement("div");
        cell.className="day-cell";
        cell.textContent=d;
        cell.onclick = ()=>{
            const mm = String(m+1).padStart(2,"0");
            const dd = String(d).padStart(2,"0");
            dateInput.value = `${y}-${mm}-${dd}`;
            calOverlay.style.display="none";
        };
        calGrid.appendChild(cell);
    }
}

/* ===== Step 1：讀資料 (Supabase 邏輯 - 無改動) ===== */
async function loadMeta(){
    let { data: plan, error: err1 } = await db
        .from("planned_items")
        .select("*")
        .eq("status","planned")
        .order("planned_date",{ ascending:true });

    if(err1) alert("讀取 planned_items 失敗：" + err1.message);
    plans = plan || [];

    let { data: comp, error: err2 } = await db
        .from("components_library")
        .select("*");

    if(err2) alert("讀取 components_library 失敗：" + err2.message);
    components = comp || [];
}

/* ===== Step 2：渲染清單 (收貨確認按鈕有小幅修正) ===== */
function renderPlanList(){
    const list=document.getElementById("planList");
    list.innerHTML="";

    plans.forEach(p=>{
        const card=document.createElement("div");
        card.className="plan-card";

        card.innerHTML = `
            <div class="plan-header">
                <div style="font-size:18px;font-weight:700">${p.item_id}</div>
                <div style="color:#bbb">${p.planned_date}</div>
            </div>
            <div style="margin-top:6px;color:#ccc">
                預計：${p.planned_qty}　已收：${p.received_qty}
            </div>
        `;

        /* 位置選項 */
        const positions = components
            .filter(c=>c.item_id === p.item_id)
            .map(c=>c.position)
            .filter(Boolean);

        const select=document.createElement("select");
        select.className="position-select";

        select.innerHTML = `<option value="">選擇位置</option>`;
        positions.forEach(pos=>{
            const o=document.createElement("option");
            o.value=pos; o.textContent=pos;
            select.appendChild(o);
        });

        card.appendChild(select);

        /* 按鈕 */
        const btn=document.createElement("button");
        btn.className="primary-btn";
        btn.style.marginTop="10px";
        btn.textContent="確認收貨";

        btn.onclick = async ()=>{
            if(!select.value) return alert("請先選擇位置");
            
            // --- 執行 Supabase 寫入邏輯 ---

            /* Step A：新增 today_records */
            const { error:e1 } = await db
                .from("today_records")
                .insert({
                    planned_id:p.id,
                    item_id:p.item_id,
                    position:select.value,
                    qty:1,
                    type:"received",               
                    time:new Date().toISOString()
                });

            if(e1) return alert("寫入 today_records 失敗：" + e1.message);

            /* Step B：更新 planned_items */
            const { error:e2 } = await db
                .from("planned_items")
                .update({
                    received_qty: p.received_qty + 1,
                    // 不改 status，因為原 planned_qty 可能 > 1
                    // status: (p.received_qty + 1 >= p.planned_qty) ? "received" : "planned"
                })
                .eq("id",p.id);

            if(e2) return alert("更新 planned_items 失敗：" + e2.message);
            
            // 修正：收貨成功後，重新載入並渲染清單，確保當前頁面更新
            alert("收貨確認成功！");
            await loadMeta();
            renderPlanList();


            /* Step C：跳轉 confirm.html （帶資訊） - 保持原有邏輯，但放在重新渲染之後 */
            const comp = components.find(c=>c.item_id === p.item_id);

            const url = new URL("confirm.html", location.href);
            url.searchParams.set("pid", p.id);
            url.searchParams.set("item_id", p.item_id);
            url.searchParams.set("position", select.value);
            url.searchParams.set("planned_date", p.planned_date);
            url.searchParams.set("planned_qty", p.planned_qty);
            url.searchParams.set("received_qty", p.received_qty + 1);
            url.searchParams.set("spec", comp?.spec || "");
            url.searchParams.set("material", comp?.material || "");
            url.searchParams.set("weight", comp?.weight || "");

            location.href = url.toString();
        };

        card.appendChild(btn);

        list.appendChild(card);
    });
}

/* ===== Step 3：新增預計進料 【關鍵修正】插入後重新載入並渲染清單 ===== */
submitBtn.onclick = async ()=>{
    const id   = itemIdInput.value.trim();
    const date = dateInput.value.trim();
    const qty  = Number(qtyInput.value||1);

    if(!id) return alert("請輸入構件編號");
    if(!date) return alert("請選擇日期");
    if(qty <= 0) return alert("數量必須大於 0");

    const { error:e } = await db.from("planned_items").insert({
        item_id:id,
        planned_date:date,
        planned_qty:qty,
        received_qty:0,
        used_qty:0,
        status:"planned"
    });

    if(e) return alert("新增失敗：" + e.message);

    itemIdInput.value="";
    qtyInput.value="1";
    
    alert("預計進料已成功新增！");

    // 【修正點】：在資料成功寫入 Supabase 後，
    // 重新載入資料 (loadMeta) 和重新渲染清單 (renderPlanList)
    await loadMeta();
    renderPlanList();
};

/* ===== INIT (無改動) ===== */
(async()=>{
    await loadMeta();
    renderPlanList();
})();
</script>

</body>
</html>
